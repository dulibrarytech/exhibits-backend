let itemsEditVerticalTimelineFormModule=(()=>{window.localStorage.getItem("exhibits_app_path");let g=endpointsModule.get_exhibits_endpoints();var e={};let y={};async function v(){var e=(t,i)=>{if(t){let e;try{e="string"==typeof t?JSON.parse(t):t}catch(e){return void console.error("Failed to parse styles JSON:",e)}var r;e&&"object"==typeof e&&0!==Object.keys(e).length&&(a(e.backgroundColor,i.timeline_bg_color,i.timeline_bg_color_picker),a(e.color,i.timeline_font_color,i.timeline_font_color_picker),t=e.fontSize,(r=i.timeline_font_size)&&(t?(t=String(t).replace(/px$/i,"").trim(),r.value=t):r.value=""),((e,i)=>{if(e&&i&&i.options){let t=String(e).trim();var r,a;Array.from(i.options).some(e=>e.value===t)&&(i.value=t)}})(e.fontFamily,i.timeline_font))}};let a=(e,t,i)=>{e?(e=String(e).trim(),t&&(t.value=e),i&&(i.value=e)):(t&&(t.value=""),i&&(i.value=""))},t=e=>e instanceof Date&&!isNaN(e.getTime());var i,r,n,o,l,d,c,s,u;try{var m,p=await(async()=>{var e,t,i=document.querySelector("#message"),r=(e,t,i)=>{var r,a;e&&(t=["info","success","danger","warning"].includes(t)?t:"danger",(r=document.createElement("div")).className="alert alert-"+t,r.setAttribute("role","alert"),(a=document.createElement("i")).className=(e=>{const t={info:"fa fa-info",success:"fa fa-check",danger:"fa fa-exclamation",warning:"fa fa-exclamation-triangle"};return t[e]||"fa fa-exclamation"})(t),r.appendChild(a),t=document.createTextNode(" "+i),r.appendChild(t),e.textContent="",e.appendChild(r))};try{var a=helperModule.get_parameter_by_name("exhibit_id"),n=helperModule.get_parameter_by_name("item_id"),o=(t=n,(e=a)&&t?255<e.length||255<t.length?{valid:!1,error:"Invalid parameter length"}:{valid:!0}:{valid:!1,error:"Missing required parameters: exhibit_id or timeline_id"});if(!o.valid)return r(i,"danger",o.error),null;var l=authModule.get_user_token();if(!l||!1===l)return r(i,"danger","Authentication required. Redirecting..."),setTimeout(()=>{authModule.redirect_to_auth()},3e3),null;if(!g?.exhibits?.timeline_records?.get?.endpoint)return r(i,"danger","API endpoint configuration missing"),null;var d=g.exhibits.timeline_records.get.endpoint.replace(":exhibit_id",encodeURIComponent(a)).replace(":timeline_id",encodeURIComponent(n)),c=await httpModule.req({method:"GET",url:d,headers:{"Content-Type":"application/json","x-access-token":l},timeout:3e4});if(!c)throw new Error("No response received from server");if(200!==c.status)throw new Error("Server returned status "+c.status);if(c.data?.data)return c.data.data;throw new Error("Invalid response structure")}catch(e){return console.error("Error in get_timeline_record:",e),r(i,"danger",e.user_message||"Unable to load the timeline record. Please try again."),null}})();if(p)return m={created:document.querySelector("#created"),timeline_title:document.querySelector("#timeline-title-input"),timeline_text:document.querySelector("#timeline-text-input"),timeline_bg_color:document.querySelector("#timeline-background-color"),timeline_bg_color_picker:document.querySelector("#timeline-background-color-picker"),timeline_font_color:document.querySelector("#timeline-font-color"),timeline_font_color_picker:document.querySelector("#timeline-font-color-picker"),timeline_font:document.querySelector("#timeline-font"),timeline_font_size:document.querySelector("#timeline-font-size")},l=p,(d=m.created)&&l&&(c=[],l.created_by&&l.created&&(u=new Date(l.created),t(u))&&(u=helperModule.format_date(u),(s=document.createElement("em")).textContent=`Created by ${l.created_by} on `+u,c.push(s)),l.updated_by&&l.updated&&(u=new Date(l.updated),t(u))&&(s=helperModule.format_date(u),(u=document.createElement("em")).textContent=`Last updated by ${l.updated_by} on `+s,c.push(u)),d.textContent="",c.forEach((e,t)=>{0<t&&d.appendChild(document.createTextNode(" | ")),d.appendChild(e)})),n=p.title,(o=m.timeline_title)&&(n=n?helperModule.unescape(n):"",o.value=n),i=p.text,(r=m.timeline_text)&&(i=i?helperModule.unescape(i):"",r.value=i),e(p.styles,m),!1;throw new Error("Failed to load timeline record data")}catch(e){return console.error("Error in display_edit_record:",e),l="Unable to display the timeline record. Please try again.",(s=document.querySelector("#message"))&&((u=document.createElement("div")).className="alert alert-danger",u.setAttribute("role","alert"),(c=document.createElement("i")).className="fa fa-exclamation",u.appendChild(c),c=document.createTextNode(" "+l),u.appendChild(c),s.textContent="",s.appendChild(u)),!1}}return e.update_timeline_record=async function(){if(this._is_updating_timeline)return!1;this._is_updating_timeline=!0;let t=document.querySelector("#message");let e=300;var i=(e,t,i)=>{var r,a;e&&(t=["info","success","danger","warning"].includes(t)?t:"danger",(r=document.createElement("div")).className="alert alert-"+t,r.setAttribute("role","alert"),(a=document.createElement("i")).className=n(t),r.appendChild(a),t=document.createTextNode(" "+i),r.appendChild(t),e.style.opacity="1",e.style.transition="",e.textContent="",e.appendChild(r))};let n=e=>({info:"fa fa-info",success:"fa fa-check",danger:"fa fa-exclamation",warning:"fa fa-exclamation-triangle"})[e]||"fa fa-exclamation";var r,a;let o=()=>{void 0!==y&&y?.setDirty&&y.setDirty(!1);let e=document.querySelector('#item-submit-card button[type="submit"], button[type="submit"]');e&&(e.disabled=!0,setTimeout(()=>{e.disabled=!1},1e3)),window.onbeforeunload=null},l=null;try{window.scrollTo({top:0,behavior:"smooth"});var d=helperModule.get_parameter_by_name("exhibit_id"),c=helperModule.get_parameter_by_name("item_id"),s=(a=c,(r=d)&&a?255<r.length||255<a.length?{valid:!1,error:"Invalid parameter length"}:{valid:!0}:{valid:!1,error:"Missing required parameters: exhibit_id or timeline_id"});if(!s.valid)return i(t,"warning",s.error),!1;i(t,"info","Updating timeline record...");var u=authModule.get_user_token();if(!u||!1===u)return i(t,"danger","Session expired. Please log in again."),l=setTimeout(()=>{authModule.logout()},1e3),!1;var m=itemsCommonVerticalTimelineFormModule.get_common_timeline_form_fields(y);if(!m||!1===m)return i(t,"danger","Unable to get form field values. Please check all required fields."),!1;var p=helperModule.get_user_name();if(p&&(m.updated_by=p),!g?.exhibits?.timeline_records?.put?.endpoint)return i(t,"danger","API endpoint configuration missing"),!1;var _=g.exhibits.timeline_records.put.endpoint.replace(":exhibit_id",encodeURIComponent(d)).replace(":timeline_id",encodeURIComponent(c)),f=await httpModule.req({method:"PUT",url:_,data:m,headers:{"Content-Type":"application/json","x-access-token":u},timeout:3e4});if(f&&201===f.status)return window.scrollTo({top:0,behavior:"smooth"}),i(t,"success","Timeline record updated successfully"),await(async()=>{try{await v(),o()}catch(e){console.error("Error refreshing display:",e)}})(),l=setTimeout(()=>{t&&(t.style.transition=`opacity ${e}ms ease-out`,t.style.opacity="0",setTimeout(()=>{t.textContent="",t.style.opacity="1",t.style.transition=""},e))},3e3),!0;throw new Error("Failed to update timeline record")}catch(e){l&&clearTimeout(l),console.error("Error updating timeline record:",e);var h=e.user_message||e.message||"Unable to update timeline record. Please try again.";return i(t,"danger",h),!1}finally{this._is_updating_timeline=!1}},e.update_timeline_record_=async function(){try{window.scrollTo(0,0);var e=helperModule.get_parameter_by_name("exhibit_id"),t=helperModule.get_parameter_by_name("item_id");if(void 0===e||void 0===t)return!(document.querySelector("#message").innerHTML='<div class="alert alert-warning" role="alert"><i class="fa fa-info"></i> Unable to update timeline record.</div>');document.querySelector("#message").innerHTML='<div class="alert alert-info" role="alert"><i class="fa fa-info"></i> Updating timeline record...</div>';var i=itemsCommonVerticalTimelineFormModule.get_common_timeline_form_fields(y);if(!1===i)return!1;i.updated_by=helperModule.get_user_name();var r=g.exhibits.timeline_records.put.endpoint.replace(":exhibit_id",e).replace(":timeline_id",t),a=authModule.get_user_token(),n=await httpModule.req({method:"PUT",url:r,data:i,headers:{"Content-Type":"application/json","x-access-token":a}});void 0!==n&&201===n.status&&(window.scrollTo(0,0),document.querySelector("#message").innerHTML='<div class="alert alert-success" role="alert"><i class="fa fa-info"></i> Timeline record updated</div>',n.data.data,setTimeout(()=>{window.location.reload()},900))}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e.init=async function(){var e=helperModule.get_parameter_by_name("exhibit_id"),t=helperModule.get_parameter_by_name("item_id");await authModule.check_permissions(["update_item","update_any_item"],"timeline",e,t,"/items/vertical-timeline/details?exhibit_id="+e+"&item_id="+t+"&status=403"),exhibitsModule.set_exhibit_title(e),document.querySelector("#save-timeline-btn").addEventListener("click",itemsEditVerticalTimelineFormModule.update_timeline_record),await v()},e})();