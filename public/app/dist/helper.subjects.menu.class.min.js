class SubjectsMenu{static ELEMENT_IDS={header:"dropdownHeader",list:"dropdownList",virtual_list:"virtualList",arrow:"arrow",selected_text:"selectedText",result_list:"resultList",search_box:"searchBox",search_input:"searchInput",selected_subjects_input:"selected-subjects"};static DEFAULTS={ITEM_HEIGHT:48,BUFFER:50,SEARCH_DEBOUNCE_MS:150};constructor(e={}){if("function"!=typeof e.get_item_subjects)throw new Error("SubjectsMenu requires get_item_subjects function");if("function"!=typeof e.show_error_message)throw new Error("SubjectsMenu requires show_error_message function");this.get_item_subjects=e.get_item_subjects,this.show_error_message=e.show_error_message,this.on_change=e.on_change||null,this.elements=null,this.state=null,this.abort_controller=null,this.search_timeout=null,this.all_items=[],this.initialized=!1,this._handle_search_input=this._handle_search_input.bind(this),this._handle_header_click=this._handle_header_click.bind(this),this._handle_document_click=this._handle_document_click.bind(this),this._handle_scroll=this._handle_scroll.bind(this)}async init(e=[]){try{return(this.destroy(),this.abort_controller=new AbortController,Array.isArray(e)||(console.warn("SubjectsMenu: subjects parameter is not an array, converting"),e=[]),this.all_items=await this.get_item_subjects(),this.all_items&&Array.isArray(this.all_items))?!!this._setup_elements()&&(this._setup_state(e),this._attach_listeners(),this._render_virtual_list(),this._update_selected(),this.initialized=!0):(console.error("SubjectsMenu: Failed to retrieve item subjects"),this.show_error_message("Failed to load subjects."),!1)}catch(e){return console.error("SubjectsMenu: Error in init:",e.message),this.show_error_message("An error occurred: "+e.message),!1}}async update(e=[]){if(!this.initialized)return this.init(e);try{return Array.isArray(e)||(console.warn("SubjectsMenu: subjects parameter is not an array, converting"),e=[]),this.state.selected=new Set(e.filter(e=>e&&e.trim())),this.state.filtered_items=[...this.all_items],this.elements.search_input&&(this.elements.search_input.value=""),this._close_dropdown(),this._render_virtual_list(),this._update_selected(),!0}catch(e){return console.error("SubjectsMenu: Error in update:",e.message),this.show_error_message("An error occurred: "+e.message),!1}}get_selected(){return this.state?Array.from(this.state.selected).filter(e=>e&&e.trim()):[]}clear(){this.state&&(this.state.selected.clear(),this._render_virtual_list(),this._update_selected())}destroy(){this.abort_controller&&(this.abort_controller.abort(),this.abort_controller=null),this.search_timeout&&(clearTimeout(this.search_timeout),this.search_timeout=null),this.state=null,this.elements=null,this.initialized=!1}is_initialized(){return this.initialized}_setup_elements(){this.elements={};for(var[e,t]of Object.entries(SubjectsMenu.ELEMENT_IDS)){var s=document.getElementById(t);if(!s)return console.error(`SubjectsMenu: Required element not found: ${e} (id: ${t})`),this.show_error_message("Missing required UI element: "+e),!1;this.elements[e]=s}return!0}_setup_state(e){this.state={selected:new Set(e.filter(e=>e&&e.trim())),filtered_items:[...this.all_items],item_map:new Map,is_open:!1,ITEM_HEIGHT:SubjectsMenu.DEFAULTS.ITEM_HEIGHT,BUFFER:SubjectsMenu.DEFAULTS.BUFFER}}_attach_listeners(){var e=this.abort_controller.signal;this.elements.search_input.addEventListener("input",this._handle_search_input,{signal:e}),this.elements.header.addEventListener("click",this._handle_header_click,{signal:e}),document.addEventListener("click",this._handle_document_click,{signal:e}),this.elements.list.addEventListener("scroll",this._handle_scroll,{signal:e})}_handle_search_input(e){clearTimeout(this.search_timeout),this.search_timeout=setTimeout(()=>{let t=e.target.value.toLowerCase().trim();this.state.filtered_items=t?this.all_items.filter(e=>e.toLowerCase().startsWith(t)):[...this.all_items],this._render_virtual_list()},SubjectsMenu.DEFAULTS.SEARCH_DEBOUNCE_MS)}_handle_header_click(){this.state.is_open=!this.state.is_open,this.elements.list.classList.toggle("show"),this.elements.header.classList.toggle("active"),this.elements.arrow.classList.toggle("rotate"),this.elements.search_box.classList.toggle("show"),this.state.is_open?(this.elements.search_input.focus(),this._render_virtual_list()):(this.elements.search_input.value="",this.state.filtered_items=[...this.all_items])}_handle_document_click(e){e.target.closest(".dropdown-container")||this._close_dropdown()}_handle_scroll(){this._render_virtual_list()}_close_dropdown(){this.state&&this.elements&&(this.state.is_open=!1,this.elements.list.classList.remove("show"),this.elements.header.classList.remove("active"),this.elements.arrow.classList.remove("rotate"),this.elements.search_box.classList.remove("show"),this.elements.search_input.value="",this.state.filtered_items=[...this.all_items])}_render_virtual_list(){if(this.elements&&this.state){var{virtual_list:t,list:e}=this.elements,{filtered_items:s,selected:i,ITEM_HEIGHT:r,BUFFER:n,item_map:l}=this.state,l=(t.innerHTML="",l.clear(),e.scrollTop||0),a=Math.max(0,Math.floor(l/r)-n),h=Math.min(s.length,Math.ceil((l+e.clientHeight)/r)+n);t.style.height=s.length*r+"px",t.style.position="relative";for(let e=a;e<h;e++){var o=s[e],o=this._create_dropdown_item(o,i.has(o));t.appendChild(o)}}}_create_dropdown_item(t,e){var s=this.state.filtered_items.indexOf(t),i=document.createElement("div");i.className="dropdown-item",i.style.position="absolute",i.style.top=s*this.state.ITEM_HEIGHT+"px",i.style.width="100%";let r=document.createElement("input");r.type="checkbox",r.value=t,r.className="form-check-input",r.checked=e;s=document.createElement("label");return s.className="ms-2",s.style.cursor="pointer",s.style.marginBottom="0",s.textContent=t,s.style.paddingLeft="30px",r.addEventListener("change",e=>{e.target.checked?this.state.selected.add(t):this.state.selected.delete(t),this._update_selected(),this._notify_change()}),s.addEventListener("click",e=>{e.stopPropagation(),r.checked=!r.checked,r.dispatchEvent(new Event("change"))}),i.appendChild(r),i.appendChild(s),this.state.item_map.set(t,r),i}_update_selected(){var e,t,s,i,r,n,l,a;this.elements&&this.state&&({selected_text:e,result_list:t,selected_subjects_input:s}=this.elements,{selected:n,item_map:i,is_open:r}=this.state,n=Array.from(n).filter(e=>e&&e.trim()),this.state.selected=new Set(n),0===(l=n.length)?(e.innerHTML='<span class="placeholder">Select subjects...</span>',t.innerHTML='<li style="color: #999;">None selected</li>',s.value=""):(a=l<=2?n.join(", "):`${n[0]}, ${n[1]}...`,e.innerHTML=a+` <span class="selected-count">${l}</span>`,t.innerHTML=n.sort().map(e=>{var t=document.createElement("div"),e=(t.textContent=e,t.innerHTML);return`<li>
                        <span>${e}</span>
                        <button class="uncheck-btn" title="Remove subject" data-item="${e}" 
                            style="background: none; border: none; cursor: pointer; color: #999; padding: 0 5px; font-size: 18px; line-height: 1;">Ã—</button>
                    </li>`}).join(""),this._attach_remove_buttons(),s.value=n.join("|")))}_attach_remove_buttons(){this.elements.result_list.querySelectorAll(".uncheck-btn").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();e=t.dataset.item,this.state.selected.delete(e),e=this.state.item_map.get(e);e&&(e.checked=!1),this._update_selected(),this.state.is_open&&this._render_virtual_list(),this._notify_change()})})}_notify_change(){"function"==typeof this.on_change&&this.on_change(this.get_selected())}}"undefined"!=typeof module&&module.exports&&(module.exports=SubjectsMenu);