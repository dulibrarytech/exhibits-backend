let exhibitsEditFormModule=(()=>{let h=window.localStorage.getItem("exhibits_app_path"),p=endpointsModule.get_exhibits_endpoints();var e={};async function u(){var t=(e,t="danger",r="fa-exclamation")=>{var o,a=document.querySelector("#message");a?((o=document.createElement("div")).className="alert alert-"+t,o.setAttribute("role","alert"),(t=document.createElement("i")).className="fa "+r,r=document.createTextNode(" "+e),o.appendChild(t),o.appendChild(r),a.innerHTML="",a.appendChild(o)):console.error("Message element not found")};try{if(!p||"object"!=typeof p)return console.error("EXHIBITS_ENDPOINTS is not available"),t("Configuration error: API endpoints not available"),helperModule.redirect_to_auth(),null;var e=helperModule.get_parameter_by_name("exhibit_id");if(!e)return t("Missing required parameter: exhibit_id"),null;var r=authModule.get_user_token();if(!r)return console.error("Authentication token not available"),t("Authentication error: Please log in again","warning","fa-lock"),helperModule.redirect_to_auth(),null;var o=authModule.get_user_profile_data();if(!o||!o.uid)return console.error("User profile not available"),t("User profile error: Please log in again","warning","fa-user"),helperModule.redirect_to_auth(),null;var a=p.exhibits?.exhibit_records?.endpoints?.get?.endpoint;if(!a)throw new Error("Endpoint configuration not found");(async e=>{var t=document.querySelector("#exhibit-title");if(t)try{var r=await exhibitsModule.get_exhibit_title(e);r&&(t.textContent=r)}catch(e){console.error("Error getting exhibit title:",e)}else console.warn("Exhibit title element not found")})(e).catch(e=>{console.error("Failed to set exhibit title:",e)});var n=encodeURIComponent(e),i=a.replace(":exhibit_id",n)+"?"+(e=>{var t,r,o=new URLSearchParams;for([t,r]of Object.entries(e))null!=r&&o.append(t,r);return o.toString()})({type:"edit",uid:o.uid}),l=await Promise.race([httpModule.req({method:"GET",url:i,headers:{"Content-Type":"application/json","x-access-token":r}}),new Promise((e,t)=>setTimeout(()=>t(new Error("Request timeout")),3e4))]);if(!l)throw new Error("No response received from server");if(200!==l.status)throw new Error("Server returned status "+l.status);if(!l.data||!l.data.data)throw new Error("Invalid response structure from server");if(0===l.data.data.length)throw new Error("Exhibit record not found");return l.data.data}catch(e){return console.error("Error getting exhibit record:",e),t(e.message||"An unexpected error occurred while loading the exhibit record"),null}}function c(){var e=(e,t="")=>document.querySelector(e)?.value?.trim()||t,t=e=>{var t,r,o=document.querySelector("#message");o?((t=document.createElement("div")).className="alert alert-danger",t.setAttribute("role","alert"),(r=document.createElement("i")).className="fa fa-exclamation",e=document.createTextNode(" "+e),t.appendChild(r),t.appendChild(e),o.innerHTML="",o.appendChild(t)):console.error("Message element not found")};try{if(!((e,t)=>{if(!e||"object"!=typeof e)return!1;for(var r of t)if("function"!=typeof e[r])return console.error(`Required method '${r}' not found in module`),!1;return!0})(exhibitsCommonFormModule,["get_common_form_fields","get_exhibit_styles"]))throw new Error("exhibitsCommonFormModule is not properly configured");var r=exhibitsCommonFormModule.get_common_form_fields();if(!r||"object"!=typeof r)throw new Error("Failed to retrieve common form fields");var o=exhibitsCommonFormModule.get_exhibit_styles();if(o&&"object"==typeof o)return r.styles=o,r.hero_image_prev=e("#hero-image-prev"),r.thumbnail_prev=e("#thumbnail-image-prev"),r.title&&0!==r.title.length?r:(console.error("Exhibit data validation failed: missing title"),t("Please enter an exhibit title"),!1);throw new Error("Failed to retrieve exhibit styles")}catch(e){return console.error("Error getting exhibit data:",e),t(e.message||"An error occurred while processing exhibit data"),!1}}async function s(){var e={navigation:{backgroundColor:{input:"#nav-background-color",picker:"#nav-background-color-picker"},color:{input:"#nav-font-color",picker:"#nav-font-color-picker"},fontFamily:{select:"#nav-font"},fontSize:{input:"#nav-font-size"}},template:{backgroundColor:{input:"#template-background-color",picker:"#template-background-color-picker"},color:{input:"#template-font-color",picker:"#template-font-color-picker"},fontFamily:{select:"#template-font"},fontSize:{input:"#template-font-size"}},introduction:{backgroundColor:{input:"#introduction-background-color",picker:"#introduction-background-color-picker"},color:{input:"#introduction-font-color",picker:"#introduction-font-color-picker"},fontFamily:{select:"#introduction-font"},fontSize:{input:"#introduction-font-size"}}};let s=(e,t)=>{e=document.querySelector(e);e&&null!=t&&(e.value=t)};var t=(e,t)=>{e=document.querySelector(e);e&&(e.checked=Boolean(t))};let m=(e,t)=>{e=document.querySelector(e);e&&t&&(e.innerHTML="",e.appendChild(t))};var r=(e,t,r,o,a,n,i)=>{var l,d,c,u,t=e[t];t&&(e=h+`/api/v1/exhibits/${e.uuid}/media/`+t,l=t,e=e,u=200,d=document.createElement("p"),(c=document.createElement("img")).alt=l||"",c.src=e,c.height=u,d.appendChild(c),l=d,e=t,(u=document.createElement("span")).style.fontSize="11px",u.textContent=e,c=u,m(r,l),m(o,c),s(a,t),s(n,t),((e,t)=>{e=document.querySelector(e);e&&(e.style.display=t)})(i,"inline"))};var o,a=(e,t,r)=>{t&&t.exhibit&&t.exhibit[e]&&(t=t.exhibit[e],r=r[e],t.backgroundColor&&(s(r.backgroundColor.input,t.backgroundColor),s(r.backgroundColor.picker,t.backgroundColor)),t.color&&(s(r.color.input,t.color),s(r.color.picker,t.color)),t.fontFamily&&((e,t)=>{var r=document.querySelector(e);if(r&&t)for(let e=0;e<r.options.length;e++)if(r.options[e].value===t){r.value=t;break}})(r.fontFamily.select,t.fontFamily),t.fontSize)&&(e=String(t.fontSize).replace("px",""),s(r.fontSize.input,e))};try{var n=await u();if(!n)throw new Error("Failed to retrieve exhibit record");await helperModule.check_if_locked(n,"#exhibit-submit-card"),!(o=n)||1!==o.is_locked||((c=authModule.get_user_profile_data())&&c.uid?(c=parseInt(c.uid,10),o=parseInt(o.locked_by_user,10),isNaN(c)||isNaN(o)?(console.error("Invalid user ID values"),1):c===o):(console.warn("Unable to get user profile data"),1))||await(async t=>{var e=document.querySelectorAll('input:not([type="hidden"]), textarea, select, button[type="submit"], button[type="button"]');let r=0;e.forEach(e=>{t&&"unlock-record"===e.id?console.log("Preserving unlock button for administrator"):e.disabled||e.readOnly||(e.disabled=!0,e.style.cursor="not-allowed",e.style.opacity="0.6",r++)}),document.querySelectorAll(".btn:not([disabled])").forEach(e=>{t&&"unlock-record"===e.id||(e.disabled=!0,e.style.cursor="not-allowed",e.style.opacity="0.6")}),console.log(`Disabled ${r} form elements (record locked by another user)`)})(await(async()=>{try{var e,t=authModule.get_user_profile_data();return t&&t.uid?(e=parseInt(t.uid,10),!isNaN(e)&&"Administrator"===await authModule.get_user_role(e)):!1}catch(e){return console.error("Error checking user role:",e),!1}})()),helperModule.setup_auto_unlock(n),((e,t,r,o)=>{let a=document.querySelector("#created");var n,i;a&&(n=[],e&&t&&(t=new Date(t),t=helperModule.format_date(t),(i=document.createElement("em")).textContent=`Created by ${e} on `+t,n.push(i)),r&&o&&(e=new Date(o),t=helperModule.format_date(e),0<n.length&&n.push(document.createTextNode(" | ")),(i=document.createElement("em")).textContent=`Last updated by ${r} on `+t,n.push(i)),a.innerHTML="",n.forEach(e=>a.appendChild(e)))})(n.created_by,n.created,n.updated_by,n.updated);var i,l=1===n.is_published;if(s("#is-published",l),s("#exhibit-title-input",helperModule.unescape(n.title||"")),s("#exhibit-sub-title-input",helperModule.unescape(n.subtitle||"")),s("#exhibit-description-input",helperModule.unescape(n.description||"")),s("#exhibit-about-the-curators-input",helperModule.unescape(n.about_the_curators||"")),s("#exhibit-owner",n.owner),t("#is-featured",1===n.is_featured),t("#is-student-curated",1===n.is_student_curated),n.alert_text&&(t("#is-content-advisory",!0),s("#exhibit-alert-text-input",helperModule.unescape(n.alert_text))),null!==n.exhibit_subjects&&0<n.exhibit_subjects?.length?(i=n.exhibit_subjects.split("|"),await helperModule.create_subjects_menu(i)):await helperModule.create_subjects_menu(),n.hero_image&&r(n,"hero_image","#hero-image-display","#hero-image-filename-display","#hero-image","#hero-image-prev","#hero-trash"),n.thumbnail&&r(n,"thumbnail","#thumbnail-image-display","#thumbnail-filename-display","#thumbnail-image","#thumbnail-image-prev","#thumbnail-trash"),n.banner_template&&((e,t)=>{var r=document.getElementsByName(e);for(let e=0;e<r.length;e++)if(r[e].value===t){r[e].checked=!0;break}})("banner_template",n.banner_template),n.styles)try{var d=JSON.parse(n.styles);a("navigation",d,e),a("template",d,e),a("introduction",d,e)}catch(e){console.error("Error parsing styles JSON:",e)}return!1}catch(e){console.error("Error displaying edit record:",e);var c=e.message||"An error occurred while loading the exhibit record";return o=c,(l=document.querySelector("#message"))?((t=document.createElement("div")).className="alert alert-danger",t.setAttribute("role","alert"),(i=document.createElement("i")).className="fa fa-exclamation",o=document.createTextNode(" "+o),t.appendChild(i),t.appendChild(o),l.innerHTML="",l.appendChild(t)):console.error("Message element not found"),!1}}async function l(){var t=(e,t="success",r="fa-info")=>{var o,a=document.querySelector("#message");a?((o=document.createElement("div")).className="alert alert-"+t,o.setAttribute("role","alert"),(t=document.createElement("i")).className="fa "+r,r=document.createTextNode(" "+e),o.appendChild(t),o.appendChild(r),a.innerHTML="",a.appendChild(o)):console.error("Message element not found")};let e=e=>{e=document.querySelector(e);e&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName?e.value="":e.innerHTML="")};var r=()=>{e("#hero-image"),e("#hero-image-filename-display"),e("#hero-image-display"),((e,t)=>{e=document.querySelector(e);e&&(e.style.display=t)})("#hero-trash","none")};let o=null;try{if(!p||"object"!=typeof p)throw new Error("API endpoints configuration not available");var a=helperModule.get_parameter_by_name("exhibit_id");if(!a)throw new Error("Missing required parameter: exhibit_id");var n=document.querySelector("#hero-image");if(!n)throw new Error("Hero image input element not found");var i=n.value?.trim();if(!i)return t("No hero image to delete","warning","fa-exclamation"),!1;var l=authModule.get_user_token();if(!l)return t("Authentication error: Please log in again","danger","fa-lock"),!1;var d=p.exhibits?.exhibit_media?.get?.endpoint;if(!d)throw new Error("Endpoint configuration not found");var c=encodeURIComponent(a),u=encodeURIComponent(i),s=d.replace(":exhibit_id",c).replace(":media",u),m=(t("Deleting hero image...","info"),await Promise.race([httpModule.req({method:"DELETE",url:s,headers:{"Content-Type":"application/json","x-access-token":l}}),new Promise((e,t)=>setTimeout(()=>t(new Error("Request timeout")),3e4))]));if(!m)throw new Error("No response received from server");if(204!==m.status)throw new Error("Failed to delete hero image. Server returned status "+m.status);return r(),t("Hero image deleted successfully","success","fa-check"),o=setTimeout(()=>{e("#message")},3e3),!0}catch(e){return o&&clearTimeout(o),console.error("Error deleting hero image:",e),t(e.message||"An unexpected error occurred while deleting the hero image","danger","fa-exclamation"),!1}}async function d(){var t=(e,t="success",r="fa-info")=>{var o,a=document.querySelector("#message");a?((o=document.createElement("div")).className="alert alert-"+t,o.setAttribute("role","alert"),(t=document.createElement("i")).className="fa "+r,r=document.createTextNode(" "+e),o.appendChild(t),o.appendChild(r),a.innerHTML="",a.appendChild(o)):console.error("Message element not found")};let e=e=>{e=document.querySelector(e);e&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName?e.value="":e.innerHTML="")};var r=()=>{e("#thumbnail-image"),e("#thumbnail-filename-display"),e("#thumbnail-image-display"),((e,t)=>{e=document.querySelector(e);e&&(e.style.display=t)})("#thumbnail-trash","none")};let o=null;try{if(!p||"object"!=typeof p)throw new Error("API endpoints configuration not available");var a=helperModule.get_parameter_by_name("exhibit_id");if(!a)throw new Error("Missing required parameter: exhibit_id");var n=document.querySelector("#thumbnail-image");if(!n)throw new Error("Thumbnail image input element not found");var i=n.value?.trim();if(!i)return t("No thumbnail image to delete","warning","fa-exclamation"),!1;var l=authModule.get_user_token();if(!l)return t("Authentication error: Please log in again","danger","fa-lock"),!1;var d=p.exhibits?.exhibit_media?.get?.endpoint;if(!d)throw new Error("Endpoint configuration not found");var c=encodeURIComponent(a),u=encodeURIComponent(i),s=d.replace(":exhibit_id",c).replace(":media",u),m=(t("Deleting thumbnail image...","info"),await Promise.race([httpModule.req({method:"DELETE",url:s,headers:{"Content-Type":"application/json","x-access-token":l}}),new Promise((e,t)=>setTimeout(()=>t(new Error("Request timeout")),3e4))]));if(!m)throw new Error("No response received from server");if(204!==m.status)throw new Error("Failed to delete thumbnail image. Server returned status "+m.status);return r(),t("Thumbnail image deleted successfully","success","fa-check"),o=setTimeout(()=>{e("#message")},3e3),!0}catch(e){return o&&clearTimeout(o),console.error("Error deleting thumbnail image:",e),t(e.message||"An unexpected error occurred while deleting the thumbnail image","danger","fa-exclamation"),!1}}return e.update_exhibit_record=async function(){let a=document.querySelector("#message");var t=(e,t,r="fa-info")=>{var o;a?((o=document.createElement("div")).className="alert alert-"+e,o.setAttribute("role","alert"),(e=document.createElement("i")).className="fa "+r,r=document.createTextNode(" "+t),o.appendChild(e),o.appendChild(r),a.style.opacity="1",a.style.transition="",a.innerHTML="",a.appendChild(o)):console.error("Message element not found")};let r=null;try{window.scrollTo({top:0,left:0,behavior:"instant"});var e=helperModule.get_parameter_by_name("exhibit_id");if(!e)return t("danger","Unable to get record UUID","fa-exclamation"),!1;var o=authModule.get_user_token();if(!o)return t("danger","Unable to get session token","fa-exclamation"),r=setTimeout(()=>{authModule.logout()},1e3),!1;var n=c();if(!n)return t("danger","Unable to get exhibit data","fa-exclamation"),!1;t("info","Updating exhibit record..."),n.updated_by=helperModule.get_user_name();var i=encodeURIComponent(e),l=p.exhibits.exhibit_records.endpoints.put.endpoint.replace(":exhibit_id",i),d=await Promise.race([httpModule.req({method:"PUT",url:l,data:n,headers:{"Content-Type":"application/json","x-access-token":o}}),new Promise((e,t)=>setTimeout(()=>t(new Error("Request timeout")),3e4))]);if(!d||201!==d.status)throw new Error("Failed to update exhibit record");t("success","Exhibit record updated successfully","fa-check");try{await s(),console.log("Form re-rendered with updated data")}catch(e){console.error("Error re-rendering form:",e),t("warning","Record updated, but form refresh failed. Please reload the page.","fa-exclamation")}return r=setTimeout(()=>{a&&(a.style.transition="opacity 300ms ease-out",a.style.opacity="0",setTimeout(()=>{a.innerHTML="",a.style.opacity="1",a.style.transition=""},300))},3e3),!0}catch(e){return r&&clearTimeout(r),console.error("Update exhibit error:",e),t("danger",e.message||"An unexpected error occurred while updating the exhibit","fa-exclamation"),!1}},e.update_exhibit_record__=async function(){let a=document.querySelector("#message");var t=(e,t,r="fa-info")=>{var o;a?((o=document.createElement("div")).className="alert alert-"+e,o.setAttribute("role","alert"),(e=document.createElement("i")).className="fa "+r,r=document.createTextNode(" "+t),o.appendChild(e),o.appendChild(r),a.innerHTML="",a.appendChild(o)):console.error("Message element not found")};let r=null;try{window.scrollTo({top:0,left:0,behavior:"instant"});var e=helperModule.get_parameter_by_name("exhibit_id");if(!e)return t("danger","Unable to get record UUID","fa-exclamation"),!1;var o=authModule.get_user_token();if(!o)return t("danger","Unable to get session token","fa-exclamation"),r=setTimeout(()=>{authModule.logout()},1e3),!1;var n=c();if(!n)return t("danger","Unable to get exhibit data","fa-exclamation"),!1;t("info","Updating exhibit record..."),n.updated_by=helperModule.get_user_name();var i=encodeURIComponent(e),l=p.exhibits.exhibit_records.endpoints.put.endpoint.replace(":exhibit_id",i),d=await Promise.race([httpModule.req({method:"PUT",url:l,data:n,headers:{"Content-Type":"application/json","x-access-token":o}}),new Promise((e,t)=>setTimeout(()=>t(new Error("Request timeout")),3e4))]);if(!d||201!==d.status)throw new Error("Failed to update exhibit record");t("success","Exhibit record updated successfully","fa-check");try{await s(),console.log("Form re-rendered with updated data")}catch(e){console.error("Error re-rendering form:",e),t("warning","Record updated, but form refresh failed. Please reload the page.","fa-exclamation")}return r=setTimeout(()=>{a&&(a.innerHTML="")},3e3),!0}catch(e){return r&&clearTimeout(r),console.error("Update exhibit error:",e),t("danger",e.message||"An unexpected error occurred while updating the exhibit","fa-exclamation"),!1}},e.init=async function(){var t,r,o,a,e=(e,t,r,o)=>{var a=document.querySelector(e),n=document.querySelector(t);a&&n?(a=a.value&&0<a.value.trim().length?r:o,r=n.cloneNode(!0),n.parentNode.replaceChild(r,n),a&&"function"==typeof a&&r.addEventListener("click",a)):console.warn(`Image elements not found: ${e} or `+t)};try{var n=helperModule.get_parameter_by_name("exhibit_id");if(n)return i="/exhibits/exhibit/details?"+new URLSearchParams({exhibit_id:n,status:"403"}).toString(),await authModule.check_permissions(["update_exhibit","update_any_exhibit"],"exhibit",n,null,i),navModule.back_to_exhibits(),t="#save-exhibit-btn",r="click",o=exhibitsEditFormModule?.update_exhibit_record,(a=document.querySelector(t))&&o&&"function"==typeof o?a.addEventListener(r,o):console.warn("Could not attach listener to: "+t),await s(),e("#hero-image","#hero-trash",l,exhibitsCommonFormModule?.delete_hero_image),e("#thumbnail-image","#thumbnail-trash",d,exhibitsCommonFormModule?.delete_thumbnail_image),console.log("Module initialized successfully"),!0;throw new Error("Missing required parameter: exhibit_id")}catch(e){console.error("Error initializing module:",e);var i=e.message||"An error occurred during initialization";return a=i,(r=document.querySelector("#message"))?((o=document.createElement("div")).className="alert alert-danger",o.setAttribute("role","alert"),(t=document.createElement("i")).className="fa fa-exclamation",a=document.createTextNode(" "+a),o.appendChild(t),o.appendChild(a),r.innerHTML="",r.appendChild(o)):console.error("Message element not found"),!1}},e})();