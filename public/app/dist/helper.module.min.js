let helperModule=(()=>{var e={};function m(e){try{var t=document.querySelector("#message");t&&(t.innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e}</div>`)}catch(e){console.error("Error displaying message:",e.message)}}function r(t){try{if(!t||"string"!=typeof t)return"";var r,n,a=["script","iframe","html","head","body","title","img","embed","applet","object","style","link","form","input","video","source","math","maction","picture","map","svg","details","frameset","comment","base","meta","noscript","onclick","onerror","onload","onmouseover","frame","bgsound","marquee"],o=document.createElement("div");try{o.innerHTML=t}catch(e){return console.warn("Failed to parse HTML:",e.message),""}for(r of a)for(n of o.querySelectorAll(r))n.remove();var i,l=["onclick","onerror","onload","onmouseover","onmouseout","onkeydown","onkeyup","onfocus","onblur","onchange","onsubmit","ondblclick","onmouseenter","onmouseleave","oncontextmenu","onwheel","ondrag","ondrop"];for(i of o.querySelectorAll("*")){for(var s of l)i.removeAttribute(s);var c,d,u=["href","title","target","rel","class","id"],m=[];for(c of i.attributes)u.includes(c.name.toLowerCase())||m.push(c.name);for(d of m)i.removeAttribute(d)}let e=o.innerHTML;var p,g,h={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"};for([p,g]of Object.entries(h))e=e.split(p).join(g);return"string"!=typeof(e=e.replace(/\s+/g," ").trim())?(console.warn("Cleaned HTML is not a string"),""):e}catch(e){return console.error("Error in manual_clean_html:",e.message),""}}function p(e,t="danger"){var r=document.querySelector("#message");r&&(r.innerHTML=`<div class="alert alert-${t}" role="alert">${e}</div>`)}return e.get_parameter_by_name=function(t,e){try{if(!t||"string"!=typeof t)return console.warn("Invalid or missing parameter name"),null;var r=e&&"string"==typeof e?e:window.location.href;if(!r||"string"!=typeof r)return console.warn("Invalid URL provided"),null;try{var n,a=new URL(r),o=new URLSearchParams(a.search).get(t);return null===o?null:""===o?"":"string"!=typeof o?(console.warn("Parameter value is not a string: "+t),null):(n=DOMPurify.sanitize(o,{ALLOWED_TAGS:[]}))!==o?(console.warn("Parameter contained potentially malicious content: "+t),null):n}catch(e){console.debug("URLSearchParams failed, using regex fallback:",e.message);var i,l,s,c,d=t,u=r;try{return d&&"string"==typeof d&&u&&"string"==typeof u?(i=d.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),(l=new RegExp(`[?&]${i}(=([^&#]*)|&|#|$)`,"i").exec(u))?l[2]?"string"!=typeof(s=decodeURIComponent(l[2].replace(/\+/g," ")))?(console.warn("Decoded parameter value is not a string: "+d),null):(c=DOMPurify.sanitize(s,{ALLOWED_TAGS:[]}))!==s?(console.warn("Parameter contained potentially malicious content: "+d),null):c:"":null):null}catch(e){return console.error("Error in parse_parameter_regex:",e.message),null}}}catch(e){return console.error("Error in get_parameter_by_name:",e.message),m("An error occurred: "+e.message),null}},e.unescape=function(t){try{if(null==t)return"";if("string"!=typeof t&&(console.warn("Data is not a string, converting from "+typeof t),t=String(t)),""===t||""===t.trim())return"";var r,n,a={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&#x27;":"'","&#x2F;":"/","&apos;":"'"};let e=t;for([r,n]of Object.entries(a))e=e.split(r).join(n);return"string"!=typeof(e=(e=e.replace(/&#(\d+);/g,(e,t)=>{t=parseInt(t,10);return 0<t&&t<=1114111?String.fromCharCode(t):e})).replace(/&#x([0-9a-fA-F]+);/g,(e,t)=>{t=parseInt(t,16);return 0<t&&t<=1114111?String.fromCharCode(t):e}))?(console.warn("Unescaped value is not a string"),""):e}catch(e){return console.error("Error in unescape_safe:",e.message),m("An error occurred: "+e.message),""}},e.strip_html=function(t){try{if(null==t)return"";if("string"!=typeof t&&(console.warn("Input is not a string, converting from "+typeof t),t=String(t)),""===t||""===t.trim())return"";try{return(new DOMParser).parseFromString(t,"text/html").body.textContent||""}catch(e){console.debug("DOMParser failed, using regex fallback:",e.message);var r=t;try{if(!r||"string"!=typeof r)return"";let e=r.replace(/<[^>]*>/g,"");e=(e=e.replace(/\s+/g," ")).trim();var n,a,o={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&#x27;":"'","&#x2F;":"/"};for([n,a]of Object.entries(o))e=e.split(n).join(a);return"string"!=typeof(e=(e=e.replace(/&#(\d+);/g,(e,t)=>{t=parseInt(t,10);return 0<t&&t<=1114111?String.fromCharCode(t):e})).replace(/&#x([0-9a-fA-F]+);/g,(e,t)=>{t=parseInt(t,16);return 0<t&&t<=1114111?String.fromCharCode(t):e}))?(console.warn("Stripped value is not a string"),""):e}catch(e){return console.error("Error in strip_html_regex:",e.message),""}}}catch(e){return console.error("Error in strip_html:",e.message),m("An error occurred: "+e.message),""}},e.clean_html=function(t){try{if(null==t)return"";if("string"!=typeof t&&(console.warn("Input is not a string, converting from "+typeof t),t=String(t)),""===t||""===t.trim())return"";if("undefined"!=typeof DOMPurify)try{var e=DOMPurify.sanitize(t,{ALLOWED_TAGS:["b","i","em","strong","a","p","br","ul","ol","li","blockquote","h1","h2","h3","h4","h5","h6","span","div"],ALLOWED_ATTR:["href","title","target","rel"],KEEP_CONTENT:!0,FORCE_BODY:!1});return"string"!=typeof e?(console.warn("DOMPurify output is not a string"),""):e}catch(e){return console.error("DOMPurify sanitization failed:",e.message),r(t)}return console.debug("DOMPurify not available, using manual HTML cleaning"),r(t)}catch(e){return console.error("Error in clean_html:",e.message),m("An error occurred: "+e.message),""}},e.preview_html=function(e){try{if(helperModule)if(e&&"string"==typeof e){var t=e.replace(/[^a-zA-Z0-9_-]/g,"");if(t!==e)console.warn("Element ID contained invalid characters: "+e),m("Invalid element ID format.");else{var r=document.getElementById(t);if(r)if("string"!=typeof r.value)console.warn("Source element does not have a string value property: "+t),m("Source element has invalid value.");else{var n,a=r.value;if(a&&""!==a.trim()){var o=helperModule.clean_html(a);if(o&&"string"==typeof o){var i=document.getElementById("preview-html");if(i){try{i.innerHTML=o}catch(e){return console.error("Failed to set preview HTML:",e.message),m("Failed to display HTML preview."),!1}try{r.value=o}catch(e){return console.error("Failed to update source element:",e.message),m("Failed to update HTML content."),!1}console.debug("HTML preview successfully generated for element: "+t)}else console.warn("Preview element not found: preview-html"),m("Preview element not found in page.")}else console.error("HTML cleaning failed or returned invalid result"),m("Failed to clean HTML content.")}else console.debug("No HTML content to preview, clearing previous data"),(n=document.getElementById("preview-html"))&&(n.innerHTML=""),r.value=""}else console.warn("Source element not found: "+t),m(`Element with ID "${t}" not found.`)}}else console.warn("Invalid or missing element ID parameter"),m("Invalid element ID provided.");else console.error("helperModule is not available"),m("System configuration error.");return!1}catch(e){return console.error("Error in preview_html:",e.message),m("An error occurred: "+e.message),!1}},e.get_checked_radio_button=function(e){try{var t,r;return e?e.length?"function"!=typeof e[Symbol.iterator]&&"number"!=typeof e.length?(console.warn("radio_buttons is not iterable"),null):(t=Array.from(e).find(e=>e&&"object"==typeof e&&"checked"in e?!0===e.checked:(console.warn("Invalid radio button element in collection"),!1)))?"value"in t?""===(r=String(t.value))||"undefined"===r?(console.warn("Checked radio button has empty or undefined value"),null):r:(console.warn("Checked radio button does not have value property"),null):(console.debug("No radio button is currently checked"),null):(console.warn("radio_buttons is not array-like or is empty"),null):(console.warn("Missing radio_buttons parameter"),null)}catch(e){return console.error("Error in get_checked_radio_button:",e.message),m("An error occurred: "+e.message),null}},e.get_checked_radio_button__=function(t){try{for(let e=0;e<t.length;e++)if(t[e].checked)return t[e].value}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e.get_current_year=function(){try{var e=(new Date).getFullYear();domModule.html("#cdate",DOMPurify.sanitize(e))}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e.format_date=function(e){return(1+e.getMonth()).toString().padStart(2,"0")+`/${e.getDate().toString().padStart(2,"0")}/${e.getFullYear()} @ ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}:`+e.getSeconds().toString().padStart(2,"0")},e.show_form=function(){try{let e=Array.from(document.getElementsByClassName("card"));setTimeout(()=>{e.forEach(e=>{e.style.visibility="visible"})},250)}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e.reorder_items=async function(e,n){try{if(0===n.length)return!1;var t=endpointsModule.get_exhibits_endpoints(),a=helperModule.get_parameter_by_name("exhibit_id"),o=helperModule.get_parameter_by_name("grid_id");let r={};var i=[];for(let e=0,t=n.length;e<t;e++){var l=n[e].node.getAttribute("id").split("_");r.type=l.pop(),r.uuid=l.pop(),r.order=n[e].node.childNodes[0].childNodes[1].innerText,null!==o&&(r.grid_id=o),i.push(r),r={}}var s=authModule.get_user_token(),c=await httpModule.req({method:"POST",url:t.exhibits.reorder_records.post.endpoint.replace(":exhibit_id",a),data:i,headers:{"Content-Type":"application/json","x-access-token":s}});void 0!==c&&201===c.status?console.log("items reordered"):document.querySelector("#message").innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> An HTTP request error occurred while reordering items.</div>'}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e.reorder_grid_items=async function(e,n){try{if(0===n.length)return!1;var t=endpointsModule.get_exhibits_endpoints(),a=helperModule.get_parameter_by_name("exhibit_id"),o=helperModule.get_parameter_by_name("grid_id");let r={};var i=[];for(let e=0,t=n.length;e<t;e++){var l=n[e].node.getAttribute("id").split("_");r.grid_id=o,r.uuid=l[0],r.type="griditem",r.order=n[e].node.childNodes[0].childNodes[1].innerText,i.push(r),r={}}var s=authModule.get_user_token(),c=await httpModule.req({method:"POST",url:t.exhibits.reorder_records.post.endpoint.replace(":exhibit_id",a),data:i,headers:{"Content-Type":"application/json","x-access-token":s}});void 0!==c&&201===c.status?console.log("items reordered"):document.querySelector("#message").innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> An HTTP request error occurred while reordering items.</div>'}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e.check_if_locked=function(e,a){(async()=>{try{var t=authModule.get_user_profile_data();if(1===e.is_locked&&e.locked_by_user!==parseInt(t.uid)){document.querySelector(a).style.display="none";var r=await authModule.get_user_role(parseInt(t.uid)),n=document.querySelector("#message");let e="";null!==n&&("Administrator"===r&&(e=`<br><span><div class="btn-group float-right">
                        <button id="unlock-record" class="btn btn-xs btn-secondary"><i class="fa fa-unlock-alt"></i> Unlock</button>
                        </div></span>`),document.querySelector("#message").innerHTML=`<div class="alert alert-warning" role="alert"><i class="fa fa-lock"></i> This record is currently being worked on by another user.  ${e}</div>`,null!==document.querySelector("#unlock-record"))&&document.querySelector("#unlock-record").addEventListener("click",()=>{helperModule.unlock_record()})}}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}})()},e.unlock_record=async function(){try{var a=endpointsModule.get_exhibits_endpoints();let t=window.location.pathname,e=helperModule.get_parameter_by_name("exhibit_id");var o=[{paths:["exhibits/exhibit/edit"],endpoint_key:"exhibits.exhibit_unlock_record.post.endpoint",params:{exhibit_id:e}},{paths:["items/heading/edit"],endpoint_key:"exhibits.heading_unlock_record.post.endpoint",params:()=>({exhibit_id:e,heading_id:helperModule.get_parameter_by_name("item_id")})},{paths:["items/standard/text/edit","items/standard/media/edit"],endpoint_key:"exhibits.item_unlock_record.post.endpoint",params:()=>({exhibit_id:e,item_id:helperModule.get_parameter_by_name("item_id")})},{paths:["items/grid/item/media/edit","items/grid/item/text/edit"],endpoint_key:"exhibits.grid_item_unlock_record.post.endpoint",params:()=>({exhibit_id:e,grid_id:helperModule.get_parameter_by_name("grid_id"),item_id:helperModule.get_parameter_by_name("item_id")})},{paths:["items/vertical-timeline/item/media/edit","items/vertical-timeline/item/text/edit"],endpoint_key:"exhibits.timeline_item_unlock_record.post.endpoint",params:()=>({exhibit_id:e,timeline_id:helperModule.get_parameter_by_name("timeline_id"),item_id:helperModule.get_parameter_by_name("item_id")})}];let r=null,n={};for(let e of o)if(e.paths.some(e=>t.includes(e))){r=(m=a,e.endpoint_key.split(".").reduce((e,t)=>e?.[t],m)),n="function"==typeof e.params?e.params():e.params;break}if(r){let e=r;for(var[i,l]of Object.entries(n))e=e.replace(":"+i,l);var s,c,d=authModule.get_user_profile_data(),u=authModule.get_user_token();d?.uid&&u?(s=await httpModule.req({method:"POST",url:e+"?uid="+d.uid,headers:{"Content-Type":"application/json","x-access-token":u}}),(c=document.querySelector("#message"))&&(200===s.status?c.innerHTML='<div class="alert alert-success" role="alert">Unlocked</div>':c.innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> An HTTP request error occurred unlocking record.</div>')):(console.error("Missing authentication data"),p("Authentication error: unable to unlock record.","danger"))}else console.error("No matching endpoint found for current path:",t),p("An error occurred: unable to determine record type.","danger")}catch(e){console.error("Error in unlock_record:",e.message);o=document.querySelector("#message");o&&(o.innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> An error occurred unlocking record.</div>')}var m},e.get_user_name=function(){return authModule.get_user_profile_data().name},e.get_owner=function(){var e=authModule.get_user_profile_data();return parseInt(e.uid)},e.create_subjects_menu=async function(e=[]){try{let r=await this.get_item_subjects(),t=document.getElementById("dropdownHeader"),o=document.getElementById("dropdownList"),i=document.getElementById("virtualList"),n=document.getElementById("arrow"),a=document.getElementById("selectedText"),l=document.getElementById("resultList"),s=document.getElementById("searchBox"),c=document.getElementById("searchInput"),d=new Set(e),u=r,m=new Map,p=!1,g=48,h=50,f;function _(){i.innerHTML="",m.clear();var e=o.scrollTop||0,t=Math.max(0,Math.floor(e/g)-h),r=Math.min(u.length,Math.ceil((e+o.clientHeight)/g)+h);i.style.height=u.length*g+"px",i.style.position="relative";for(let e=t;e<r;e++){let t=u[e];var n=document.createElement("div");n.className="dropdown-item",n.style.position="absolute",n.style.top=e*g+"px",n.style.width="100%";let r=document.createElement("input");r.type="checkbox",r.value=t,r.className="form-check-input",r.checked=d.has(t);var a=document.createElement("label");a.className="ms-2",a.style.cursor="pointer",a.style.marginBottom="0",a.textContent=t,a.style.paddingLeft="30px",r.addEventListener("change",e=>{e.target.checked?d.add(t):d.delete(t),v()}),a.addEventListener("click",e=>{e.stopPropagation(),r.checked=!r.checked,r.dispatchEvent(new Event("change"))}),n.appendChild(r),n.appendChild(a),i.appendChild(n),m.set(t,r)}}function v(){var e,t,r;0===d.size?(a.innerHTML='<span class="placeholder">Select subjects...</span>',l.innerHTML='<li style="color: #999;">None selected</li>'):(e=Array.from(d),t=d.size,r=e.length<=2?e.join(", "):`${e[0]}, ${e[1]}...`,a.innerHTML=r+` <span class="selected-count">${t}</span>`,l.innerHTML=e.sort().map(e=>`<li>
                            <span>${e}</span>
                            <button class="uncheck-btn" title="Remove subject" data-item="${e}" style="background: none; border: none; cursor: pointer; color: #999; padding: 0 5px; font-size: 18px; line-height: 1;">×</button>
                        </li>`).join(""),l.querySelectorAll(".uncheck-btn").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault();e=t.dataset.item,d.delete(e),e=m.get(e);e&&(e.checked=!1),v()})}),document.querySelector("#selected-subjects").value=e.join("|"))}c.addEventListener("input",e=>{clearTimeout(f),f=setTimeout(()=>{let t=e.target.value.toLowerCase();u=t?r.filter(e=>e.toLowerCase().includes(t)):r,_()},150)}),o.addEventListener("scroll",()=>{_()}),t.addEventListener("click",()=>{p=!p,o.classList.toggle("show"),t.classList.toggle("active"),n.classList.toggle("rotate"),s.classList.toggle("show"),p?(c.focus(),_()):(c.value="",u=r)}),document.addEventListener("click",e=>{e.target.closest(".dropdown-container")||(p=!1,o.classList.remove("show"),t.classList.remove("active"),n.classList.remove("rotate"),s.classList.remove("show"),c.value="",u=r)}),_(),v()}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e.get_item_subjects=async function(){try{var e=endpointsModule.get_exhibits_endpoints(),t=authModule.get_user_token(),r=await httpModule.req({method:"GET",url:e.exhibits.item_subjects.endpoint,headers:{"Content-Type":"application/json","x-access-token":t}});if(void 0!==r&&200===r.status)return r.data.data}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e.check_bandwidth=function(r){let n=(new Date).getTime(),a,o=0;!async function e(){var t;200===(await httpModule.req({method:"GET",url:"https://upload.wikimedia.org/wikipedia/commons/9/90/ODJBcard.JPG"})).status&&(t=(new Date).getTime()-n,t=Number(55/(t/1e3)),a=((a||t)+t)/2,++o<10?(n=(new Date).getTime(),await e()):r(a.toFixed(0)))}()},e.check_app_env=function(){var e=window.location.hostname;"localhost"!==e&&"libwebapw01-vlt.du.edu"!==e&&"exhibits.dev"!==e||null!==(e=document.querySelector("#app-message"))&&(e.innerHTML='<div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> <strong>"STOP! Do not use Development Site"</strong>&nbsp;&nbsp;&nbsp;<a class="btn btn-info" href="https://exhibits-backend.library.du.edu/exhibits-dashboard/auth" target="_blank">Go to Live Site </a> </div>')},e.init=function(){},e})();helperModule.init();