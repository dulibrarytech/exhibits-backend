let itemsAddGridFormModule=(()=>{let m=window.localStorage.getItem("exhibits_app_path"),t=endpointsModule.get_exhibits_endpoints(),g={};function _(e){if(t?.exhibits?.grid_records?.post?.endpoint)return t.exhibits.grid_records.post.endpoint.replace(":exhibit_id",encodeURIComponent(e));throw new Error("API endpoint configuration missing")}async function f(e,t,r){if(httpModule?.req)return await httpModule.req({method:"POST",url:e,data:t,headers:{"Content-Type":"application/json","x-access-token":r},timeout:3e4});throw new Error("HTTP module not available")}function h(e,t,r){var i,o;e&&(t=["info","success","danger","warning"].includes(t)?t:"info",(i=document.createElement("div")).className="alert alert-"+t,i.setAttribute("role","alert"),(o=document.createElement("i")).className=n(t),i.appendChild(o),t=document.createTextNode(" "+r),i.appendChild(t),e.textContent="",e.appendChild(i))}function n(e){return{info:"fa fa-info",success:"fa fa-check",danger:"fa fa-exclamation",warning:"fa fa-exclamation-triangle"}[e]||"fa fa-info"}function p(e){var t={NetworkError:"Network connection error. Please check your internet connection.",TimeoutError:"Request timed out. Please try again.",AbortError:"Request was cancelled. Please try again."};if(e.name&&t[e.name])return t[e.name];if(e.response?.status){t=e.response.status;if(401===t||403===t)return"Permission denied. You do not have access to create items in this exhibit.";if(404===t)return"Exhibit not found.";if(422===t)return"Invalid data submitted. Please check your inputs.";if(500<=t)return"Server error. Please try again later."}return"Unable to create grid record. Please try again."}function _(e){if(t?.exhibits?.grid_records?.post?.endpoint)return t.exhibits.grid_records.post.endpoint.replace(":exhibit_id",encodeURIComponent(e));throw new Error("API endpoint configuration missing")}async function f(e,t,r){if(httpModule?.req)return await httpModule.req({method:"POST",url:e,data:t,headers:{"Content-Type":"application/json","x-access-token":r}});throw new Error("HTTP module not available")}function h(e,t,r){var i,o;e&&(t=["info","success","danger","warning"].includes(t)?t:"info",(i=document.createElement("div")).className="alert alert-"+t,i.setAttribute("role","alert"),(o=document.createElement("i")).className=n(t),i.appendChild(o),t=document.createTextNode(" "+r),i.appendChild(t),e.textContent="",e.appendChild(i))}function n(e){return{info:"fa fa-info",success:"fa fa-check",danger:"fa fa-exclamation",warning:"fa fa-exclamation-triangle"}[e]||"fa fa-info"}function p(e){var t={NetworkError:"Network connection error. Please check your internet connection.",TimeoutError:"Request timed out. Please try again.",AbortError:"Request was cancelled. Please try again."};if(e.name&&t[e.name])return t[e.name];if(e.response?.status){t=e.response.status;if(401===t||403===t)return"Permission denied. You do not have access to create items in this exhibit.";if(404===t)return"Exhibit not found.";if(422===t)return"Invalid data submitted. Please check your inputs.";if(500<=t)return"Server error. Please try again later."}return"Unable to create grid record. Please try again."}return g.create_grid_record=async function(){var e=helperModule.get_parameter_by_name("item_id");if(e)return console.log("ðŸ”´ Item ID exists - already in edit mode, preventing duplicate creation"),console.log("Current URL:",window.location.href),console.log("item_id:",e),g.update_grid_record&&"function"==typeof g.update_grid_record?(console.log("Redirecting to update function..."),g.update_grid_record()):(e=document.querySelector("#message"),h(e,"warning","Already in edit mode. Update function not available."),console.error("ERROR: update_grid_record function not found!"),!1);if(console.log("ðŸŸ¢ CREATE FUNCTION CALLED - No item_id, proceeding with creation"),this._is_creating_grid)return console.log("Already creating, preventing duplicate submission"),!1;this._is_creating_grid=!0;try{var t=document.querySelector("#message");window.scrollTo({top:0,behavior:"smooth"});let i=helperModule.get_parameter_by_name("exhibit_id");if(i){h(t,"info","Creating grid record...");var r=authModule.get_user_token();if(r&&!1!==r){var o=itemsCommonStandardGridFormModule.get_common_grid_form_fields();if(o&&!1!==o){var n=helperModule.get_user_name(),a=helperModule.get_owner(),d=(n&&(o.created_by=n),a&&(o.owner=a),_(i)),s=await f(d,o,r);if(s&&201===s.status){let r=s.data?.data;if(r)return console.log("âœ… Grid record created successfully, ID:",r),h(t,"success","Grid record created successfully. Redirecting to edit page..."),window.scrollTo({top:0,behavior:"smooth"}),setTimeout(()=>{var e=i,t=r;console.log("=== REDIRECTING TO GRID EDIT PAGE ==="),console.log("exhibit_id:",e),console.log("grid_id:",t),e=new URLSearchParams({exhibit_id:e,item_id:t}),t=m+"/items/grid/edit?"+e.toString(),console.log("Redirecting to:",t),console.log("Note: Back button will NOT return to create page"),window.location.replace(t)},1200),!0;throw new Error("Server did not return a valid grid ID")}if(s)throw new Error("Unexpected response from server");h(t,"danger","Permission denied. You do not have access to add items to this exhibit.")}else h(t,"danger","Invalid form data. Please check all required fields.")}else h(t,"danger","Session expired. Please log in again."),setTimeout(()=>{authModule.logout()},1e3)}else h(t,"warning","Missing exhibit ID. Cannot create grid record.");return!1}catch(e){console.error("âŒ Error creating grid record:",e);var i=document.querySelector("#message"),c=p(e);return h(i,"danger",c),!1}finally{this._is_creating_grid=!1}},g.create_grid_record__=async function(){if(this._is_creating_grid)return!1;this._is_creating_grid=!0;try{let t=document.querySelector("#message");window.scrollTo({top:0,behavior:"smooth"});var e=helperModule.get_parameter_by_name("exhibit_id");if(e){h(t,"info","Creating grid record...");var r=authModule.get_user_token();if(r&&!1!==r){var i=itemsCommonStandardGridFormModule.get_common_grid_form_fields();if(i&&!1!==i){var o=helperModule.get_user_name(),n=helperModule.get_owner(),a=(o&&(i.created_by=o),n&&(i.owner=n),_(e)),d=await f(a,i,r);if(d&&201===d.status){var s=d.data?.data;if(!s)throw new Error("Server did not return a valid grid ID");window.scrollTo({top:0,behavior:"smooth"}),h(t,"success","Grid record created successfully");var c=e,l=s;try{((e,t)=>{var r;window.history?.pushState&&(r=new URLSearchParams({exhibit_id:e,item_id:t}),r=m+"/items/grid/edit?"+r.toString(),window.history.pushState({mode:"edit",exhibit_id:e,item_id:t,type:"grid"},"",r))})(c,l),(e=>{document.title&&(document.title=e);var t=document.querySelector("h1, .page-title");t&&(t.textContent=e)})("Edit Grid"),await("function"==typeof display_edit_record?!await display_edit_record():"function"!=typeof display_grid_edit_record||!await display_grid_edit_record()),(()=>{var e=document.querySelector("form#grid-form, form");e&&(e.onsubmit=async function(e){return e.preventDefault(),!(!g.update_grid_record||"function"!=typeof g.update_grid_record)&&g.update_grid_record()},e=e.querySelector('input[name="mode"]'))&&(e.value="edit")})(),(()=>{var e=document.querySelector('button[type="submit"], #submit-button, #grid-submit-button'),t=(e&&((t=e.querySelector(".button-text"))?t.textContent="Update Grid":e.querySelector("i")?e.childNodes.forEach(e=>{e.nodeType===Node.TEXT_NODE&&(e.textContent=" Update Grid")}):e.textContent="Update Grid"),document.querySelectorAll('.edit-only, [data-mode="edit"]'));t.forEach(e=>{e.style.display="",e.classList.remove("hidden")}),(e=document.querySelectorAll('.create-only, [data-mode="create"]')).forEach(e=>{e.style.display="none",e.classList.add("hidden")}),(e=document.querySelector("#created, .metadata-section"))&&(e.style.display="block",e.classList.remove("hidden")),(e=document.querySelector("#grid-items, .grid-items-section"))&&(e.style.display="block",e.classList.remove("hidden"))})()}catch(e){console.error("Error transitioning to grid edit mode:",e),((e,t)=>{e=new URLSearchParams({exhibit_id:e,item_id:t}),t=m+"/items/grid/edit?"+e.toString(),window.location.replace(t)})(c,l)}return await 0,setTimeout(()=>{var e;(e=t)&&(e.style.transition="opacity 0.3s ease-out",e.style.opacity="0",setTimeout(()=>{e.textContent="",e.style.opacity="1"},300))},3e3),!0}if(d)throw new Error("Unexpected response from server");h(t,"danger","Permission denied. You do not have access to add items to this exhibit.")}else h(t,"danger","Invalid form data. Please check all required fields.")}else h(t,"danger","Session expired. Please log in again."),setTimeout(()=>{authModule.logout()},1e3)}else h(t,"warning","Missing exhibit ID. Cannot create grid record.");return!1}catch(e){console.error("Error creating grid record:",e);var t=document.querySelector("#message"),u=p(e);return h(t,"danger",u),!1}finally{this._is_creating_grid=!1}},g.init=async function(){var e=helperModule.get_parameter_by_name("exhibit_id");await authModule.check_permissions(["add_item","add_item_to_any_exhibit"],"grid",e,null,"/items?exhibit_id="+e+"&status=403"),exhibitsModule.set_exhibit_title(e),document.querySelector("#save-item-btn").addEventListener("click",itemsAddGridFormModule.create_grid_record)},g})();