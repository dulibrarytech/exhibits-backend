let itemsGridModule=(()=>{let H=window.localStorage.getItem("exhibits_app_path"),u=endpointsModule.get_exhibits_endpoints();var e={};function m(e){if("string"==typeof e&&0!==e.length)return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}function c(e,t){var i;null!==e&&(t=t,(i=document.createElement("div")).textContent=String(t),t=i.innerHTML,e.innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${t}</div>`)}function m(e){if("string"==typeof e&&0!==e.length)return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}function p(e){null!==e.delete_card&&(e.delete_card.style.display=""),null!==e.message&&(e.message.innerHTML="")}return e.display_grid_items=async function(e){var t=helperModule.get_parameter_by_name("exhibit_id"),i=helperModule.get_parameter_by_name("grid_id"),r=document.querySelector("#grid-items"),a=document.querySelector(".card"),s=(null!==r&&(r.style.visibility="hidden"),null!==a&&(a.style.minHeight="200px"),document.querySelector("#message").innerHTML='<div class="alert alert-info" role="alert"><i class="fa fa-spinner fa-spin"></i> Loading grid items...</div>',await exhibitsModule.set_exhibit_title(t),await(async(e,t)=>{var i=document.querySelector("#message");if(!m(e)||!m(t))return c(i,"Invalid exhibit or grid identifier"),null;try{var r=authModule.get_user_token();if(null===r||0===r.length)c(i,"Authentication required");else{var a=u.exhibits.grid_item_records.get.endpoint.replace(":exhibit_id",encodeURIComponent(e)).replace(":grid_id",encodeURIComponent(t)),s=await httpModule.req({method:"GET",url:a,headers:{"Content-Type":"application/json","x-access-token":r},timeout:3e4});if(null==s)c(i,"No response received from server");else{if(200===s.status)return s.data?.data??[];401===s.status||403===s.status?c(i,"You do not have permission to view these grid items"):c(i,404===s.status?"Grid items not found":"Unexpected server response: "+s.status)}}return null}catch(e){return c(i,e instanceof Error?e.message:"An unexpected error occurred"),null}})(t,i));if(document.querySelector("#message").innerHTML="",!1===s)return document.querySelector("#item-card").innerHTML="",null!==r&&(r.style.visibility="visible"),!1;if(0===s.length)return t=document.querySelector("#item-card"),i=document.querySelector("#exhibit-title"),null!==t&&(t.style.display="none"),null!==i&&null!==i.parentElement&&(i.parentElement.style.display="none"),!(document.querySelector("#message").innerHTML='<div class="alert alert-info" role="alert">Grid is empty.</div>');let l="";var n=[];for(let e=0;e<s.length;e++)n.push(s[e].order),l+=await itemsListDisplayModule.display_grid_items(s[e]);document.querySelector("#grid-item-list").innerHTML=l;new DataTable("#grid-items",{paging:!1,rowReorder:!0}).on("row-reordered",async(e,t)=>{await helperModule.reorder_grid_items(e,t)});t=document.querySelector("#grid-items tbody");null!==t&&t.addEventListener("click",async function(e){var t=e.target.closest(".publish-item, .suppress-item");if(null!==t){e.preventDefault();e=t.getAttribute("id");if(null!==e)if(t.classList.contains("publish-item")){var i=e;try{var r=helperModule.get_parameter_by_name("exhibit_id"),a=helperModule.get_parameter_by_name("grid_id"),s=i,l=endpointsModule.get_exhibits_endpoints().exhibits.grid_item_records.grid_item_publish.post.endpoint.replace(":exhibit_id",r).replace(":grid_id",a).replace(":grid_item_id",s),n=authModule.get_user_token(),d=await httpModule.req({method:"POST",url:l+"?type=grid_item",headers:{"Content-Type":"application/json","x-access-token":n},timeout:1e4,validateStatus:function(e){return 200<=e&&e<600}});if(200===d.status){var o=document.getElementById(i);o.classList.remove("publish-item"),o.classList.add("suppress-item"),o.innerHTML='<span id="suppress" title="published"><i class="fa fa-cloud" style="color: green"></i><br>Published</span>';var u=Array.from(document.querySelectorAll("tr")).map(e=>e.id).filter(e=>e).find(e=>{e=e.split("_");return i===e[0]}).split("_");let e;e="griditem"===u[1]&&"text"===u[2]?H+`/items/grid/item/text/details?exhibit_id=${r}&grid_id=${a}&item_id=`+i:H+`/items/grid/item/media/details?exhibit_id=${r}&grid_id=${a}&item_id=`+i;var m=i+"-item-actions",c=document.getElementById(m),p=`<a href="${e}" title="View details" aria-label="item-details"><i class="fa fa-folder-open pr-1"></i> </a>`;c.innerHTML=`
                    <div class="card-text text-sm-center">
                    ${p}&nbsp;
                    <i title="Can only delete if unpublished" style="color: #d3d3d3" class="fa fa-trash pr-1" aria-label="delete-grid-item"></i>
                    </div>`}else 403===d.status&&(scrollTo(0,0),document.querySelector("#message").innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-danger"></i> You do not have permission to publish this record.</div>',setTimeout(()=>{document.querySelector("#message").innerHTML=""},5e3));return void await(500===d.status&&(scrollTo(0,0),document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${d.data.message}</div>`,setTimeout(()=>{},5e3)),!1)}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}}else if(t.classList.contains("suppress-item")){var _=e;try{var g=helperModule.get_parameter_by_name("exhibit_id"),h=helperModule.get_parameter_by_name("grid_id"),f=_,y=endpointsModule.get_exhibits_endpoints().exhibits.grid_item_records.grid_item_suppress.post.endpoint.replace(":exhibit_id",g).replace(":grid_id",h).replace(":grid_item_id",f),v=authModule.get_user_token(),b=await httpModule.req({method:"POST",url:y+"?type=grid_item",headers:{"Content-Type":"application/json","x-access-token":v}});if(void 0!==b&&200===b.status){var M=document.getElementById(_);M.classList.remove("suppress-item"),M.classList.add("publish-item"),M.innerHTML='<span id="publish" title="suppressed"><i class="fa fa-cloud-upload" style="color: darkred"></i><br>Suppressed</span>';var x,T=Array.from(document.querySelectorAll("tr")).map(e=>e.id).filter(e=>e).find(e=>{e=e.split("_");return _===e[0]}).split("_");let e;e="griditem"===T[1]&&"text"===T[2]?H+`/items/grid/item/text/edit?exhibit_id=${g}&grid_id=${h}&item_id=`+_:H+`/items/grid/item/media/edit?exhibit_id=${g}&grid_id=${h}&item_id=`+_,x=H+`/items/grid/item/delete?exhibit_id=${g}&grid_id=${h}&item_id=`+_;var L=_+"-item-actions",S=document.getElementById(L),q=`<a href="${e}" title="Edit item" aria-label="edit-item"><i class="fa fa-edit pr-1"></i> </a>`,w=`<a href="${x}" title="Delete item" aria-label="delete-item"><i class="fa fa-trash pr-1"></i></a>`;S.innerHTML=`
                    <div class="card-text text-sm-center">
                    ${""}&nbsp;
                    ${q}&nbsp;
                    ${w}
                    </div>`}else void 0===b&&(scrollTo(0,0),document.querySelector("#message").innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-danger"></i> You do not have permission to unpublish this record.</div>',setTimeout(()=>{document.querySelector("#message").innerHTML=""},5e3));return void await(void 0!==b&&204===b.status&&(scrollTo(0,0),document.querySelector("#message").innerHTML='<div class="alert alert-warning" role="alert"><i class="fa fa-warning"></i> Unable to unpublish grid item</div>',setTimeout(()=>{document.querySelector("#message").innerHTML=""},5e3)),!1)}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}}}}),null!==r&&(r.style.visibility="visible"),null!==a&&(a.style.minHeight="")},e.delete_grid_item=async function(){var t={message:document.querySelector("#message"),delete_card:document.querySelector("#delete-card")},r=helperModule.get_parameter_by_name("exhibit_id"),a=helperModule.get_parameter_by_name("grid_id"),i=helperModule.get_parameter_by_name("item_id");if(!m(r)||!m(a)||!m(i))return c(t.message,"Invalid exhibit, grid, or item identifier"),!1;null!==t.delete_card&&(t.delete_card.style.display="none"),null!==t.message&&(t.message.innerHTML='<div class="alert alert-info" role="alert"><i class="fa fa-spinner fa-spin"></i> Deleting grid item...</div>');try{var e=authModule.get_user_token();if(null===e||0===e.length)c(t.message,"Authentication required");else{var s,l=u.exhibits.grid_item_records.delete.endpoint.replace(":exhibit_id",encodeURIComponent(r)).replace(":grid_id",encodeURIComponent(a)).replace(":item_id",encodeURIComponent(i)),n=await httpModule.req({method:"DELETE",url:l+"?type=grid_item",headers:{"Content-Type":"application/json","x-access-token":e},timeout:1e4,validateStatus:function(e){return 200<=e&&e<600}});if(null==n)c(t.message,"No response received from server");else{if(204===n.status){{var d=r;var o=a;let e=encodeURIComponent(d),t=encodeURIComponent(o),i=H+`/items/grid/items?exhibit_id=${e}&grid_id=`+t;setTimeout(()=>{window.location.replace(i)},900)}return!0}403===n.status?c(t.message,"You do not have permission to delete this item."):404===n.status?c(t.message,"Grid item not found."):500===n.status?(s=n.data?.message??"Internal server error",c(t.message,s)):c(t.message,"Unexpected server response: "+n.status)}}return p(t),!1}catch(e){i=e instanceof Error?e.message:"An unexpected error occurred";return c(t.message,i),p(t),!1}},e.delete_grid_item__=async function(){try{document.querySelector("#delete-message").innerHTML="Deleting grid item...",document.querySelector("#delete-card").style.display="none";let e=helperModule.get_parameter_by_name("exhibit_id"),t=helperModule.get_parameter_by_name("grid_id");var i=helperModule.get_parameter_by_name("item_id"),r=u.exhibits.grid_item_records.delete.endpoint.replace(":exhibit_id",e).replace(":grid_id",t).replace(":item_id",i),a=authModule.get_user_token(),s=await httpModule.req({method:"DELETE",url:r+"?type=grid_item",headers:{"Content-Type":"application/json","x-access-token":a}});void 0!==s&&204===s.status?setTimeout(()=>{window.location.replace(`${H}/items/grid/items?exhibit_id=${e}&grid_id=`+t)},900):void 0===s&&(document.querySelector("#message").innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> You do not have permission to delete this item.</div>')}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e.init=async function(){try{var e=helperModule.get_parameter_by_name("status");if(null!==e&&"403"===e){let e=helperModule.get_parameter_by_name("exhibit_id"),t=helperModule.get_parameter_by_name("grid_id");setTimeout(()=>{window.history.replaceState({page:"items"},"","/exhibits-dashboard/items/grid/items?exhibit_id="+e+"&grid_id="+t)},0),setTimeout(()=>{document.querySelector("#message").innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> You do not have permission to add item.</div>'},50)}var t=authModule.get_user_token();await authModule.check_auth(t),navModule.init(),navModule.back_to_items(),navModule.set_preview_link(),navModule.set_grid_item_nav_menu_links(),navModule.set_logout_link(),helperModule.show_form()}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e})();