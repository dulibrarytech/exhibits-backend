let itemsEditStandardItemFormModule=(()=>{let m=window.localStorage.getItem("exhibits_app_path");var e={};async function b(){var e,t;try{let o=await(async()=>{try{var e,t=endpointsModule.get_exhibits_endpoints(),a=helperModule.get_parameter_by_name("exhibit_id"),r=helperModule.get_parameter_by_name("item_id"),i=authModule.get_user_token(),o=authModule.get_user_profile_data(),n=t.exhibits.item_records.get.endpoint.replace(":exhibit_id",a).replace(":item_id",r);return!1===i?(document.querySelector("#message").innerHTML="ERROR: Unable to get API endpoints",setTimeout(()=>{window.location.replace(m+"/exhibits-dashboard/auth")},1e3),!1):void 0!==(e=await httpModule.req({method:"GET",url:n+"?type=edit&uid="+o.uid,headers:{"Content-Type":"application/json","x-access-token":i}}))&&200===e.status?e.data.data:void 0}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}})();if(o){await helperModule.check_if_locked(o,"#item-submit-card"),!(e=o)||1!==e.is_locked||((t=authModule.get_user_profile_data())&&t.uid?(t=parseInt(t.uid,10),e=parseInt(e.locked_by_user,10),isNaN(t)||isNaN(e)?(console.error("Invalid user ID values"),1):t===e):(console.warn("Unable to get user profile data"),1))||await(async t=>{var e=document.querySelectorAll('input:not([type="hidden"]), textarea, select, button[type="submit"], button[type="button"]');let a=0;e.forEach(e=>{t&&"unlock-record"===e.id?console.log("Preserving unlock button for administrator"):e.disabled||e.readOnly||(e.disabled=!0,e.style.cursor="not-allowed",e.style.opacity="0.6",a++)}),document.querySelectorAll(".btn:not([disabled])").forEach(e=>{t&&"unlock-record"===e.id||(e.disabled=!0,e.style.cursor="not-allowed",e.style.opacity="0.6")}),console.log(`Disabled ${a} form elements (record locked by another user)`)})(await(async()=>{try{var e,t=authModule.get_user_profile_data();return t&&t.uid?(e=parseInt(t.uid,10),!isNaN(e)&&"Administrator"===await authModule.get_user_role(e)):!1}catch(e){return console.error("Error checking user role:",e),!1}})()),helperModule.setup_auto_unlock(o);var a=window.location.pathname.includes("media");let i=(e,t)=>{e=document.querySelector(e);e&&(e.value=t)};var r,n=helperModule.format_date(new Date(o.created)),d=helperModule.format_date(new Date(o.updated)),l=[],s=(o.created_by&&l.push(`<em>Created by ${o.created_by} on ${n}</em>`),o.updated_by&&l.push(`<em>Last updated by ${o.updated_by} on ${d}</em>`),document.querySelector("#created")),u=(s&&(s.innerHTML=l.join(" | ")),helperModule.check_if_locked(o,"#exhibit-submit-card"),document.querySelector("#is-published")),c=(u&&(u.value=1===o.is_published),i("#item-title-input",helperModule.unescape(o.title)),i("#item-text-input",helperModule.unescape(o.text)),a&&(await helperMediaModule.display_media_fields_common(o),null!==o.item_subjects&&0<o.item_subjects?.length?(r=o.item_subjects.split("|"),await helperModule.create_subjects_menu(r)):await helperModule.create_subjects_menu()),(e,t)=>{var a;for(a of document.getElementsByName(e))if(a.value===t){((e,t)=>{e=document.querySelector(e);e&&(e.checked=!!t)})("#"+a.id,!0);break}});c("layout",o.layout),c("media_width",String(o.media_width));(()=>{let e={};try{e=JSON.parse(o.styles||"{}")}catch(e){return console.error("Invalid styles JSON:",e.message)}if(0!==Object.keys(e).length){var a,r,t;for([a,r]of Object.entries({backgroundColor:["#item-background-color","#item-background-color-picker"],color:["#item-font-color","#item-font-color-picker"]})){let t=e[a]||"";r.forEach(e=>i(e,t))}e.fontFamily&&i("#item-font",e.fontFamily),e.fontSize?(t=e.fontSize.replace(/px$/,""),i("#item-font-size",t)):i("#item-font-size","")}})()}else console.error("No record returned from get_item_record()");return!1}catch(e){return console.error("Error in display_edit_record:",e.message),document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`,!1}}return e.update_item_record=async function(){if(this._is_updating_item)return!1;this._is_updating_item=!0;let t=document.querySelector("#message");let e=300;var a=(e,t,a)=>{var r,i;e&&(t=["info","success","danger","warning"].includes(t)?t:"danger",(r=document.createElement("div")).className="alert alert-"+t,r.setAttribute("role","alert"),(i=document.createElement("i")).className=o(t),r.appendChild(i),t=document.createTextNode(" "+a),r.appendChild(t),e.style.opacity="1",e.style.transition="",e.textContent="",e.appendChild(r))};let o=e=>({info:"fa fa-info",success:"fa fa-check",danger:"fa fa-exclamation",warning:"fa fa-exclamation-triangle"})[e]||"fa fa-exclamation";var r,i;let n=()=>{"undefined"!=typeof rich_text_data&&rich_text_data?.setDirty&&rich_text_data.setDirty(!1);let e=document.querySelector('#item-submit-card button[type="submit"], button[type="submit"]');e&&(e.disabled=!0,setTimeout(()=>{e.disabled=!1},1e3)),window.onbeforeunload=null},d=null;try{window.scrollTo({top:0,behavior:"smooth"});var l=helperModule.get_parameter_by_name("exhibit_id"),s=helperModule.get_parameter_by_name("item_id"),u=(i=s,(r=l)&&i?255<r.length||255<i.length?{valid:!1,error:"Invalid parameter length"}:{valid:!0}:{valid:!1,error:"Missing required record identifiers"});if(!u.valid)return a(t,"danger",u.error),!1;var c=authModule.get_user_token();if(!c||!1===c)return a(t,"danger","Session expired. Please log in again."),d=setTimeout(()=>{authModule.logout()},1e3),!1;var m=itemsCommonStandardItemFormModule.get_common_standard_item_form_fields();if(!m||!1===m||void 0===m)return!1;var p=helperModule.get_user_name(),_=(p&&(m.updated_by=p),a(t,"info","Updating item record..."),endpointsModule.get_exhibits_endpoints());if(!_?.exhibits?.item_records?.put?.endpoint)return a(t,"danger","API endpoint configuration missing"),!1;var h=_.exhibits.item_records.put.endpoint.replace(":exhibit_id",encodeURIComponent(l)).replace(":item_id",encodeURIComponent(s)),y=await httpModule.req({method:"PUT",url:h,data:m,headers:{"Content-Type":"application/json","x-access-token":c},timeout:3e4});if(y&&201===y.status)return a(t,"success","Item record updated successfully"),await(async()=>{try{await b(),n()}catch(e){console.error("Error refreshing display:",e)}})(),d=setTimeout(()=>{t&&(t.style.transition=`opacity ${e}ms ease-out`,t.style.opacity="0",setTimeout(()=>{t.textContent="",t.style.opacity="1",t.style.transition=""},e))},3e3),!0;throw new Error("Failed to update item record")}catch(e){d&&clearTimeout(d),console.error("Error updating item record:",e);var g=e.user_message||e.message||"Unable to update item record. Please try again.";return a(t,"danger",g),!1}finally{this._is_updating_item=!1}},e.init=async function(){try{var t=helperModule.get_parameter_by_name("exhibit_id"),a=helperModule.get_parameter_by_name("item_id");let e="media";var r="/items/standard/"+(e=window.location.pathname.indexOf("text")?"text":e)+"/details?exhibit_id="+t+"&item_id="+a+"&status=403";await authModule.check_permissions(["update_item","update_any_item"],"item",t,a,r),exhibitsModule.set_exhibit_title(t),await b(),document.querySelector("#update-item-btn").addEventListener("click",itemsEditStandardItemFormModule.update_item_record),-1!==window.location.pathname.indexOf("media")&&helperMediaModule.media_edit_init()}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e})();