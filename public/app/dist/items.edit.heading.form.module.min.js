let itemsEditHeadingFormModule=(()=>{let _=window.localStorage.getItem("exhibits_app_path"),g=endpointsModule.get_exhibits_endpoints();var e={};let l={};async function c(){var e,t,r,a,o,n,i,d,l,c,u,s;try{var p,m=await(async()=>{var t=document.querySelector("#message");try{var r=helperModule.get_parameter_by_name("exhibit_id"),a=helperModule.get_parameter_by_name("item_id");if(!r||!a)throw new Error("Missing required parameters: exhibit_id or item_id");var e=authModule.get_user_token(),o=authModule.get_user_profile_data();if(!e||!1===e)return t&&(t.textContent="Authentication required. Redirecting to login..."),setTimeout(()=>{var e=_+"/login";window.location.replace(e)},1e3),null;if(!o?.uid)throw new Error("Invalid user profile data");var n=g.exhibits.heading_records.get.endpoint.replace(":exhibit_id",encodeURIComponent(r)).replace(":heading_id",encodeURIComponent(a)),i=n+"?"+new URLSearchParams({type:"edit",uid:o.uid}).toString(),d=await httpModule.req({method:"GET",url:i,headers:{"Content-Type":"application/json","x-access-token":e}});if(!d)throw new Error("No response received from server");if(200!==d.status)throw new Error("Server returned status "+d.status);if(d.data?.data)return d.data.data;throw new Error("Invalid response structure")}catch(e){return console.error("Error in get_item_heading_record:",e),t&&((r=document.createElement("div")).className="alert alert-danger",r.setAttribute("role","alert"),(a=document.createElement("i")).className="fa fa-exclamation",r.appendChild(a),n=document.createTextNode(" Unable to load the heading record. Please try again."),r.appendChild(n),t.textContent="",t.appendChild(r)),null}})();if(!m)throw new Error("Failed to load record data");await helperModule.check_if_locked(m,"#exhibit-submit-card"),!(u=m)||1!==u.is_locked||((s=authModule.get_user_profile_data())&&s.uid?(s=parseInt(s.uid,10),u=parseInt(u.locked_by_user,10),isNaN(s)||isNaN(u)?(console.error("Invalid user ID values"),1):s===u):(console.warn("Unable to get user profile data"),1))||(p=await(async()=>{try{var e,t=authModule.get_user_profile_data();return t&&t.uid?(e=parseInt(t.uid,10),!isNaN(e)&&"Administrator"===await authModule.get_user_role(e)):!1}catch(e){return console.error("Error checking user role:",e),!1}})(),await disable_form_fields(p)),helperModule.setup_auto_unlock(m);var h={created:document.querySelector("#created"),heading_text_input:document.querySelector("#item-heading-text-input"),is_published:document.querySelector("#is-published"),background_color:document.querySelector("#heading-background-color"),background_color_picker:document.querySelector("#heading-background-color-picker"),font_color:document.querySelector("#heading-font-color"),font_color_picker:document.querySelector("#heading-font-color-picker"),font_size:document.querySelector("#heading-font-size"),font_family:document.querySelector("#heading-font")};return helperModule.check_if_locked(m,"#item-submit-card"),o=m,(n=h.created)&&o&&(i=[],o.created_by&&o.created&&y(d=new Date(o.created))&&(d=helperModule.format_date(d),(l=document.createElement("em")).textContent=`Created by ${o.created_by} on `+d,i.push(l)),o.updated_by&&o.updated&&y(d=new Date(o.updated))&&(l=helperModule.format_date(d),(c=document.createElement("em")).textContent=`Last updated by ${o.updated_by} on `+l,i.push(c)),n.textContent="",i.forEach((e,t)=>{0<t&&n.appendChild(document.createTextNode(" | ")),n.appendChild(e)})),r=m.text,(a=h.heading_text_input)&&(r=r?helperModule.unescape(r):"",a.value=r),e=m.is_published,(t=h.is_published)&&(t.checked=[1,!0,"1","true"].includes(e)),((t,r)=>{if(t){let e;try{e="string"==typeof t?JSON.parse(t):t}catch(e){return console.error("Failed to parse styles JSON:",e)}e&&"object"==typeof e&&0!==Object.keys(e).length&&(f(e.backgroundColor,r.background_color,r.background_color_picker),f(e.color,r.font_color,r.font_color_picker),((e,t)=>{t&&(e?(e=String(e).replace(/px$/i,"").trim(),t.value=e):t.value="")})(e.fontSize,r.font_size),((e,r)=>{if(e&&r){let t=String(e).trim();Array.from(r.options).some(e=>e.value===t)&&(r.value=t)}})(e.fontFamily,r.font_family))}})(m.styles,h),!1}catch(e){return console.error("Error in display_edit_record:",e),s="Unable to display the record. Please try again.",(u=document.querySelector("#message"))&&((p=document.createElement("div")).className="alert alert-danger",p.setAttribute("role","alert"),(o=document.createElement("i")).className="fa fa-exclamation",p.appendChild(o),o=document.createTextNode(" "+s),p.appendChild(o),u.textContent="",u.appendChild(p)),!1}}function f(e,t,r){e&&((e=String(e).trim())&&t&&(t.value=e),e)&&r&&(r.value=e)}function y(e){return e instanceof Date&&!isNaN(e.getTime())}function u(e,t,r){var a,o;e&&(t=["info","success","danger","warning"].includes(t)?t:"info",(a=document.createElement("div")).className="alert alert-"+t,a.setAttribute("role","alert"),(o=document.createElement("i")).className={info:"fa fa-info",success:"fa fa-check",danger:"fa fa-exclamation",warning:"fa fa-exclamation-triangle"}[t]||"fa fa-info",a.appendChild(o),t=document.createTextNode(" "+r),a.appendChild(t),e.textContent="",e.appendChild(a))}return e.update_item_heading_record=async function(){if(this._is_updating)return!1;this._is_updating=!0;try{let t=document.querySelector("#message");window.scrollTo({top:0,behavior:"smooth"}),u(t,"info","Updating heading record...");var e=helperModule.get_parameter_by_name("exhibit_id"),r=helperModule.get_parameter_by_name("item_id");if(!e||!r)return u(t,"danger","Missing required record identifiers"),!1;var a=authModule.get_user_token();if(!a||!1===a)return u(t,"danger","Session expired. Redirecting to login..."),setTimeout(()=>{authModule.logout()},1e3),!1;var o=itemsCommonHeadingFormModule.get_common_heading_form_fields(l);if(!o||!1===o)return u(t,"danger","Invalid form data. Please check all required fields."),!1;var n=helperModule.get_user_name(),i=(n&&(o.updated_by=n),((e,t)=>{if(g?.exhibits?.heading_records?.put?.endpoint)return g.exhibits.heading_records.put.endpoint.replace(":exhibit_id",encodeURIComponent(e)).replace(":heading_id",encodeURIComponent(t));throw new Error("API endpoint configuration missing")})(e,r)),d=await(async(e,t,r)=>{if(httpModule?.req)return e=await httpModule.req({method:"PUT",url:e,data:t,headers:{"Content-Type":"application/json","x-access-token":r}});throw new Error("HTTP module not available")})(i,o,a);if(d&&201===d.status){u(t,"success","Heading record updated successfully");try{await c(),(()=>{void 0!==l&&l&&l.setDirty&&"function"==typeof l.setDirty&&l.setDirty(!1);let e=document.querySelector('#item-submit-card button[type="submit"]');e&&(e.disabled=!0,setTimeout(()=>{e.disabled=!1},1e3)),window.onbeforeunload=null})()}catch(e){console.error("Error refreshing display:",e)}return await 0,setTimeout(()=>{var e;(e=t)&&(e.style.transition="opacity 0.3s ease-out",e.style.opacity="0",setTimeout(()=>{e.textContent="",e.style.opacity="1"},300))},3e3),!0}throw new Error("Unexpected response from server")}catch(e){return console.error("Error updating heading record:",e),u(document.querySelector("#message"),"danger",(e=>{var t={NetworkError:"Network connection error. Please check your internet connection.",TimeoutError:"Request timed out. Please try again.",AbortError:"Request was cancelled. Please try again."};if(e.name&&t[e.name])return t[e.name];if(e.response?.status){t=e.response.status;if(401===t||403===t)return"Authentication failed. Please log in again.";if(404===t)return"Record not found.";if(422===t)return"Invalid data submitted. Please check your inputs.";if(500<=t)return"Server error. Please try again later."}return"Unable to update heading record. Please try again."})(e)),!1}finally{this._is_updating=!1}},e.init=async function(){try{var e=helperModule.get_parameter_by_name("exhibit_id"),t=helperModule.get_parameter_by_name("item_id"),r="/items/heading/details?exhibit_id="+e+"&item_id="+t+"&status=403";await authModule.check_permissions(["update_item","update_any_item"],"heading",e,t,r),await exhibitsModule.set_exhibit_title(e),document.querySelector("#save-heading-btn").addEventListener("click",await itemsEditHeadingFormModule.update_item_heading_record),await c()}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e})();