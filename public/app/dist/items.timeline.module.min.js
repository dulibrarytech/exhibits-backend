let itemsTimelineModule=(()=>{let s=window.localStorage.getItem("exhibits_app_path"),n=endpointsModule.get_exhibits_endpoints();var e={};async function m(e,t){try{if(!e)throw new Error("Exhibit ID is required");if(!t)throw new Error("Timeline ID is required");if("string"!=typeof e&&"number"!=typeof e)throw new Error("Exhibit ID must be a string or number");if("string"!=typeof t&&"number"!=typeof t)throw new Error("Timeline ID must be a string or number");var i=endpointsModule.get_exhibits_endpoints();if(!i?.exhibits?.timeline_item_records?.get?.endpoint)throw new Error("Timeline item records endpoint not configured");var a=authModule.get_user_token();if(!a||!1===a)return console.error("No authentication token available"),authModule.redirect_to_auth(),null;var l=((e,t,i)=>{let a=String(t),l=String(i),r=e.replace(":exhibit_id",encodeURIComponent(a)).replace(":timeline_id",encodeURIComponent(l));return r})(i.exhibits.timeline_item_records.get.endpoint,e,t),r=await httpModule.req({method:"GET",url:l,headers:{"Content-Type":"application/json","x-access-token":a},timeout:3e4});if(!r)throw new Error("No response received from server");if(200!==r.status)throw new Error("Server returned status "+r.status);if(r.data&&"object"==typeof r.data)return r.data.data?Array.isArray(r.data.data)?(console.log(`Retrieved ${r.data.data.length} timeline items`),r.data.data):(console.error("Response data.data is not an array"),[]):(console.warn("Response data.data is missing or empty"),[]);throw new Error("Invalid response data structure")}catch(e){console.error("Error getting timeline items:",e);i=document.querySelector("#message");return i&&c(i,e.message||"Unable to retrieve timeline items"),null}}function c(e,t){var i,a;e?(e.textContent="",(i=document.createElement("div")).className="alert alert-danger",i.setAttribute("role","alert"),(a=document.createElement("i")).className="fa fa-exclamation",a.setAttribute("aria-hidden","true"),i.appendChild(a),a=document.createTextNode(" "+t),i.appendChild(a),e.appendChild(i)):console.error("Message element not found")}function u(e){if("string"==typeof e&&0!==e.length)return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}async function _(r){try{let a=helperModule.get_parameter_by_name("exhibit_id"),l=helperModule.get_parameter_by_name("timeline_id");var e=r,t=endpointsModule.get_exhibits_endpoints().exhibits.timeline_item_records.timeline_item_publish.post.endpoint.replace(":exhibit_id",a).replace(":timeline_id",l).replace(":timeline_item_id",e),i=authModule.get_user_token(),n=await httpModule.req({method:"POST",url:t+"?type=timeline_item",headers:{"Content-Type":"application/json","x-access-token":i}});return void 0!==n&&200===n.status&&(setTimeout(()=>{let t=document.getElementById(r);document.getElementById(r).classList.remove("publish-item"),document.getElementById(r).classList.add("suppress-item"),document.getElementById(r).replaceWith(t.cloneNode(!0)),document.getElementById(r).innerHTML='<span id="suppress" title="published"><i class="fa fa-cloud" style="color: green"></i><br>Published</span>',document.getElementById(r).addEventListener("click",async e=>{e.preventDefault(),await p(t.getAttribute("id"))},!1)},0),setTimeout(()=>{var e=Array.from(document.querySelectorAll("tr")).map(e=>e.id).filter(e=>e).find(e=>{e=e.split("_");return r===e[0]}).split("_");let t;t="timelineitem"===e[1]&&"text"===e[2]?`${s}/items/vertical-timeline/item/text/details?exhibit_id=${a}&timeline_id=${l}&item_id=`+r:`${s}/items/vertical-timeline/item/media/details?exhibit_id=${a}&timeline_id=${l}&item_id=`+r;var e=document.getElementById(r+"-item-actions"),i=`<a href="${t}" title="View details" aria-label="item-details"><i class="fa fa-folder-open pr-1"></i> </a>`;e.innerHTML=`
                        <div class="card-text text-sm-center">
                        ${i}&nbsp;
                        <i title="Can only delete if unpublished" style="color: #d3d3d3" class="fa fa-trash pr-1" aria-label="delete-timeline-item"></i>
                        </div>`},0)),(void 0!==n&&204===n.status||void 0===n)&&(scrollTo(0,0),document.querySelector("#message").innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> Unable to publish timeline item</div>',setTimeout(()=>{document.querySelector("#message").innerHTML=""},5e3)),!1}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}}async function p(n){try{let l=helperModule.get_parameter_by_name("exhibit_id"),r=helperModule.get_parameter_by_name("timeline_id");var e=n,t=endpointsModule.get_exhibits_endpoints().exhibits.timeline_item_records.timeline_item_suppress.post.endpoint.replace(":exhibit_id",l).replace(":timeline_id",r).replace(":timeline_item_id",e),i=authModule.get_user_token(),a=await httpModule.req({method:"POST",url:t+"?type=timeline_item",headers:{"Content-Type":"application/json","x-access-token":i}});return void 0!==a&&200===a.status?(setTimeout(()=>{let t=document.getElementById(n);document.getElementById(n).classList.remove("suppress-item"),document.getElementById(n).classList.add("publish-item"),document.getElementById(n).replaceWith(t.cloneNode(!0)),document.getElementById(n).innerHTML='<span id="publish" title="suppressed"><i class="fa fa-cloud-upload" style="color: darkred"></i><br>Unpublished</span>',document.getElementById(n).addEventListener("click",async e=>{e.preventDefault(),await _(t.getAttribute("id"))},!1)},0),setTimeout(()=>{var e=Array.from(document.querySelectorAll("tr")).map(e=>e.id).filter(e=>e).find(e=>{e=e.split("_");return n===e[0]}).split("_");let t;t="timelineitem"===e[1]&&"text"===e[2]?`${s}/items/vertical-timeline/item/text/edit?exhibit_id=${l}&timeline_id=${r}&item_id=`+n:`${s}/items/vertical-timeline/item/media/edit?exhibit_id=${l}&timeline_id=${r}&item_id=`+n,e=`${s}/items/timeline/item/delete?exhibit_id=${l}&timeline_id=${r}&item_id=`+n;var i=n+"-item-actions",i=document.getElementById(i),a=`<a href="${t}" title="Edit item" aria-label="edit-item"><i class="fa fa-edit pr-1"></i> </a>`;i.innerHTML=`
                        <div class="card-text text-sm-center">
                        ${""}&nbsp;
                        ${a}&nbsp;
                        ${`<a href="${e}" title="Delete item" aria-label="delete-item"><i class="fa fa-trash pr-1"></i></a>`}
                        </div>`},0)):void 0===a&&(scrollTo(0,0),document.querySelector("#message").innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-danger"></i> You do not have permission to unpublish this record.</div>',setTimeout(()=>{document.querySelector("#message").innerHTML=""},5e3)),void 0!==a&&204===a.status&&(scrollTo(0,0),document.querySelector("#message").innerHTML='<div class="alert alert-warning" role="alert"><i class="fa fa-warning"></i> Unable to unpublish timeline item</div>',setTimeout(()=>{document.querySelector("#message").innerHTML=""},5e3)),!1}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}}return e.display_timeline_items=async function(){var e,t,i,a=helperModule.get_parameter_by_name("exhibit_id"),l=helperModule.get_parameter_by_name("timeline_id"),r={message:document.querySelector("#message"),timeline_items_table:document.querySelector("#timeline-items"),card:document.querySelector("#item-card"),timeline_item_list:document.querySelector("#timeline-item-list"),title_heading:document.querySelector("#exhibit-title")?.parentElement??null};if(null!==r.card&&(r.card.style.visibility="hidden"),null!==r.title_heading&&(r.title_heading.style.visibility="hidden"),!u(a)||!u(l))return c(r.message,"Invalid exhibit or timeline identifier"),!1;if(null===r.message||null===r.timeline_item_list)return console.error("Required DOM elements not found"),!1;null!==(o=r).timeline_items_table&&(o.timeline_items_table.style.visibility="hidden"),null!==o.card&&(o.card.style.minHeight="200px"),null!==o.message&&(o.message.innerHTML='<div class="alert alert-info" role="alert"><i class="fa fa-spinner fa-spin"></i> Loading timeline items...</div>');try{await exhibitsModule.set_exhibit_title(a);var n=await m(a,l);if(null!==(i=r.message)&&(i.innerHTML=""),null===n||!1===n)return null!==(t=r).card&&(t.card.innerHTML=""),null!==t.timeline_items_table&&(t.timeline_items_table.style.visibility="visible"),!1;if(Array.isArray(n)&&0===n.length)return null!==(e=r).card&&(e.card.style.display="none"),null!==e.title_heading&&(e.title_heading.style.display="none"),null!==e.message&&(e.message.innerHTML='<div class="alert alert-info" role="alert">Timeline is empty.</div>'),!1;var s=await Promise.all(n.map(e=>itemsListDisplayModule.display_timeline_items(e)));r.timeline_item_list.innerHTML=s.join(""),new DataTable("#timeline-items",{paging:!1,order:[[1,"asc"]],columnDefs:[{target:1,visible:!1,searchable:!0}]});try{Array.from(document.getElementsByClassName("publish-item")).forEach(t=>{t.addEventListener("click",async e=>{e.preventDefault(),await _(t.getAttribute("id"))})})}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}try{Array.from(document.getElementsByClassName("suppress-item")).forEach(t=>{t.addEventListener("click",async e=>{e.preventDefault(),await p(t.getAttribute("id"))})})}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}var d=r;return null!==d.card&&(d.card.style.visibility="visible",d.card.style.minHeight=""),null!==d.title_heading&&(d.title_heading.style.visibility="visible"),null!==d.timeline_items_table&&(d.timeline_items_table.style.visibility="visible"),!0}catch(e){var o=e instanceof Error?e.message:"Failed to load timeline items";return c(r.message,o),!1}},e.delete_timeline_item=async function(){try{document.querySelector("#delete-message").innerHTML="Deleting timeline item...";let e=helperModule.get_parameter_by_name("exhibit_id"),t=helperModule.get_parameter_by_name("timeline_id");var i=helperModule.get_parameter_by_name("item_id"),a=n.exhibits.timeline_item_records.delete.endpoint.replace(":exhibit_id",e).replace(":timeline_id",t).replace(":item_id",i),l=authModule.get_user_token(),r=await httpModule.req({method:"DELETE",url:a+"?type=timeline_item",headers:{"Content-Type":"application/json","x-access-token":l}});void 0!==r&&204===r.status&&setTimeout(()=>{window.location.replace(`${s}/items/timeline/items?exhibit_id=${e}&timeline_id=`+t)},900)}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e.init=async function(){try{var e=helperModule.get_parameter_by_name("status");if(null!==e&&"403"===e){let e=helperModule.get_parameter_by_name("exhibit_id"),t=helperModule.get_parameter_by_name("timeline_id");setTimeout(()=>{window.history.replaceState({page:"items"},"","/exhibits-dashboard/items/vertical-timeline/items?exhibit_id="+e+"&timeline_id="+t)},0),setTimeout(()=>{document.querySelector("#message").innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> You do not have permission to add item.</div>'},50)}var t=authModule.get_user_token();await authModule.check_auth(t),navModule.init(),navModule.set_preview_link(),navModule.back_to_items(),navModule.set_timeline_item_nav_menu_links(),navModule.set_logout_link(),helperModule.show_form()}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e})();