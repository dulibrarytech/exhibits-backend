let itemsEditTimelineItemFormModule=(()=>{let b=endpointsModule.get_exhibits_endpoints();var e={};async function v(){let e=e=>e instanceof Date&&!isNaN(e.getTime());var t,i,a,r,n,o,d,l,s,u,c,m,_;try{var p,h,g=await(async()=>{var e,t,i,a=document.querySelector("#message"),r=(e,t,i)=>{var a,r;e&&(t=["info","success","danger","warning"].includes(t)?t:"danger",(a=document.createElement("div")).className="alert alert-"+t,a.setAttribute("role","alert"),(r=document.createElement("i")).className=(e=>{const t={info:"fa fa-info",success:"fa fa-check",danger:"fa fa-exclamation",warning:"fa fa-exclamation-triangle"};return t[e]||"fa fa-exclamation"})(t),a.appendChild(r),t=document.createTextNode(" "+i),a.appendChild(t),e.textContent="",e.appendChild(a))};try{var n=helperModule.get_parameter_by_name("exhibit_id"),o=helperModule.get_parameter_by_name("timeline_id"),d=helperModule.get_parameter_by_name("item_id"),l=(t=o,i=d,(e=n)&&t&&i?255<e.length||255<t.length||255<i.length?{valid:!1,error:"Invalid parameter length"}:{valid:!0}:{valid:!1,error:"Missing required parameters: exhibit_id, timeline_id, or item_id"});if(!l.valid)return r(a,"danger",l.error),null;var s=authModule.get_user_token();if(!s||!1===s)return r(a,"danger","Authentication required. Redirecting..."),setTimeout(()=>{authModule.redirect_to_auth()},1e3),null;var u=authModule.get_user_profile_data();if(!u?.uid)return r(a,"danger","Invalid user profile data"),null;if(!b?.exhibits?.timeline_item_record?.get?.endpoint)return r(a,"danger","API endpoint configuration missing"),null;var c=b.exhibits.timeline_item_record.get.endpoint.replace(":exhibit_id",encodeURIComponent(n)).replace(":timeline_id",encodeURIComponent(o)).replace(":item_id",encodeURIComponent(d))+"?"+new URLSearchParams({type:"edit",uid:u.uid}).toString(),m=await httpModule.req({method:"GET",url:c,headers:{"Content-Type":"application/json","x-access-token":s},timeout:3e4});if(!m)throw new Error("No response received from server");if(200!==m.status)throw new Error("Server returned status "+m.status);if(m.data?.data)return m.data.data;throw new Error("Invalid response structure")}catch(e){return console.error("Error in get_timeline_item_record:",e),r(a,"danger",e.user_message||"Unable to load the timeline item record. Please try again."),null}})();if(g&&g.item)return p=g.item,await helperModule.check_if_locked(p,"#item-submit-card"),!(m=p)||1!==m.is_locked||((_=authModule.get_user_profile_data())?.uid?(_=parseInt(_.uid,10),m=parseInt(m.locked_by_user,10),isNaN(_)||isNaN(m)?(console.error("Invalid user ID values"),1):_===m):(console.warn("Unable to get user profile data"),1))||(t=>{var e=document.querySelectorAll('input:not([type="hidden"]), textarea, select, button[type="submit"], button[type="button"]');let i=0;e.forEach(e=>{t&&"unlock-record"===e.id||e.disabled||e.readOnly||(e.disabled=!0,e.style.cursor="not-allowed",e.style.opacity="0.6",i++)}),document.querySelectorAll(".btn:not([disabled])").forEach(e=>{t&&"unlock-record"===e.id||(e.disabled=!0,e.style.cursor="not-allowed",e.style.opacity="0.6")}),console.log(`Disabled ${i} form elements (record locked by another user)`)})(await(async()=>{try{var e,t=authModule.get_user_profile_data();return t?.uid?(e=parseInt(t.uid,10),!isNaN(e)&&"Administrator"===await authModule.get_user_role(e)):!1}catch(e){return console.error("Error checking user role:",e),!1}})()),helperModule.setup_auto_unlock(p),h={created:document.querySelector("#created"),item_title:document.querySelector("#item-title-input"),item_text:document.querySelector("#item-text-input"),item_date:document.querySelector("#item-date-input")},await helperModule.check_if_locked(p,"#item-submit-card"),d=p,(l=h.created)&&d&&(s=[],d.created_by&&d.created&&(c=new Date(d.created),e(c))&&(c=helperModule.format_date(c),(u=document.createElement("em")).textContent=`Created by ${d.created_by} on `+c,s.push(u)),d.updated_by&&d.updated&&(c=new Date(d.updated),e(c))&&(u=helperModule.format_date(c),(c=document.createElement("em")).textContent=`Last updated by ${d.updated_by} on `+u,s.push(c)),l.textContent="",s.forEach((e,t)=>{0<t&&l.appendChild(document.createTextNode(" | ")),l.appendChild(e)})),n=p.title,(o=h.item_title)&&(n=n?helperModule.unescape(n):"",o.value=n),a=p.text,(r=h.item_text)&&(a=a?helperModule.unescape(a):"",r.value=a),t=p.date,(i=h.item_date)&&(t&&0<(t=String(t).split("T")).length&&t[0]?i.value=t[0]:i.value=""),await(async e=>{if(-1!==window.location.pathname.indexOf("media")){if("function"==typeof helperMediaModule?.display_media_fields_common)try{await helperMediaModule.display_media_fields_common(e)}catch(e){console.error("Error displaying media fields:",e)}null!==e.item_subjects&&0<e.item_subjects?.length?(e=e.item_subjects.split("|"),await helperModule.create_subjects_menu(e)):await helperModule.create_subjects_menu()}})(p),!1;throw new Error("Failed to load timeline item record data")}catch(e){return console.error("Error in display_edit_record:",e),g="Unable to display the timeline item record. Please try again.",(_=document.querySelector("#message"))&&((m=document.createElement("div")).className="alert alert-danger",m.setAttribute("role","alert"),(d=document.createElement("i")).className="fa fa-exclamation",m.appendChild(d),d=document.createTextNode(" "+g),m.appendChild(d),_.textContent="",_.appendChild(m)),!1}}return e.update_timeline_item_record=async function(){if(this._is_updating_timeline_item)return!1;this._is_updating_timeline_item=!0;let t=document.querySelector("#message");let e=300;var i=(e,t,i)=>{var a,r;e&&(t=["info","success","danger","warning"].includes(t)?t:"danger",(a=document.createElement("div")).className="alert alert-"+t,a.setAttribute("role","alert"),(r=document.createElement("i")).className=n(t),a.appendChild(r),t=document.createTextNode(" "+i),a.appendChild(t),e.style.opacity="1",e.style.transition="",e.textContent="",e.appendChild(a))};let n=e=>({info:"fa fa-info",success:"fa fa-check",danger:"fa fa-exclamation",warning:"fa fa-exclamation-triangle"})[e]||"fa fa-exclamation";var a,r,o;let d=()=>{"undefined"!=typeof rich_text_data&&rich_text_data?.setDirty&&rich_text_data.setDirty(!1);let e=document.querySelector('#item-submit-card button[type="submit"], button[type="submit"]');e&&(e.disabled=!0,setTimeout(()=>{e.disabled=!1},1e3)),window.onbeforeunload=null},l=null;try{window.scrollTo({top:0,behavior:"smooth"});var s=helperModule.get_parameter_by_name("exhibit_id"),u=helperModule.get_parameter_by_name("timeline_id"),c=helperModule.get_parameter_by_name("item_id"),m=(r=u,o=c,(a=s)&&r&&o?255<a.length||255<r.length||255<o.length?{valid:!1,error:"Invalid parameter length"}:{valid:!0}:{valid:!1,error:"Missing required parameters: exhibit_id, timeline_id, or item_id"});if(!m.valid)return i(t,"warning",m.error),!1;i(t,"info","Updating timeline item record...");var _=authModule.get_user_token();if(!_||!1===_)return i(t,"danger","Session expired. Please log in again."),l=setTimeout(()=>{authModule.logout()},1e3),!1;var p=itemsCommonVerticalTimelineItemFormModule.get_common_timeline_item_form_fields();if(!p||!1===p||void 0===p)return i(t,"danger","Unable to get form field values. Please check all required fields."),!1;var h=helperModule.get_user_name();if(h&&(p.updated_by=h),!b?.exhibits?.timeline_item_records?.put?.endpoint)return i(t,"danger","API endpoint configuration missing"),!1;var g=b.exhibits.timeline_item_records.put.endpoint.replace(":exhibit_id",encodeURIComponent(s)).replace(":timeline_id",encodeURIComponent(u)).replace(":item_id",encodeURIComponent(c)),f=await httpModule.req({method:"PUT",url:g,data:p,headers:{"Content-Type":"application/json","x-access-token":_},timeout:3e4});if(f&&201===f.status)return i(t,"success","Timeline item record updated successfully"),await(async()=>{try{await v(),d()}catch(e){console.error("Error refreshing display:",e)}})(),l=setTimeout(()=>{t&&(t.style.transition=`opacity ${e}ms ease-out`,t.style.opacity="0",setTimeout(()=>{t.textContent="",t.style.opacity="1",t.style.transition=""},e))},3e3),!0;throw new Error("Failed to update timeline item record")}catch(e){l&&clearTimeout(l),console.error("Error updating timeline item record:",e);var y=e.user_message||e.message||"Unable to update timeline item record. Please try again.";return i(t,"danger",y),!1}finally{this._is_updating_timeline_item=!1}},e.init=async function(){try{var e=helperModule.get_parameter_by_name("exhibit_id"),t=helperModule.get_parameter_by_name("item_id"),i="/items?exhibit_id="+e+"&item_id="+t+"&status=403";await authModule.check_permissions(["update_item","update_any_item"],"timeline_item",e,t,i),await exhibitsModule.set_exhibit_title(e),navModule.set_timeline_item_nav_menu_links(),await v(),document.querySelector("#save-item-btn").addEventListener("click",itemsEditTimelineItemFormModule.update_timeline_item_record),-1!==window.location.pathname.indexOf("media")&&helperMediaModule.media_edit_init()}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e})();