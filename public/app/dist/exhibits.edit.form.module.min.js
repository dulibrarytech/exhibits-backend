let exhibitsEditFormModule=(()=>{let h=window.localStorage.getItem("exhibits_app_path"),p=endpointsModule.get_exhibits_endpoints();var e={};async function c(){var t=(e,t="danger",r="fa-exclamation")=>{var o,n=document.querySelector("#message");n?((o=document.createElement("div")).className="alert alert-"+t,o.setAttribute("role","alert"),(t=document.createElement("i")).className="fa "+r,r=document.createTextNode(" "+e),o.appendChild(t),o.appendChild(r),n.innerHTML="",n.appendChild(o)):console.error("Message element not found")};try{if(!p||"object"!=typeof p)return console.error("EXHIBITS_ENDPOINTS is not available"),t("Configuration error: API endpoints not available"),helperModule.redirect_to_auth(),null;var e=helperModule.get_parameter_by_name("exhibit_id");if(!e)return t("Missing required parameter: exhibit_id"),null;var r=authModule.get_user_token();if(!r)return console.error("Authentication token not available"),t("Authentication error: Please log in again","warning","fa-lock"),helperModule.redirect_to_auth(),null;var o=authModule.get_user_profile_data();if(!o||!o.uid)return console.error("User profile not available"),t("User profile error: Please log in again","warning","fa-user"),helperModule.redirect_to_auth(),null;var n=p.exhibits?.exhibit_records?.endpoints?.get?.endpoint;if(!n)throw new Error("Endpoint configuration not found");(async e=>{var t=document.querySelector("#exhibit-title");if(t)try{var r=await exhibitsModule.get_exhibit_title(e);r&&(t.textContent=r)}catch(e){console.error("Error getting exhibit title:",e)}else console.warn("Exhibit title element not found")})(e).catch(e=>{console.error("Failed to set exhibit title:",e)});var a=encodeURIComponent(e),i=n.replace(":exhibit_id",a)+"?"+(e=>{var t,r,o=new URLSearchParams;for([t,r]of Object.entries(e))null!=r&&o.append(t,r);return o.toString()})({type:"edit",uid:o.uid}),l=await Promise.race([httpModule.req({method:"GET",url:i,headers:{"Content-Type":"application/json","x-access-token":r}}),new Promise((e,t)=>setTimeout(()=>t(new Error("Request timeout")),3e4))]);if(!l)throw new Error("No response received from server");if(200!==l.status)throw new Error("Server returned status "+l.status);if(!l.data||!l.data.data||!Array.isArray(l.data.data))throw new Error("Invalid response structure from server");if(0===l.data.data.length)throw new Error("Exhibit record not found");return l.data.data[0]}catch(e){return console.error("Error getting exhibit record:",e),t(e.message||"An unexpected error occurred while loading the exhibit record"),null}}function u(){var e=(e,t="")=>document.querySelector(e)?.value?.trim()||t,t=e=>{var t,r,o=document.querySelector("#message");o?((t=document.createElement("div")).className="alert alert-danger",t.setAttribute("role","alert"),(r=document.createElement("i")).className="fa fa-exclamation",e=document.createTextNode(" "+e),t.appendChild(r),t.appendChild(e),o.innerHTML="",o.appendChild(t)):console.error("Message element not found")};try{if(!((e,t)=>{if(!e||"object"!=typeof e)return!1;for(var r of t)if("function"!=typeof e[r])return console.error(`Required method '${r}' not found in module`),!1;return!0})(exhibitsCommonFormModule,["get_common_form_fields","get_exhibit_styles"]))throw new Error("exhibitsCommonFormModule is not properly configured");var r=exhibitsCommonFormModule.get_common_form_fields();if(!r||"object"!=typeof r)throw new Error("Failed to retrieve common form fields");var o=exhibitsCommonFormModule.get_exhibit_styles();if(o&&"object"==typeof o)return r.styles=o,r.hero_image_prev=e("#hero-image-prev"),r.thumbnail_prev=e("#thumbnail-image-prev"),r.title&&0!==r.title.length?r:(console.error("Exhibit data validation failed: missing title"),t("Please enter an exhibit title"),!1);throw new Error("Failed to retrieve exhibit styles")}catch(e){return console.error("Error getting exhibit data:",e),t(e.message||"An error occurred while processing exhibit data"),!1}}async function l(){var e={navigation:{backgroundColor:{input:"#nav-background-color",picker:"#nav-background-color-picker"},color:{input:"#nav-font-color",picker:"#nav-font-color-picker"},fontFamily:{select:"#nav-font"},fontSize:{input:"#nav-font-size"}},template:{backgroundColor:{input:"#template-background-color",picker:"#template-background-color-picker"},color:{input:"#template-font-color",picker:"#template-font-color-picker"},fontFamily:{select:"#template-font"},fontSize:{input:"#template-font-size"}},introduction:{backgroundColor:{input:"#introduction-background-color",picker:"#introduction-background-color-picker"},color:{input:"#introduction-font-color",picker:"#introduction-font-color-picker"},fontFamily:{select:"#introduction-font"},fontSize:{input:"#introduction-font-size"}}};let s=(e,t)=>{e=document.querySelector(e);e&&null!=t&&(e.value=t)};var t=(e,t)=>{e=document.querySelector(e);e&&(e.checked=Boolean(t))};let m=(e,t)=>{e=document.querySelector(e);e&&t&&(e.innerHTML="",e.appendChild(t))};var r=(e,t,r,o,n,a,i)=>{var l,d,c,u,t=e[t];t&&(e=h+`/api/v1/exhibits/${e.uuid}/media/`+t,l=t,e=e,u=200,d=document.createElement("p"),(c=document.createElement("img")).alt=l||"",c.src=e,c.height=u,d.appendChild(c),l=d,e=t,(u=document.createElement("span")).style.fontSize="11px",u.textContent=e,c=u,m(r,l),m(o,c),s(n,t),s(a,t),((e,t)=>{e=document.querySelector(e);e&&(e.style.display=t)})(i,"inline"))};var o,n=(e,t,r)=>{t&&t.exhibit&&t.exhibit[e]&&(t=t.exhibit[e],r=r[e],t.backgroundColor&&(s(r.backgroundColor.input,t.backgroundColor),s(r.backgroundColor.picker,t.backgroundColor)),t.color&&(s(r.color.input,t.color),s(r.color.picker,t.color)),t.fontFamily&&((e,t)=>{var r=document.querySelector(e);if(r&&t)for(let e=0;e<r.options.length;e++)if(r.options[e].value===t){r.value=t;break}})(r.fontFamily.select,t.fontFamily),t.fontSize)&&(e=String(t.fontSize).replace("px",""),s(r.fontSize.input,e))};try{var a=await c();if(!a)throw new Error("Failed to retrieve exhibit record");await helperModule.check_if_locked(a,"#exhibit-submit-card"),(d=a)&&1===d.is_locked&&(o=authModule.get_user_profile_data())&&o.uid&&parseInt(o.uid,10)===parseInt(d.locked_by_user,10)&&(o=()=>{try{helperModule&&"function"==typeof helperModule.unlock_record&&helperModule.unlock_record().catch(e=>{console.error("Error unlocking record during page unload:",e)})}catch(e){console.error("Error in page unload handler:",e)}},window.addEventListener("beforeunload",o),window.addEventListener("pagehide",o),console.log("Auto-unlock setup complete for record")),((e,t,r,o)=>{let n=document.querySelector("#created");var a,i;n&&(a=[],e&&t&&(t=new Date(t),t=helperModule.format_date(t),(i=document.createElement("em")).textContent=`Created by ${e} on `+t,a.push(i)),r&&o&&(e=new Date(o),t=helperModule.format_date(e),0<a.length&&a.push(document.createTextNode(" | ")),(i=document.createElement("em")).textContent=`Last updated by ${r} on `+t,a.push(i)),n.innerHTML="",a.forEach(e=>n.appendChild(e)))})(a.created_by,a.created,a.updated_by,a.updated);var i=1===a.is_published;if(s("#is-published",i),s("#exhibit-title-input",helperModule.unescape(a.title||"")),s("#exhibit-sub-title-input",helperModule.unescape(a.subtitle||"")),s("#exhibit-description-input",helperModule.unescape(a.description||"")),s("#exhibit-about-the-curators-input",helperModule.unescape(a.about_the_curators||"")),s("#exhibit-owner",a.owner),t("#is-featured",1===a.is_featured),t("#is-student-curated",1===a.is_student_curated),a.alert_text&&(t("#is-content-advisory",!0),s("#exhibit-alert-text-input",helperModule.unescape(a.alert_text))),a.hero_image&&r(a,"hero_image","#hero-image-display","#hero-image-filename-display","#hero-image","#hero-image-prev","#hero-trash"),a.thumbnail&&r(a,"thumbnail","#thumbnail-image-display","#thumbnail-filename-display","#thumbnail-image","#thumbnail-image-prev","#thumbnail-trash"),a.banner_template&&((e,t)=>{var r=document.getElementsByName(e);for(let e=0;e<r.length;e++)if(r[e].value===t){r[e].checked=!0;break}})("banner_template",a.banner_template),a.styles)try{var l=JSON.parse(a.styles);n("navigation",l,e),n("template",l,e),n("introduction",l,e)}catch(e){console.error("Error parsing styles JSON:",e)}return!1}catch(e){console.error("Error displaying edit record:",e);var d=e.message||"An error occurred while loading the exhibit record";return o=d,(i=document.querySelector("#message"))?((t=document.createElement("div")).className="alert alert-danger",t.setAttribute("role","alert"),(r=document.createElement("i")).className="fa fa-exclamation",o=document.createTextNode(" "+o),t.appendChild(r),t.appendChild(o),i.innerHTML="",i.appendChild(t)):console.error("Message element not found"),!1}}async function d(){var t=(e,t="success",r="fa-info")=>{var o,n=document.querySelector("#message");n?((o=document.createElement("div")).className="alert alert-"+t,o.setAttribute("role","alert"),(t=document.createElement("i")).className="fa "+r,r=document.createTextNode(" "+e),o.appendChild(t),o.appendChild(r),n.innerHTML="",n.appendChild(o)):console.error("Message element not found")};let e=e=>{e=document.querySelector(e);e&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName?e.value="":e.innerHTML="")};var r=()=>{e("#hero-image"),e("#hero-image-filename-display"),e("#hero-image-display"),((e,t)=>{e=document.querySelector(e);e&&(e.style.display=t)})("#hero-trash","none")};let o=null;try{if(!p||"object"!=typeof p)throw new Error("API endpoints configuration not available");var n=helperModule.get_parameter_by_name("exhibit_id");if(!n)throw new Error("Missing required parameter: exhibit_id");var a=document.querySelector("#hero-image");if(!a)throw new Error("Hero image input element not found");var i=a.value?.trim();if(!i)return t("No hero image to delete","warning","fa-exclamation"),!1;var l=authModule.get_user_token();if(!l)return t("Authentication error: Please log in again","danger","fa-lock"),!1;var d=p.exhibits?.exhibit_media?.get?.endpoint;if(!d)throw new Error("Endpoint configuration not found");var c=encodeURIComponent(n),u=encodeURIComponent(i),s=d.replace(":exhibit_id",c).replace(":media",u),m=(t("Deleting hero image...","info"),await Promise.race([httpModule.req({method:"DELETE",url:s,headers:{"Content-Type":"application/json","x-access-token":l}}),new Promise((e,t)=>setTimeout(()=>t(new Error("Request timeout")),3e4))]));if(!m)throw new Error("No response received from server");if(204!==m.status)throw new Error("Failed to delete hero image. Server returned status "+m.status);return r(),t("Hero image deleted successfully","success","fa-check"),o=setTimeout(()=>{e("#message")},3e3),!0}catch(e){return o&&clearTimeout(o),console.error("Error deleting hero image:",e),t(e.message||"An unexpected error occurred while deleting the hero image","danger","fa-exclamation"),!1}}async function s(){var t=(e,t="success",r="fa-info")=>{var o,n=document.querySelector("#message");n?((o=document.createElement("div")).className="alert alert-"+t,o.setAttribute("role","alert"),(t=document.createElement("i")).className="fa "+r,r=document.createTextNode(" "+e),o.appendChild(t),o.appendChild(r),n.innerHTML="",n.appendChild(o)):console.error("Message element not found")};let e=e=>{e=document.querySelector(e);e&&("INPUT"===e.tagName||"TEXTAREA"===e.tagName?e.value="":e.innerHTML="")};var r=()=>{e("#thumbnail-image"),e("#thumbnail-filename-display"),e("#thumbnail-image-display"),((e,t)=>{e=document.querySelector(e);e&&(e.style.display=t)})("#thumbnail-trash","none")};let o=null;try{if(!p||"object"!=typeof p)throw new Error("API endpoints configuration not available");var n=helperModule.get_parameter_by_name("exhibit_id");if(!n)throw new Error("Missing required parameter: exhibit_id");var a=document.querySelector("#thumbnail-image");if(!a)throw new Error("Thumbnail image input element not found");var i=a.value?.trim();if(!i)return t("No thumbnail image to delete","warning","fa-exclamation"),!1;var l=authModule.get_user_token();if(!l)return t("Authentication error: Please log in again","danger","fa-lock"),!1;var d=p.exhibits?.exhibit_media?.get?.endpoint;if(!d)throw new Error("Endpoint configuration not found");var c=encodeURIComponent(n),u=encodeURIComponent(i),s=d.replace(":exhibit_id",c).replace(":media",u),m=(t("Deleting thumbnail image...","info"),await Promise.race([httpModule.req({method:"DELETE",url:s,headers:{"Content-Type":"application/json","x-access-token":l}}),new Promise((e,t)=>setTimeout(()=>t(new Error("Request timeout")),3e4))]));if(!m)throw new Error("No response received from server");if(204!==m.status)throw new Error("Failed to delete thumbnail image. Server returned status "+m.status);return r(),t("Thumbnail image deleted successfully","success","fa-check"),o=setTimeout(()=>{e("#message")},3e3),!0}catch(e){return o&&clearTimeout(o),console.error("Error deleting thumbnail image:",e),t(e.message||"An unexpected error occurred while deleting the thumbnail image","danger","fa-exclamation"),!1}}return e.update_exhibit_record=async function(){let n=document.querySelector("#message");var t=(e,t,r="fa-info")=>{var o;n?((o=document.createElement("div")).className="alert alert-"+e,o.setAttribute("role","alert"),(e=document.createElement("i")).className="fa "+r,r=document.createTextNode(" "+t),o.appendChild(e),o.appendChild(r),n.innerHTML="",n.appendChild(o)):console.error("Message element not found")};let r=null;try{window.scrollTo({top:0,left:0,behavior:"instant"});var e=helperModule.get_parameter_by_name("exhibit_id");if(!e)return t("danger","Unable to get record UUID","fa-exclamation"),!1;var o=authModule.get_user_token();if(!o)return t("danger","Unable to get session token","fa-exclamation"),r=setTimeout(()=>{authModule.logout()},1e3),!1;var a=u();if(!a)return t("danger","Unable to get exhibit data","fa-exclamation"),!1;t("info","Updating exhibit record..."),a.updated_by=helperModule.get_user_name();var i=encodeURIComponent(e),l=p.exhibits.exhibit_records.endpoints.put.endpoint.replace(":exhibit_id",i),d=await Promise.race([httpModule.req({method:"PUT",url:l,data:a,headers:{"Content-Type":"application/json","x-access-token":o}}),new Promise((e,t)=>setTimeout(()=>t(new Error("Request timeout")),3e4))]);if(d&&201===d.status)return t("success","Exhibit record updated"),r=setTimeout(()=>{window.location.reload()},900),!0;throw new Error("Failed to update exhibit record")}catch(e){return r&&clearTimeout(r),console.error("Update exhibit error:",e),t("danger",e.message||"An unexpected error occurred while updating the exhibit","fa-exclamation"),!1}},e.init=async function(){var t,r,o,n,e=(e,t,r,o)=>{var n=document.querySelector(e),a=document.querySelector(t);n&&a?(n=n.value&&0<n.value.trim().length?r:o,r=a.cloneNode(!0),a.parentNode.replaceChild(r,a),n&&"function"==typeof n&&r.addEventListener("click",n)):console.warn(`Image elements not found: ${e} or `+t)};try{var a=helperModule.get_parameter_by_name("exhibit_id");if(a)return i="/exhibits/exhibit/details?"+new URLSearchParams({exhibit_id:a,status:"403"}).toString(),await authModule.check_permissions(["update_exhibit","update_any_exhibit"],"exhibit",a,null,i),navModule.back_to_exhibits(),t="#save-exhibit-btn",r="click",o=exhibitsEditFormModule?.update_exhibit_record,(n=document.querySelector(t))&&o&&"function"==typeof o?n.addEventListener(r,o):console.warn("Could not attach listener to: "+t),await l(),e("#hero-image","#hero-trash",d,exhibitsCommonFormModule?.delete_hero_image),e("#thumbnail-image","#thumbnail-trash",s,exhibitsCommonFormModule?.delete_thumbnail_image),console.log("Module initialized successfully"),!0;throw new Error("Missing required parameter: exhibit_id")}catch(e){console.error("Error initializing module:",e);var i=e.message||"An error occurred during initialization";return n=i,(r=document.querySelector("#message"))?((o=document.createElement("div")).className="alert alert-danger",o.setAttribute("role","alert"),(t=document.createElement("i")).className="fa fa-exclamation",n=document.createTextNode(" "+n),o.appendChild(t),o.appendChild(n),r.innerHTML="",r.appendChild(o)):console.error("Message element not found"),!1}},e})();