let helperModule=(()=>{var e={};function m(e){try{var t=document.querySelector("#message");t&&(t.innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e}</div>`)}catch(e){console.error("Error displaying message:",e.message)}}function r(t){try{if(!t||"string"!=typeof t)return"";var r,n,o=["script","iframe","html","head","body","title","img","embed","applet","object","style","link","form","input","video","source","math","maction","picture","map","svg","details","frameset","comment","base","meta","noscript","onclick","onerror","onload","onmouseover","frame","bgsound","marquee"],a=document.createElement("div");try{a.innerHTML=t}catch(e){return console.warn("Failed to parse HTML:",e.message),""}for(r of o)for(n of a.querySelectorAll(r))n.remove();var i,l=["onclick","onerror","onload","onmouseover","onmouseout","onkeydown","onkeyup","onfocus","onblur","onchange","onsubmit","ondblclick","onmouseenter","onmouseleave","oncontextmenu","onwheel","ondrag","ondrop"];for(i of a.querySelectorAll("*")){for(var s of l)i.removeAttribute(s);var c,d,u=["href","title","target","rel","class","id"],m=[];for(c of i.attributes)u.includes(c.name.toLowerCase())||m.push(c.name);for(d of m)i.removeAttribute(d)}let e=a.innerHTML;var p,g,h={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"};for([p,g]of Object.entries(h))e=e.split(p).join(g);return"string"!=typeof(e=e.replace(/\s+/g," ").trim())?(console.warn("Cleaned HTML is not a string"),""):e}catch(e){return console.error("Error in manual_clean_html:",e.message),""}}function a(e){try{var t;return e&&"string"==typeof e?(t=document.querySelectorAll(e))?Array.from(t):[]:(console.error("Invalid selector"),[])}catch(e){return console.error("Error getting form cards:",e),[]}}function i(e,n=!1){e&&0!==e.length&&requestAnimationFrame(()=>{e.forEach(e=>{if(e&&e instanceof HTMLElement)try{var t,r;n?((t=e).style.visibility="visible",t.style.opacity="0",t.style.transition="opacity 0.3s ease-in","none"===t.style.display&&(t.style.display=""),requestAnimationFrame(()=>{t.style.opacity="1"}),t.classList.contains("hidden")&&t.classList.remove("hidden")):((r=e).classList.contains("hidden")&&r.classList.remove("hidden"),r.style.visibility="visible","none"===r.style.display&&(r.style.display=""),"0"===r.style.opacity&&(r.style.opacity="1"))}catch(e){console.error("Error showing card:",e)}else console.warn("Invalid card element, skipping")})})}function o(e,r=!1){e&&0!==e.length&&requestAnimationFrame(()=>{e.forEach(e=>{var t;if(e&&e instanceof HTMLElement)try{r?((t=e).style.transition="opacity 0.3s ease-out",t.style.opacity="0",setTimeout(()=>{t.style.visibility="hidden"},300)):e.style.visibility="hidden"}catch(e){console.error("Error hiding card:",e)}})})}function c(e){try{var t=e.querySelector(".item-order");if(t){var r=t.querySelector("span");if(r){var n=r.textContent.trim(),o=parseInt(n,10);if(!isNaN(o)&&0<o)return o}var a=t.textContent.trim(),i=parseInt(a,10);if(!isNaN(i)&&0<i)return i}var l=e.querySelector("td");if(l&&l.classList.contains("item-order")){var s=l.textContent.trim(),c=parseInt(s,10);if(!isNaN(c)&&0<c)return c}var d=e.getAttribute("data-order");if(d){var u=parseInt(d,10);if(!isNaN(u)&&0<u)return u}return null}catch(e){return console.error("Error getting order number:",e),null}}function d(e,t){var r,n;e&&(e.textContent="",(r=document.createElement("div")).className="alert alert-success",r.setAttribute("role","alert"),(n=document.createElement("i")).className="fa fa-check",n.setAttribute("aria-hidden","true"),r.appendChild(n),n=document.createTextNode(" "+t),r.appendChild(n),e.appendChild(r))}function u(e,t){var r,n;e&&(e.textContent="",(r=document.createElement("div")).className="alert alert-danger",r.setAttribute("role","alert"),(n=document.createElement("i")).className="fa fa-exclamation",n.setAttribute("aria-hidden","true"),r.appendChild(n),n=document.createTextNode(" "+t),r.appendChild(n),e.appendChild(r))}return e.get_parameter_by_name=function(t,e){try{if(!t||"string"!=typeof t)return console.warn("Invalid or missing parameter name"),null;var r=e&&"string"==typeof e?e:window.location.href;if(!r||"string"!=typeof r)return console.warn("Invalid URL provided"),null;try{var n,o=new URL(r),a=new URLSearchParams(o.search).get(t);return null===a?null:""===a?"":"string"!=typeof a?(console.warn("Parameter value is not a string: "+t),null):(n=DOMPurify.sanitize(a,{ALLOWED_TAGS:[]}))!==a?(console.warn("Parameter contained potentially malicious content: "+t),null):n}catch(e){console.debug("URLSearchParams failed, using regex fallback:",e.message);var i,l,s,c,d=t,u=r;try{return d&&"string"==typeof d&&u&&"string"==typeof u?(i=d.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),(l=new RegExp(`[?&]${i}(=([^&#]*)|&|#|$)`,"i").exec(u))?l[2]?"string"!=typeof(s=decodeURIComponent(l[2].replace(/\+/g," ")))?(console.warn("Decoded parameter value is not a string: "+d),null):(c=DOMPurify.sanitize(s,{ALLOWED_TAGS:[]}))!==s?(console.warn("Parameter contained potentially malicious content: "+d),null):c:"":null):null}catch(e){return console.error("Error in parse_parameter_regex:",e.message),null}}}catch(e){return console.error("Error in get_parameter_by_name:",e.message),m("An error occurred: "+e.message),null}},e.unescape=function(t){try{if(null==t)return"";if("string"!=typeof t&&(console.warn("Data is not a string, converting from "+typeof t),t=String(t)),""===t||""===t.trim())return"";var r,n,o={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&#x27;":"'","&#x2F;":"/","&apos;":"'"};let e=t;for([r,n]of Object.entries(o))e=e.split(r).join(n);return"string"!=typeof(e=(e=e.replace(/&#(\d+);/g,(e,t)=>{t=parseInt(t,10);return 0<t&&t<=1114111?String.fromCharCode(t):e})).replace(/&#x([0-9a-fA-F]+);/g,(e,t)=>{t=parseInt(t,16);return 0<t&&t<=1114111?String.fromCharCode(t):e}))?(console.warn("Unescaped value is not a string"),""):e}catch(e){return console.error("Error in unescape_safe:",e.message),m("An error occurred: "+e.message),""}},e.strip_html=function(t){try{if(null==t)return"";if("string"!=typeof t&&(console.warn("Input is not a string, converting from "+typeof t),t=String(t)),""===t||""===t.trim())return"";try{return(new DOMParser).parseFromString(t,"text/html").body.textContent||""}catch(e){console.debug("DOMParser failed, using regex fallback:",e.message);var r=t;try{if(!r||"string"!=typeof r)return"";let e=r.replace(/<[^>]*>/g,"");e=(e=e.replace(/\s+/g," ")).trim();var n,o,a={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&#x27;":"'","&#x2F;":"/"};for([n,o]of Object.entries(a))e=e.split(n).join(o);return"string"!=typeof(e=(e=e.replace(/&#(\d+);/g,(e,t)=>{t=parseInt(t,10);return 0<t&&t<=1114111?String.fromCharCode(t):e})).replace(/&#x([0-9a-fA-F]+);/g,(e,t)=>{t=parseInt(t,16);return 0<t&&t<=1114111?String.fromCharCode(t):e}))?(console.warn("Stripped value is not a string"),""):e}catch(e){return console.error("Error in strip_html_regex:",e.message),""}}}catch(e){return console.error("Error in strip_html:",e.message),m("An error occurred: "+e.message),""}},e.clean_html=function(t){try{if(null==t)return"";if("string"!=typeof t&&(console.warn("Input is not a string, converting from "+typeof t),t=String(t)),""===t||""===t.trim())return"";if("undefined"!=typeof DOMPurify)try{var e=DOMPurify.sanitize(t,{ALLOWED_TAGS:["b","i","em","strong","a","p","br","ul","ol","li","blockquote","h1","h2","h3","h4","h5","h6","span","div"],ALLOWED_ATTR:["href","title","target","rel"],KEEP_CONTENT:!0,FORCE_BODY:!1});return"string"!=typeof e?(console.warn("DOMPurify output is not a string"),""):e}catch(e){return console.error("DOMPurify sanitization failed:",e.message),r(t)}return console.debug("DOMPurify not available, using manual HTML cleaning"),r(t)}catch(e){return console.error("Error in clean_html:",e.message),m("An error occurred: "+e.message),""}},e.preview_html=function(e){try{if(helperModule)if(e&&"string"==typeof e){var t=e.replace(/[^a-zA-Z0-9_-]/g,"");if(t!==e)console.warn("Element ID contained invalid characters: "+e),m("Invalid element ID format.");else{var r=document.getElementById(t);if(r)if("string"!=typeof r.value)console.warn("Source element does not have a string value property: "+t),m("Source element has invalid value.");else{var n,o=r.value;if(o&&""!==o.trim()){var a=helperModule.clean_html(o);if(a&&"string"==typeof a){var i=document.getElementById("preview-html");if(i){try{i.innerHTML=a}catch(e){return console.error("Failed to set preview HTML:",e.message),m("Failed to display HTML preview."),!1}try{r.value=a}catch(e){return console.error("Failed to update source element:",e.message),m("Failed to update HTML content."),!1}console.debug("HTML preview successfully generated for element: "+t)}else console.warn("Preview element not found: preview-html"),m("Preview element not found in page.")}else console.error("HTML cleaning failed or returned invalid result"),m("Failed to clean HTML content.")}else console.debug("No HTML content to preview, clearing previous data"),(n=document.getElementById("preview-html"))&&(n.innerHTML=""),r.value=""}else console.warn("Source element not found: "+t),m(`Element with ID "${t}" not found.`)}}else console.warn("Invalid or missing element ID parameter"),m("Invalid element ID provided.");else console.error("helperModule is not available"),m("System configuration error.");return!1}catch(e){return console.error("Error in preview_html:",e.message),m("An error occurred: "+e.message),!1}},e.get_checked_radio_button=function(e){try{var t,r;return e?e.length?"function"!=typeof e[Symbol.iterator]&&"number"!=typeof e.length?(console.warn("radio_buttons is not iterable"),null):(t=Array.from(e).find(e=>e&&"object"==typeof e&&"checked"in e?!0===e.checked:(console.warn("Invalid radio button element in collection"),!1)))?"value"in t?""===(r=String(t.value))||"undefined"===r?(console.warn("Checked radio button has empty or undefined value"),null):r:(console.warn("Checked radio button does not have value property"),null):(console.debug("No radio button is currently checked"),null):(console.warn("radio_buttons is not array-like or is empty"),null):(console.warn("Missing radio_buttons parameter"),null)}catch(e){return console.error("Error in get_checked_radio_button:",e.message),m("An error occurred: "+e.message),null}},e.get_current_year=function(){try{var e=(new Date).getFullYear();domModule.html("#cdate",DOMPurify.sanitize(e))}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e.format_date=function(e){return(1+e.getMonth()).toString().padStart(2,"0")+`/${e.getDate().toString().padStart(2,"0")}/${e.getFullYear()} @ ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}:`+e.getSeconds().toString().padStart(2,"0")},e.show_form=function(t=0,r=".card",n=!1){try{var o=(e=>"number"!=typeof(e="string"==typeof e?parseInt(e,10):e)||isNaN(e)?(console.warn("Invalid delay, using 0"),0):e<0?(console.warn("Negative delay not allowed, using 0"),0):1e4<e?(console.warn("Delay too large, capping at 10 seconds"),1e4):Math.floor(e))(t);let e=a(r);return e&&0!==e.length?(0===o?i(e,n):setTimeout(()=>{i(e,n)},o),!0):(console.warn("No elements found with selector: "+r),!1)}catch(e){console.error("Error showing form:",e);t=document.querySelector("#message");return t&&u(t,e.message||"Unable to show form"),!1}},e.hide_form=function(e=".card",t=!1){try{var r=a(e);return r&&0!==r.length?(o(r,t),!0):(console.warn("No elements found with selector: "+e),!1)}catch(e){return console.error("Error hiding form:",e),!1}},e.toggle_form=function(e=".card",t=!1){try{var r,n=a(e);return n&&0!==n.length?"hidden"!==(r=n[0]).style.visibility&&"hidden"!==getComputedStyle(r).visibility?(o(n,t),!1):(i(n,t),!0):(console.warn("No elements found with selector: "+e),!1)}catch(e){return console.error("Error toggling form:",e),!1}},e.reorder_items=async function(e,t){try{if(!t||!Array.isArray(t))return console.error("Invalid reordered_items parameter"),!1;if(0===t.length)return console.log("No items to reorder"),!1;var r=endpointsModule.get_exhibits_endpoints();if(!r?.exhibits?.reorder_records?.post?.endpoint)throw new Error("Reorder endpoint not configured");var n=helperModule.get_parameter_by_name("exhibit_id");if(!n)throw new Error("Exhibit ID not found in URL");var o=authModule.get_user_token();if(!o||!1===o)throw new Error("Not authenticated - please log in again");var a=(t=>{var r=[];for(let e=0;e<t.length;e++){var n,o,a=t[e];a&&a.node?(a=a.node,(n=a.getAttribute("id"))?(o=(e=>!e||"string"!=typeof e||(e=e.split("_")).length<2?null:3===e.length?{uuid:e[0],type:e[2]}:2===e.length?{uuid:e[0],type:e[1]}:{uuid:e[0],type:e[e.length-1]})(n))?null===(a=c(a))?console.warn("Could not find order number for item:",n):r.push({uuid:o.uuid,type:o.type,order:a}):console.warn("Could not parse item ID:",n):console.warn("Item missing id attribute at index",e)):console.warn("Invalid item at index",e)}return r})(t);if(!a||0===a.length)throw new Error("Failed to build reorder data");var i=r.exhibits.reorder_records.post.endpoint.replace(":exhibit_id",encodeURIComponent(n)),l=await httpModule.req({method:"POST",url:i,data:a,headers:{"Content-Type":"application/json","x-access-token":o},timeout:3e4});if(l&&201===l.status){console.log("Items reordered successfully");let e=document.querySelector("#message");return e&&(d(e,"Items reordered successfully"),setTimeout(()=>{e.textContent=""},3e3)),!0}throw new Error("Failed to reorder items - server returned an error")}catch(e){console.error("Error reordering items:",e);t=document.querySelector("#message");return t&&u(t,e.message||"An error occurred while reordering items"),!1}},e.reorder_grid_items=async function(e,t){try{if(!t||!Array.isArray(t))return console.error("Invalid reordered_items parameter"),!1;if(0===t.length)return console.log("No grid items to reorder"),!1;var r=endpointsModule.get_exhibits_endpoints();if(!r?.exhibits?.reorder_records?.post?.endpoint)throw new Error("Reorder endpoint not configured");var n=helperModule.get_parameter_by_name("exhibit_id");if(!n)throw new Error("Exhibit ID not found in URL");var o=helperModule.get_parameter_by_name("grid_id");if(!o)throw new Error("Grid ID not found in URL");var a=authModule.get_user_token();if(!a||!1===a)throw new Error("Not authenticated - please log in again");var i=((t,r)=>{var n=[];for(let e=0;e<t.length;e++){var o,a,i=t[e];i&&i.node?(i=i.node,(o=i.getAttribute("id"))?(a=(e=>{if(e&&"string"==typeof e){e=e.split("_");if(!(e.length<1)){e=e[0];if(e&&0<e.length)return e}}return null})(o))?null===(i=c(i))?console.warn("Could not find order number for grid item:",o):n.push({grid_id:r,uuid:a,type:"griditem",order:i}):console.warn("Could not parse grid item ID:",o):console.warn("Grid item missing id attribute at index",e)):console.warn("Invalid grid item at index",e)}return n})(t,o);if(!i||0===i.length)throw new Error("Failed to build grid reorder data");var l=r.exhibits.reorder_records.post.endpoint.replace(":exhibit_id",encodeURIComponent(n)),s=await httpModule.req({method:"POST",url:l,data:i,headers:{"Content-Type":"application/json","x-access-token":a},timeout:3e4});if(s&&201===s.status){console.log("Grid items reordered successfully");let e=document.querySelector("#message");return e&&(d(e,"Grid items reordered successfully"),setTimeout(()=>{e.textContent=""},3e3)),!0}throw new Error("Failed to reorder grid items - server returned an error")}catch(e){console.error("Error reordering grid items:",e);t=document.querySelector("#message");return t&&u(t,e.message||"An error occurred while reordering grid items"),!1}},e.check_if_locked=async function(t,r){let n=()=>{helperModule&&"function"==typeof helperModule.unlock_record?helperModule.unlock_record(!1,{force:!0}):console.error("unlock_record function not available")};var o,a,i,l,s,c,d,u,m;try{if(t&&"object"==typeof t)if(r&&"string"==typeof r){var p=authModule.get_user_profile_data();if(p&&p.uid){var g=parseInt(p.uid,10);if(isNaN(g))console.error("Invalid user ID in profile");else{var h=1===t.is_locked||!0===t.is_locked,f=t.locked_by_user&&parseInt(t.locked_by_user,10)!==g;if(h&&f)if((e=>{e=document.querySelector(e);e&&(e.style.display="none")})(r),document.querySelector("#message")){var _=await authModule.get_user_role(g);let e=null;"Administrator"===_&&(e=((c=document.createElement("div")).className="btn-group float-right",(d=document.createElement("button")).id="unlock-record",d.className="btn btn-xs btn-secondary",(u=document.createElement("i")).className="fa fa-unlock-alt",m=document.createTextNode(" Unlock"),d.appendChild(u),d.appendChild(m),d.addEventListener("click",n),c.appendChild(d),u=document.createElement("span"),m=document.createElement("br"),u.appendChild(m),u.appendChild(c),u));[o,a,i=null]=["warning","This record is currently being worked on by another user.",e],(s=document.querySelector("#message"))?((l=document.createElement("div")).className="alert alert-"+o,l.setAttribute("role","alert"),(o=document.createElement("i")).className="fa fa-lock",a=document.createTextNode(" "+a),l.appendChild(o),l.appendChild(a),i&&(l.appendChild(document.createTextNode("  ")),l.appendChild(i)),s.innerHTML="",s.appendChild(l)):console.error("Message element not found")}else console.warn("Message element not found, cannot display lock warning")}}else console.error("Unable to get user profile data")}else console.error("Invalid card_id provided to check_if_locked");else console.error("Invalid record provided to check_if_locked")}catch(e){console.error("Error checking if record is locked:",e);p=e.message||"An error occurred while checking record lock status";t=p,(h=document.querySelector("#message"))?((f=document.createElement("div")).className="alert alert-danger",f.setAttribute("role","alert"),(r=document.createElement("i")).className="fa fa-exclamation",t=document.createTextNode(" "+t),f.appendChild(r),f.appendChild(t),h.innerHTML="",h.appendChild(f)):console.error("Message element not found")}},e.unlock_record=async function(t=!1,r={}){var{}=r;var n=[{paths:["exhibits/exhibit/edit"],endpoint_key:"exhibits.exhibit_unlock_record.post.endpoint",params:e=>({exhibit_id:e})},{paths:["items/heading/edit"],endpoint_key:"exhibits.heading_unlock_record.post.endpoint",params:e=>({exhibit_id:e,heading_id:helperModule.get_parameter_by_name("item_id")})},{paths:["items/standard/text/edit","items/standard/media/edit"],endpoint_key:"exhibits.item_unlock_record.post.endpoint",params:e=>({exhibit_id:e,item_id:helperModule.get_parameter_by_name("item_id")})},{paths:["items/grid/item/media/edit","items/grid/item/text/edit"],endpoint_key:"exhibits.grid_item_unlock_record.post.endpoint",params:e=>({exhibit_id:e,grid_id:helperModule.get_parameter_by_name("grid_id"),item_id:helperModule.get_parameter_by_name("item_id")})},{paths:["items/vertical-timeline/item/media/edit","items/vertical-timeline/item/text/edit"],endpoint_key:"exhibits.timeline_item_unlock_record.post.endpoint",params:e=>({exhibit_id:e,timeline_id:helperModule.get_parameter_by_name("timeline_id"),item_id:helperModule.get_parameter_by_name("item_id")})}],o=(e,t="info",r="fa-info")=>{var n,o=document.querySelector("#message");o?((n=document.createElement("div")).className="alert alert-"+t,n.setAttribute("role","alert"),r&&((t=document.createElement("i")).className="fa "+r,n.appendChild(t),n.appendChild(document.createTextNode(" "))),r=document.createTextNode(e),n.appendChild(r),o.innerHTML="",o.appendChild(n)):console.error("Message element not found")};try{var a=endpointsModule.get_exhibits_endpoints();if(!a)throw new Error("Unable to retrieve endpoints configuration");var i=window.location.pathname;if(!i)throw new Error("Unable to determine current page path");var l=helperModule.get_parameter_by_name("exhibit_id");if(!l)throw new Error("Missing required parameter: exhibit_id");var s=((t,e)=>{for(var r of e)if(r.paths.some(e=>t.includes(e)))return r;return null})(i,n);if(!s)return console.error("No matching endpoint found for current path:",i),t||o("Unable to determine record type.","danger","fa-exclamation"),!1;var c=((e,t)=>{if(!e||!t)return null;var r;let n=e;for(r of t.split(".")){if(!(n&&"object"==typeof n&&r in n))return null;n=n[r]}return n})(a,s.endpoint_key);if(!c)throw new Error("Endpoint template not found in configuration");var d,u,m="function"==typeof s.params?s.params(l):s.params;for([d,u]of Object.entries(m))if(!u)throw new Error("Missing required parameter: "+d);var p=((e,t)=>{if(!e||!t)return null;let r=e;for(var[n,o]of Object.entries(t)){if(!o)return console.error("Missing required parameter: "+n),null;o=encodeURIComponent(o);r=r.replace(":"+n,o)}return r})(c,m);if(!p)throw new Error("Failed to build endpoint URL");var g=authModule.get_user_profile_data(),h=authModule.get_user_token();if(!g||!g.uid)throw new Error("User profile data not available");if(!h)throw new Error("Authentication token not available");var f,_=new URLSearchParams({uid:g.uid});if(t)return navigator.sendBeacon?(_.append("t",h),f=p+"?"+_.toString(),navigator.sendBeacon(f,"")?(console.log("Unlock beacon sent successfully"),!0):(console.warn("Beacon API failed to send unlock request"),!1)):(console.warn("Beacon API not available"),!1);let e=p+"?"+_.toString();!0===r.force&&(e=e+"&force="+r.force);var y=await Promise.race([httpModule.req({method:"POST",url:e,headers:{"Content-Type":"application/json","x-access-token":h}}),new Promise((e,t)=>setTimeout(()=>t(new Error("Request timeout")),3e4))]);if(y)return 200===y.status?(o("Record unlocked successfully","success","fa-check"),!0):(o("Failed to unlock record. Please try again.","danger","fa-exclamation"),!1);throw new Error("No response received from server")}catch(e){return console.error("Error unlocking record:",e),t||o(e.message||"An unexpected error occurred while unlocking the record","danger","fa-exclamation"),!1}},e.setup_auto_unlock=function(e){if(e&&1===e.is_locked){var t=authModule.get_user_profile_data();if(t&&t.uid){t=parseInt(t.uid,10),e=parseInt(e.locked_by_user,10);if(t===e){let e=!1;document.addEventListener("visibilitychange",()=>{document.hidden&&!e&&(e=!0,console.log("Tab hidden - attempting unlock via beacon"),this.unlock_record(!0).catch(e=>{console.error("Visibility unlock failed:",e)}))}),window.addEventListener("pagehide",()=>{e||(e=!0,console.log("Page hiding - attempting unlock via beacon"),this.unlock_record(!0).catch(e=>{console.error("Page hide unlock failed:",e)}))}),window.addEventListener("beforeunload",()=>{e||(e=!0,console.log("Page unloading - attempting unlock via beacon"),this.unlock_record(!0).catch(e=>{console.error("Before unload unlock failed:",e)}))}),console.log("Auto-unlock setup complete for record (using beacon on visibility/page events)")}}}},e.get_user_name=function(){try{var e;return authModule&&"function"==typeof authModule.get_user_profile_data?(e=authModule.get_user_profile_data())&&"object"==typeof e?e.name||null:(console.warn("User profile data not available"),null):(console.error("authModule or get_user_profile_data not available"),null)}catch(e){return console.error("Error getting user name:",e),null}},e.get_owner=function(){try{var e,t;return authModule&&"function"==typeof authModule.get_user_profile_data?(e=authModule.get_user_profile_data())&&"object"==typeof e?e.uid?(t=parseInt(e.uid,10),isNaN(t)?(console.error("Invalid UID value:",e.uid),null):t):(console.warn("User UID not available in profile"),null):(console.warn("User profile data not available"),null):(console.error("authModule or get_user_profile_data not available"),null)}catch(e){return console.error("Error getting owner ID:",e),null}},e.create_subjects_menu=async function(e=[]){try{Array.isArray(e)||(console.warn("Subjects parameter is not an array, converting"),e=[]);let r=await this.get_item_subjects();if(r&&Array.isArray(r)){let a={header:document.getElementById("dropdownHeader"),list:document.getElementById("dropdownList"),virtual_list:document.getElementById("virtualList"),arrow:document.getElementById("arrow"),selected_text:document.getElementById("selectedText"),result_list:document.getElementById("resultList"),search_box:document.getElementById("searchBox"),search_input:document.getElementById("searchInput"),selected_subjects_input:document.getElementById("selected-subjects")};for(var[n,o]of Object.entries(a))if(!o)return console.error("Required element not found: "+n),void m("Missing required UI element: "+n);let i={selected:new Set(e.filter(e=>e&&e.trim())),filtered_items:[...r],item_map:new Map,is_open:!1,ITEM_HEIGHT:48,BUFFER:50},t;function l(){a.virtual_list.innerHTML="",i.item_map.clear();var e=a.list.scrollTop||0,t=Math.max(0,Math.floor(e/i.ITEM_HEIGHT)-i.BUFFER),r=Math.min(i.filtered_items.length,Math.ceil((e+a.list.clientHeight)/i.ITEM_HEIGHT)+i.BUFFER);a.virtual_list.style.height=i.filtered_items.length*i.ITEM_HEIGHT+"px",a.virtual_list.style.position="relative";for(let e=t;e<r;e++){let t=i.filtered_items[e];var n=document.createElement("div");n.className="dropdown-item",n.style.position="absolute",n.style.top=e*i.ITEM_HEIGHT+"px",n.style.width="100%";let r=document.createElement("input");r.type="checkbox",r.value=t,r.className="form-check-input",r.checked=i.selected.has(t);var o=document.createElement("label");o.className="ms-2",o.style.cursor="pointer",o.style.marginBottom="0",o.textContent=t,o.style.paddingLeft="30px",r.addEventListener("change",e=>{e.target.checked?i.selected.add(t):i.selected.delete(t),s()}),o.addEventListener("click",e=>{e.stopPropagation(),r.checked=!r.checked,r.dispatchEvent(new Event("change"))}),n.appendChild(r),n.appendChild(o),a.virtual_list.appendChild(n),i.item_map.set(t,r)}}function s(){var e,t=Array.from(i.selected).filter(e=>e&&e.trim()),r=(i.selected=new Set(t),t.length);0===r?(a.selected_text.innerHTML='<span class="placeholder">Select subjects...</span>',a.result_list.innerHTML='<li style="color: #999;">None selected</li>',a.selected_subjects_input.value=""):(e=r<=2?t.join(", "):`${t[0]}, ${t[1]}...`,a.selected_text.innerHTML=e+` <span class="selected-count">${r}</span>`,a.result_list.innerHTML=t.sort().map(e=>{var t=document.createElement("div"),e=(t.textContent=e,t.innerHTML);return`<li>
              <span>${e}</span>
              <button class="uncheck-btn" title="Remove subject" data-item="${e}" style="background: none; border: none; cursor: pointer; color: #999; padding: 0 5px; font-size: 18px; line-height: 1;">Ã—</button>
            </li>`}).join(""),a.result_list.querySelectorAll(".uncheck-btn").forEach(t=>{t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();e=t.dataset.item,i.selected.delete(e),e=i.item_map.get(e);e&&(e.checked=!1),s(),i.is_open&&l()})}),a.selected_subjects_input.value=t.join("|"))}a.search_input.addEventListener("input",e=>{clearTimeout(t),t=setTimeout(()=>{let t=e.target.value.toLowerCase().trim();i.filtered_items=t?r.filter(e=>e.toLowerCase().startsWith(t)):[...r],l()},150)}),a.list.addEventListener("scroll",()=>{l()}),a.header.addEventListener("click",()=>{i.is_open=!i.is_open,a.list.classList.toggle("show"),a.header.classList.toggle("active"),a.arrow.classList.toggle("rotate"),a.search_box.classList.toggle("show"),i.is_open?(a.search_input.focus(),l()):(a.search_input.value="",i.filtered_items=[...r])}),document.addEventListener("click",e=>{e.target.closest(".dropdown-container")||(i.is_open=!1,a.list.classList.remove("show"),a.header.classList.remove("active"),a.arrow.classList.remove("rotate"),a.search_box.classList.remove("show"),a.search_input.value="",i.filtered_items=[...r])}),l(),s()}else console.error("Failed to retrieve item subjects"),m("Failed to load subjects.")}catch(e){console.error("Error in create_subjects_menu:",e.message),m("An error occurred: "+e.message)}},e.get_item_subjects=async function(){try{var t=endpointsModule.get_exhibits_endpoints();if(!t?.exhibits?.item_subjects?.endpoint)throw new Error("Item subjects endpoint not configured");var e=authModule.get_user_token();if(!e||!1===e)return console.error("No authentication token available"),authModule.redirect_to_auth(),null;var r=await httpModule.req({method:"GET",url:t.exhibits.item_subjects.endpoint,headers:{"Content-Type":"application/json","x-access-token":e},timeout:3e4});if(!r)throw new Error("No response received from server");if(200!==r.status)throw new Error("Server returned status "+r.status);if(r.data&&"object"==typeof r.data)return r.data.data?Array.isArray(r.data.data)?r.data.data:(console.error("Response data.data is not an array"),[]):(console.warn("Response data.data is missing or empty"),[]);throw new Error("Invalid response data structure")}catch(e){console.error("Error getting item subjects:",e);t=document.querySelector("#message");return t&&u(t,e.message||"Unable to retrieve item subjects"),null}},e.check_app_env=function(){var e=window.location.hostname;"localhost"!==e&&"libwebapw01-vlt.du.edu"!==e&&"exhibits.dev"!==e||null!==(e=document.querySelector("#app-message"))&&(e.innerHTML='<div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> <strong>"STOP! Do not use Development Site"</strong>&nbsp;&nbsp;&nbsp;<a class="btn btn-info" href="https://exhibits-backend.library.du.edu/exhibits-dashboard/auth" target="_blank">Go to Live Site </a> </div>')},e.clear_status_message=function(e){e&&(e.style.transition="opacity 0.3s ease-out",e.style.opacity="0",setTimeout(()=>{e.textContent="",e.style.opacity="1"},300))},e.init=function(){},e})();helperModule.init();