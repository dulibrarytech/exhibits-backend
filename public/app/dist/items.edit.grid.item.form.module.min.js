let itemsEditGridItemFormModule=(()=>{let b=endpointsModule.get_exhibits_endpoints();var e={};async function f(){var t=document.querySelector("#message"),r=(e,t,r)=>{var i,a;e&&(t=["info","success","danger","warning"].includes(t)?t:"danger",(i=document.createElement("div")).className="alert alert-"+t,i.setAttribute("role","alert"),(a=document.createElement("i")).className=(e=>{const t={info:"fa fa-info",success:"fa fa-check",danger:"fa fa-exclamation",warning:"fa fa-exclamation-triangle"};return t[e]||"fa fa-exclamation"})(t),i.appendChild(a),t=document.createTextNode(" "+r),i.appendChild(t),e.textContent="",e.appendChild(i))};var e,i,a;try{var o=helperModule.get_parameter_by_name("exhibit_id"),n=helperModule.get_parameter_by_name("grid_id"),d=helperModule.get_parameter_by_name("item_id"),l=(i=n,a=d,(e=o)&&i&&a?255<e.length||255<i.length||255<a.length?{valid:!1,error:"Invalid parameter length"}:{valid:!0}:{valid:!1,error:"Missing required parameters: exhibit_id, grid_id, or item_id"});if(!l.valid)return r(t,"danger",l.error),null;var c=authModule.get_user_token();if(!c||!1===c)return r(t,"danger","Authentication required. Redirecting..."),setTimeout(()=>{authModule.redirect_to_auth()},1e3),null;var u=authModule.get_user_profile_data();if(!u?.uid)return r(t,"danger","Invalid user profile data"),null;if(!b?.exhibits?.grid_item_record?.get?.endpoint)return r(t,"danger","API endpoint configuration missing"),null;var s=b.exhibits.grid_item_record.get.endpoint.replace(":exhibit_id",encodeURIComponent(o)).replace(":grid_id",encodeURIComponent(n)).replace(":item_id",encodeURIComponent(d))+"?"+new URLSearchParams({type:"edit",uid:u.uid}).toString(),m=await httpModule.req({method:"GET",url:s,headers:{"Content-Type":"application/json","x-access-token":c},timeout:3e4});if(!m)throw new Error("No response received from server");if(200!==m.status)throw new Error("Server returned status "+m.status);if(m.data?.data)return m.data.data;throw new Error("Invalid response structure")}catch(e){return console.error("Error in get_grid_item_record:",e),r(t,"danger",e.user_message||"Unable to load the grid item record. Please try again."),null}}async function v(){var e=(t,r)=>{if(t){let e;try{e="string"==typeof t?JSON.parse(t):t}catch(e){return void console.error("Failed to parse styles JSON:",e)}var i;e&&"object"==typeof e&&0!==Object.keys(e).length&&(a(e.backgroundColor,r.item_bg_color,r.item_bg_color_picker),a(e.color,r.item_font_color,r.item_font_color_picker),t=e.fontSize,(i=r.item_font_size)&&(t?(t=String(t).replace(/px$/i,"").trim(),i.value=t):i.value=""),((e,r)=>{if(e&&r&&r.options){let t=String(e).trim();var i,a;Array.from(r.options).some(e=>e.value===t)&&(r.value=t)}})(e.fontFamily,r.item_font))}};let a=(e,t,r)=>{e?(e=String(e).trim(),t&&(t.value=e),r&&(r.value=e)):(t&&(t.value=""),r&&(r.value=""))},t=e=>e instanceof Date&&!isNaN(e.getTime());var r,i,o,n,d,l,c,u,s,m,_,p;try{var g,h=await f();if(h)return g={created:document.querySelector("#created"),is_published:document.querySelector("#is-published"),item_title:document.querySelector("#item-title-input"),item_text:document.querySelector("#item-text-input"),item_bg_color:document.querySelector("#item-background-color"),item_bg_color_picker:document.querySelector("#item-background-color-picker"),item_font_color:document.querySelector("#item-font-color"),item_font_color_picker:document.querySelector("#item-font-color-picker"),item_font:document.querySelector("#item-font"),item_font_size:document.querySelector("#item-font-size"),layouts:document.getElementsByName("layout"),media_width:document.getElementsByName("media_width")},await helperModule.check_if_locked(h,"#item-submit-card"),!(_=h)||1!==_.is_locked||((p=authModule.get_user_profile_data())?.uid?(p=parseInt(p.uid,10),_=parseInt(_.locked_by_user,10),isNaN(p)||isNaN(_)?(console.error("Invalid user ID values"),1):p===_):(console.warn("Unable to get user profile data"),1))||(t=>{var e=document.querySelectorAll('input:not([type="hidden"]), textarea, select, button[type="submit"], button[type="button"]');let r=0;e.forEach(e=>{t&&"unlock-record"===e.id||e.disabled||e.readOnly||(e.disabled=!0,e.style.cursor="not-allowed",e.style.opacity="0.6",r++)}),document.querySelectorAll(".btn:not([disabled])").forEach(e=>{t&&"unlock-record"===e.id||(e.disabled=!0,e.style.cursor="not-allowed",e.style.opacity="0.6")}),console.log(`Disabled ${r} form elements (record locked by another user)`)})(await(async()=>{try{var e,t=authModule.get_user_profile_data();return t?.uid?(e=parseInt(t.uid,10),!isNaN(e)&&"Administrator"===await authModule.get_user_role(e)):!1}catch(e){return console.error("Error checking user role:",e),!1}})()),helperModule.setup_auto_unlock(h),l=h,(c=g.created)&&l&&(u=[],l.created_by&&l.created&&(m=new Date(l.created),t(m))&&(m=helperModule.format_date(m),(s=document.createElement("em")).textContent=`Created by ${l.created_by} on `+m,u.push(s)),l.updated_by&&l.updated&&(m=new Date(l.updated),t(m))&&(s=helperModule.format_date(m),(m=document.createElement("em")).textContent=`Last updated by ${l.updated_by} on `+s,u.push(m)),c.textContent="",u.forEach((e,t)=>{0<t&&c.appendChild(document.createTextNode(" | ")),c.appendChild(e)})),n=h.is_published,(d=g.is_published)&&(d.checked=[1,!0,"1","true"].includes(n)),r=h,(i=g).item_title&&(o=r.title?helperModule.unescape(r.title):"",i.item_title.value=o),i.item_text&&(o=r.text?helperModule.unescape(r.text):"",i.item_text.value=o),-1!==window.location.pathname.indexOf("media")&&"function"==typeof helperMediaModule?.display_media_fields_common&&await helperMediaModule.display_media_fields_common(h),((t,r)=>{if(r&&0!==r.length&&t)for(let e=0;e<r.length;e++)if(r[e].value===t){r[e].checked=!0;break}})(h.layout,g.layouts),((e,t)=>{if(t&&0!==t.length){var r=parseInt(e,10);if(!isNaN(r))for(let e=0;e<t.length;e++)if(parseInt(t[e].value,10)===r){t[e].checked=!0;break}}})(h.media_width,g.media_width),e(h.styles,g),!1;throw new Error("Failed to load grid item record data")}catch(e){return console.error("Error in display_edit_record:",e),p="Unable to display the record. Please try again.",(_=document.querySelector("#message"))&&((l=document.createElement("div")).className="alert alert-danger",l.setAttribute("role","alert"),(s=document.createElement("i")).className="fa fa-exclamation",l.appendChild(s),s=document.createTextNode(" "+p),l.appendChild(s),_.textContent="",_.appendChild(l)),!1}}return e.update_grid_item_record=async function(){if(this._is_updating_grid_item)return!1;this._is_updating_grid_item=!0;let t=document.querySelector("#message");let e=300;var r=(e,t,r)=>{var i,a;e&&(t=["info","success","danger","warning"].includes(t)?t:"danger",(i=document.createElement("div")).className="alert alert-"+t,i.setAttribute("role","alert"),(a=document.createElement("i")).className=o(t),i.appendChild(a),t=document.createTextNode(" "+r),i.appendChild(t),e.style.opacity="1",e.style.transition="",e.textContent="",e.appendChild(i))};let o=e=>({info:"fa fa-info",success:"fa fa-check",danger:"fa fa-exclamation",warning:"fa fa-exclamation-triangle"})[e]||"fa fa-exclamation";var i,a,n;let d=()=>{"undefined"!=typeof rich_text_data&&rich_text_data?.setDirty&&rich_text_data.setDirty(!1);let e=document.querySelector('#item-submit-card button[type="submit"], button[type="submit"]');e&&(e.disabled=!0,setTimeout(()=>{e.disabled=!1},1e3)),window.onbeforeunload=null},l=null;try{window.scrollTo({top:0,behavior:"smooth"});var c=helperModule.get_parameter_by_name("exhibit_id"),u=helperModule.get_parameter_by_name("grid_id"),s=helperModule.get_parameter_by_name("item_id"),m=(a=u,n=s,(i=c)&&a&&n?255<i.length||255<a.length||255<n.length?{valid:!1,error:"Invalid parameter length"}:{valid:!0}:{valid:!1,error:"Missing required parameters: exhibit_id, grid_id, or item_id"});if(!m.valid)return r(t,"warning",m.error),!1;r(t,"info","Updating grid item record...");var _=authModule.get_user_token();if(!_||!1===_)return r(t,"danger","Session expired. Please log in again."),l=setTimeout(()=>{authModule.logout()},1e3),!1;var p=itemsCommonGridItemFormModule.get_common_grid_item_form_fields();if(!p||!1===p||void 0===p)return!1;var g=helperModule.get_user_name();if(g&&(p.updated_by=g),!b?.exhibits?.grid_item_records?.put?.endpoint)return r(t,"danger","API endpoint configuration missing"),!1;var h=b.exhibits.grid_item_records.put.endpoint.replace(":exhibit_id",encodeURIComponent(c)).replace(":grid_id",encodeURIComponent(u)).replace(":item_id",encodeURIComponent(s)),f=await httpModule.req({method:"PUT",url:h,data:p,headers:{"Content-Type":"application/json","x-access-token":_},timeout:3e4});if(f&&201===f.status)return r(t,"success","Grid item record updated successfully"),await(async()=>{try{await v(),d()}catch(e){console.error("Error refreshing display:",e)}})(),l=setTimeout(()=>{t&&(t.style.transition=`opacity ${e}ms ease-out`,t.style.opacity="0",setTimeout(()=>{t.textContent="",t.style.opacity="1",t.style.transition=""},e))},3e3),!0;throw new Error("Failed to update grid item record")}catch(e){l&&clearTimeout(l),console.error("Error updating grid item record:",e);var y=e.user_message||e.message||"Unable to update grid item record. Please try again.";return r(t,"danger",y),!1}finally{this._is_updating_grid_item=!1}},e.init=async function(){try{var e=helperModule.get_parameter_by_name("exhibit_id"),t=helperModule.get_parameter_by_name("item_id"),r="/items/grid/details?exhibit_id="+e+"&item_id="+t+"&status=403";await authModule.check_permissions(["update_item","update_any_item"],"grid_item",e,t,r),exhibitsModule.set_exhibit_title(e),navModule.back_to_grid_items(),await v(),document.querySelector("#save-item-btn").addEventListener("click",itemsEditGridItemFormModule.update_grid_item_record),-1!==window.location.pathname.indexOf("media")&&helperMediaModule.media_edit_init()}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e})();