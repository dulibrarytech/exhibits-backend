let authModule=(()=>{let n=window.localStorage.getItem("exhibits_app_path"),s=endpointsModule.init();var e={};function d(e){try{var r=document.querySelector("#message");r&&(r.innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e}</div>`)}catch(e){console.error("Error displaying message:",e.message)}}function a(){try{window.location.replace(n+"/session")}catch(e){console.error("Failed to redirect to session page:",e.message)}}function c(e){try{window.location.replace(""+n+e)}catch(e){console.error("Failed to redirect to path:",e.message)}}return e.get_user_token=function(){try{if(void 0===window.sessionStorage)console.warn("sessionStorage is not available");else{var r,t,o=window.sessionStorage.getItem("exhibits_token");if(null!==o){let e;try{e=JSON.parse(o)}catch(e){return console.error("Invalid JSON in sessionStorage:",e.message),window.sessionStorage.removeItem("exhibits_token"),null}if(e&&"object"==typeof e){if(null!=e.token)return"string"!=typeof e.token?(console.warn("Token is not a string"),null):0===(r=e.token.trim()).length?(console.warn("Token is empty"),null):(t=DOMPurify.sanitize(r,{ALLOWED_TAGS:[]}))!==r?(console.warn("Token contained potentially malicious content"),null):t;console.warn("Token is null or undefined in sessionStorage");try{window.location.replace(n+"/")}catch(e){console.error("Failed to redirect to login:",e.message)}}else console.warn("Invalid token data structure")}}return null}catch(e){return console.error("Error in get_user_token:",e.message),d("An error occurred: "+e.message),null}},e.get_auth_user_data=async function(){try{if(authModule&&helperModule&&httpModule){var e=helperModule.get_parameter_by_name("id");if(e){var r=Number(e);if(!Number.isInteger(r)||r<=0)console.warn("Invalid user ID format: "+e),d("Invalid user ID format.");else{authModule.save_token();var t=authModule.get_user_token();if(t){var o=s.authenticate+"?id="+encodeURIComponent(r),n=await httpModule.req({method:"GET",url:o,headers:{"Content-Type":"application/json","x-access-token":t},timeout:1e4});if(n&&"number"==typeof n.status){if(200===n.status){if(!n.data||"object"!=typeof n.data)return console.error("Invalid user data in response"),d("Invalid server response."),!1;try{authModule.save_user_auth_data(n.data)}catch(e){return console.error("Failed to save user auth data:",e.message),d("Failed to save authentication data."),!1}return!0}401===n.status||403===n.status?(console.warn("Authentication failed with status "+n.status),authModule.redirect_to_auth()):(console.error("Server returned status "+n.status),d(n.data?.message||"Authentication service error."))}else console.error("Invalid response structure from server"),d("Server communication error.")}else console.warn("Failed to retrieve authentication token"),authModule.redirect_to_auth()}}else console.warn("Missing required parameter: id")}else console.error("Required modules are not available"),d("System configuration error.");return!1}catch(e){return console.error("Error in get_auth_user_data:",e.message),e.message.includes("timeout")?d("Request timeout. Please try again."):e.message.includes("network")?d("Network error. Please check your connection."):d("An error occurred: "+e.message),!1}},e.get_user_profile_data=function(){try{if(void 0===window.sessionStorage)return console.warn("sessionStorage is not available"),authModule.redirect_to_auth(),null;var e,t,o=window.sessionStorage.getItem("exhibits_user");if(null===o||""===o)return console.warn("No user profile found in sessionStorage"),authModule.redirect_to_auth(),null;let r;try{r=JSON.parse(o)}catch(e){return console.error("Invalid JSON in sessionStorage:",e.message),window.sessionStorage.removeItem("exhibits_user"),authModule.redirect_to_auth(),null}return r&&"object"==typeof r?0<(e=["uid","name"].filter(e=>!r[e])).length?(console.warn("Missing required profile fields: "+e.join(", ")),window.sessionStorage.removeItem("exhibits_user"),authModule.redirect_to_auth(),null):"string"!=typeof r.uid||0===r.uid.length?(console.warn("Invalid uid field in profile"),window.sessionStorage.removeItem("exhibits_user"),authModule.redirect_to_auth(),null):(t=Number(r.uid),!Number.isInteger(t)||t<=0?(console.warn("Invalid id field in profile"),window.sessionStorage.removeItem("exhibits_user"),authModule.redirect_to_auth(),null):r):(console.warn("Invalid profile data structure"),window.sessionStorage.removeItem("exhibits_user"),authModule.redirect_to_auth(),null)}catch(e){return console.error("Error in get_user_profile_data:",e.message),d("An error occurred: "+e.message),authModule.redirect_to_auth(),null}},e.get_user_role=async function(e){try{if(null==e)console.warn("Missing required parameter: user_id");else{var r=Number(e);if(!Number.isInteger(r)||r<=0)console.warn("Invalid user_id format: "+e),d("Invalid user ID format.");else if(httpModule){var t=this.get_user_token();if(t){var o,n,s="/exhibits-dashboard/auth/role?user_id="+encodeURIComponent(r),a=await httpModule.req({method:"GET",url:s,headers:{"Content-Type":"application/json","x-access-token":t},timeout:1e4});if(a&&"number"==typeof a.status){if(200===a.status)return a.data&&Array.isArray(a.data)&&0!==a.data.length?(o=a.data[0]).role&&"string"==typeof o.role?0===(n=o.role.trim()).length?(console.warn("Role is empty string"),null):n:(console.error("Role field missing or invalid in response"),d("Invalid role data received."),null):(console.error("Invalid role data structure in response"),d("Invalid server response."),null);401===a.status||403===a.status?(console.warn("Authorization failed with status "+a.status),d("You do not have permission to access this resource.")):404===a.status?(console.warn("User not found: "+r),d("User not found.")):(console.error("Server returned status "+a.status),d(a.data?.message||"Failed to retrieve user role."))}else console.error("Invalid response structure from server"),d("Server communication error.")}else console.warn("No authentication token available"),d("Authentication required. Please log in.")}else console.error("httpModule is not available"),d("System configuration error.")}return null}catch(e){return console.error("Error in get_user_role:",e.message),e.message.includes("timeout")?d("Request timeout. Please try again."):e.message.includes("network")?d("Network error. Please check your connection."):e.message.includes("JSON")?d("Invalid server response format."):d("An error occurred: "+e.message),null}},e.check_user_auth_data=function(){try{if(void 0===window.sessionStorage)return console.warn("sessionStorage is not available"),!1;var e,t=window.sessionStorage.getItem("exhibits_user");if(!t||""===t)return!1;let r;try{r=JSON.parse(t)}catch(e){return console.warn("Invalid JSON in sessionStorage exhibits_user:",e.message),window.sessionStorage.removeItem("exhibits_user"),!1}return r&&"object"==typeof r?["uid","name"].every(e=>null!=r[e]&&""!==r[e])?"string"!=typeof r.uid||0===r.uid.length?(console.warn("Invalid uid field in auth data"),window.sessionStorage.removeItem("exhibits_user"),!1):(e=Number(r.uid),!(!Number.isInteger(e)||e<=0)||(console.warn("Invalid id field in auth data"),window.sessionStorage.removeItem("exhibits_user"),!1)):(console.warn("Missing required authentication fields"),window.sessionStorage.removeItem("exhibits_user"),!1):(console.warn("Invalid auth data structure"),window.sessionStorage.removeItem("exhibits_user"),!1)}catch(e){return console.error("Error in check_user_auth_data:",e.message),d("Unable to check user authentication data."),!1}},e.save_user_auth_data=function(r){try{if(!r||"object"!=typeof r)return console.warn("Invalid data parameter provided to save_user_auth_data"),d("Invalid authentication data format."),!1;if(!r.user_data||"object"!=typeof r.user_data)return console.warn("Missing or invalid user_data in authentication response"),d("Invalid user data structure."),!1;var t;for(t of["id","first_name","last_name"])if(null==r.user_data[t])return console.warn("Missing required field in user_data: "+t),d(`Missing required user information: ${t}.`),!1;if("string"!=typeof r.user_data.id&&"number"!=typeof r.user_data.id)return console.warn("Invalid id type in user_data"),d("Invalid user ID format."),!1;if("string"!=typeof r.user_data.first_name||"string"!=typeof r.user_data.last_name)return console.warn("Invalid name field types in user_data"),d("Invalid user name format."),!1;var o=DOMPurify.sanitize(String(r.user_data.id),{ALLOWED_TAGS:[]});if(!o||0===o.length)return console.warn("User ID sanitization resulted in empty value"),d("Invalid user ID."),!1;var n=DOMPurify.sanitize(r.user_data.first_name.trim(),{ALLOWED_TAGS:[]}),s=DOMPurify.sanitize(r.user_data.last_name.trim(),{ALLOWED_TAGS:[]});if(!n||!s)return console.warn("Name sanitization resulted in empty values"),d("Invalid user name."),!1;if(void 0===window.sessionStorage)return console.error("sessionStorage is not available"),d("Storage is not available. Please check your browser settings."),!1;var a={uid:o,name:n+" "+s};let e;try{e=JSON.stringify(a)}catch(e){return console.error("Failed to serialize user data:",e.message),d("Failed to save authentication data."),!1}try{window.sessionStorage.setItem("exhibits_user",e)}catch(e){return console.error("Failed to save to sessionStorage:",e.message),d("Failed to save authentication data. Storage may be full."),!1}try{r.endpoints?endpointsModule.save_exhibits_endpoints(r):console.warn("No endpoints data provided in authentication response")}catch(e){console.error("Failed to save endpoints data:",e.message),d("Warning: Failed to cache endpoints data.")}return!0}catch(e){return console.error("Error in save_user_auth_data:",e.message),d("An error occurred while saving authentication data: "+e.message),!1}},e.save_token=function(){try{if(!helperModule)return console.error("helperModule is not available"),d("System configuration error."),!1;var r=helperModule.get_parameter_by_name("t");if(!r||""===r)return console.debug("No token parameter provided"),!1;if("string"!=typeof r)return console.warn("Invalid token type provided"),d("Invalid token format."),!1;var t=r.trim();if(0===t.length)return console.warn("Token is empty after trimming"),!1;if(t.length<20||2048<t.length)return console.warn("Token length outside acceptable range: "+t.length),d("Invalid token format."),!1;var o=DOMPurify.sanitize(t,{ALLOWED_TAGS:[]});if(o!==t)return console.warn("Token contained potentially malicious content"),d("Invalid token format."),!1;if(void 0===window.sessionStorage)return console.error("sessionStorage is not available"),d("Storage is not available. Please check your browser settings."),!1;var n={token:o,saved_at:(new Date).toISOString()};let e;try{e=JSON.stringify(n)}catch(e){return console.error("Failed to serialize token data:",e.message),d("Failed to save authentication token."),!1}try{window.sessionStorage.setItem("exhibits_token",e)}catch(e){return console.error("Failed to save to sessionStorage:",e.message),d("Failed to save authentication token. Storage may be full."),!1}return!0}catch(e){return console.error("Error in save_token:",e.message),d("An error occurred while saving token: "+e.message),!1}},e.check_auth=async function(e){try{if(null==e||!1===e||""===e)console.warn("Invalid or missing token provided to check_auth"),d("Session expired. Redirecting to login..."),authModule.redirect_to_auth();else if("string"!=typeof e)console.warn("Token is not a string"),d("Invalid authentication token.");else{var r=e.trim();if(0===r.length)console.warn("Token is empty string"),d("Session expired. Redirecting to login..."),authModule.redirect_to_auth();else if(endpointsModule&&httpModule){var t=endpointsModule.get_exhibits_endpoints();if(t&&t.exhibits&&t.exhibits.token_verify&&t.exhibits.token_verify.endpoint){var o=t.exhibits.token_verify.endpoint,n=await httpModule.req({method:"POST",url:o,headers:{"Content-Type":"application/json","x-access-token":r},timeout:1e4});if(n&&"object"==typeof n){if(200===n.status)return!0;401===n.status||403===n.status?(console.warn("Token verification failed with status "+n.status),d("Session expired. Redirecting to login..."),authModule.redirect_to_auth()):void 0===n?(console.error("Undefined response from token verification"),a()):(console.error("Token verification returned status "+n.status),d(n.data?.message||"Authentication verification failed."))}else console.error("Invalid response structure from token verification"),a()}else console.error("Invalid endpoints configuration"),d("System configuration error.")}else console.error("Required modules not available"),d("System configuration error.")}return!1}catch(e){return console.error("Error in check_auth:",e.message),e.message.includes("timeout")?d("Request timeout. Please try again."):e.message.includes("network")?d("Network error. Please check your connection."):e.message.includes("401")||e.message.includes("unauthorized")?(d("Session expired. Redirecting to login..."),authModule.redirect_to_auth()):d("An error occurred: "+e.message),!1}},e.check_permissions=async function(r,t,o,n,s){try{if(authModule&&httpModule)if(r&&Array.isArray(r)&&0!==r.length)if(t&&"string"==typeof t){var e=e=>"string"==typeof e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e);if(null==o||e(o))if(null==n||e(n)){var a=authModule.get_user_token();if(a&&!1!==a&&""!==a)if("string"!=typeof a)console.warn("Token is not a string"),d("Invalid authentication token.");else{let e="/access-denied";if(null!=s){if("string"!=typeof s||!s.startsWith("/"))return console.warn("Invalid redirect path format: "+s),d("Invalid redirect configuration."),!1;e=s}var i,l={permissions:r,record_type:t,parent_id:o||null,child_id:n||null};try{i=JSON.stringify(l),console.log(i)}catch(e){return console.error("Failed to serialize permission request:",e.message),d("Failed to process permission request."),!1}var u=await httpModule.req({method:"POST",url:"/exhibits-dashboard/auth/permissions",headers:{"Content-Type":"application/json","x-access-token":a},data:l,timeout:1e4});if(u&&"object"==typeof u){if(200===u.status)return console.debug("User authorized for requested permissions"),!0;401===u.status||403===u.status?(console.warn("Permission denied with status "+u.status),d("You do not have permission to access this resource.")):404===u.status?(console.warn("Resource not found during permission check"),d("The requested resource was not found.")):(console.error("Permission check returned status "+u.status),d(u.data?.message||"Permission verification failed."))}else console.error("Invalid response structure from permission verification");c(e)}else console.warn("Invalid or missing authentication token"),d("Session expired. Redirecting to login..."),authModule.redirect_to_auth()}else console.warn("Invalid child_id format (not a valid UUID): "+n),d("Invalid child record ID format.");else console.warn("Invalid parent_id format (not a valid UUID): "+o),d("Invalid parent record ID format.")}else console.warn("Invalid or missing record_type parameter"),d("Invalid record type.");else console.warn("Invalid or missing permissions parameter"),d("Invalid permission request.");else console.error("Required modules not available"),d("System configuration error.");return!1}catch(e){return console.error("Error in check_permissions:",e.message),e.message.includes("timeout")?d("Request timeout. Please try again."):e.message.includes("network")?d("Network error. Please check your connection."):e.message.includes("401")||e.message.includes("unauthorized")?(d("Session expired. Redirecting to login..."),authModule.redirect_to_auth()):d("An error occurred: "+e.message),!1}},e.redirect_to_auth=function(){setTimeout(()=>{window.location.replace(n+"/auth")},4e3)},e.clear=function(){window.sessionStorage.clear(),window.localStorage.clear()},e.logout=function(){window.location.replace(n+"/logout")},e.init=function(){},e})();