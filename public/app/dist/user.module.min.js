let userModule=(()=>{let _=window.localStorage.getItem("exhibits_app_path"),y=endpointsModule.get_users_endpoints(),p="#message";var e={};async function m(){try{var e=authModule.get_user_token(),t=await httpModule.req({method:"GET",url:y.users.endpoint,headers:{"Content-Type":"application/json","x-access-token":e}});return void 0!==t&&200===t.status?t.data:void 0!==t&&void 0}catch(e){document.querySelector("#message").innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}}async function h(){try{var e,t,a=helperModule.get_parameter_by_name("user_id");return null===a?!1:(e=authModule.get_user_token(),200===(t=await httpModule.req({method:"GET",url:y.users.get_user.endpoint.replace(":user_id",a),headers:{"Content-Type":"application/json","x-access-token":e}})).status?t.data:void 0)}catch(e){document.querySelector(p).innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}}function l(){try{var t,a,r={first_name:"#first-name-input",last_name:"#last-name-input",email:"#email-input",du_id:"#du-id-input",role_id:"#user-roles"},s={};let e=!0;for([t,a]of Object.entries(r)){var i,l,n=document.querySelector(a);n?(i=n.value||"",(l=((e,t)=>(e=document.querySelector(`#${e}-error`),t&&0!==t.trim().length?(e&&(e.innerHTML=""),t.trim()):(e&&(e.innerHTML='<span style="color: red"><i class="fa fa-exclamation-circle"></i> Please enter a value</span>'),!1)))(a.replace("#",""),i))||0===l?s[t]=l:e=!1):(console.error("Element not found: "+a),e=!1)}return e?s:null}catch(e){return console.error("Error retrieving form data:",e),null}}async function g(e){var t=authModule.get_user_token();200===(await httpModule.req({method:"PUT",url:y.users.user_status.endpoint.replace(":id",e).replace(":is_active","1"),headers:{"Content-Type":"application/json","x-access-token":t}})).status&&(t=document.getElementById(e),document.getElementById(e).classList.remove("active-user"),document.getElementById(e).classList.add("inactive-user"),document.getElementById(e).replaceWith(t.cloneNode(!0)),document.getElementById(e).innerHTML='<span id="suppress" title="published"><i class="fa fa-user" style="color: green"></i><br>Active</span>',document.getElementById(e).addEventListener("click",async()=>{await b(e)},!1),document.getElementById(e+"-user-actions").innerHTML=`
                        <div class="card-text text-sm-center">
                        <i title="Only administrators can view user details" style="color: #d3d3d3" class="fa fa-edit pr-1"></i>&nbsp;
                        <i title="Only administrators can delete users" style="color: #d3d3d3" class="fa fa-trash pr-1" aria-label="delete-user"></i>
                        </div>`)}async function b(t){var e,a,r=authModule.get_user_token();200===(await httpModule.req({method:"PUT",url:y.users.user_status.endpoint.replace(":id",t).replace(":is_active","0"),headers:{"Content-Type":"application/json","x-access-token":r}})).status&&(r=document.getElementById(t),document.getElementById(t).classList.remove("inactive-user"),document.getElementById(t).classList.add("active-user"),document.getElementById(t).replaceWith(r.cloneNode(!0)),document.getElementById(t).innerHTML='<span id="publish" title="suppressed"><i class="fa fa-user" style="color: darkred"></i><br>Inactive</span>',document.getElementById(t).addEventListener("click",async e=>{await g(t)},!1),r=document.getElementById(t+"-user-actions"),e=`<a href="${_}/users/edit?user_id=${t}" title="View user details" aria-label="user-details"><i class="fa fa-edit pr-1"></i></a>`,a=`<a href="${_}/users/delete?user_id=${t}" title="Delete User" aria-label="delete-user"><i class="fa fa-trash pr-1"></i></a>`,r.innerHTML=`
                        <div class="card-text text-sm-center">
                        ${e}&nbsp;
                        ${a}
                        </div>`)}return e.display_user_records=async function(){let l={message_selector:"#message",user_data_selector:"#user-data",add_user_selector:"#add-user",card_selector:".card",user_table_selector:"#users",app_path:_},n={active:{value:1,icon:"fa-user",color:"green",label:"Active",title:"active",class_name:"inactive-user"},inactive:{value:0,icon:"fa-user",color:"darkred",label:"Inactive",title:"inactive",class_name:"active-user"}},r=new Map;function s(e){return r.has(e)||r.set(e,document.querySelector(e)),r.get(e)}function i(e,t="danger"){var a=s(l.message_selector);a&&(a.innerHTML=`
            <div class="alert alert-${t}" role="alert">
                <i class="fa fa-${"danger"===t?"exclamation":"info"}"></i> ${e}
            </div>
        `)}function o(e,t,a){var r,s,i,t=t&&parseInt(t.uid)===e.id,t=(s=e,t=t,r=a,i=n[1===s.is_active?"active":"inactive"],t?`
                <span id="${i.title}" title="${i.title}">
                    <i class="fa ${i.icon}" style="color: ${i.color}"></i>
                    <br>${i.label}
                </span>
            `:r&&1===s.is_active?`
                <a href="#" id="${s.id}" class="inactive-user" role="button" aria-label="Deactivate user">
                    <span id="${i.title}" title="${i.title}">
                        <i class="fa ${i.icon}" style="color: ${i.color}"></i>
                        <br>${i.label}
                    </span>
                </a>
            `:r&&0===s.is_active?`
                <a href="#" id="${s.id}" class="active-user" role="button" aria-label="Activate user">
                    <span id="${i.title}" title="${i.title}">
                        <i class="fa ${i.icon}" style="color: ${i.color}"></i>
                        <br>${i.label}
                    </span>
                </a>
            `:`
            <span id="${i.title}" title="${i.title}">
                <i class="fa ${i.icon}" style="color: ${i.color}"></i>
                <br>${i.label}
            </span>
        `),a=(r=e,i=(s=a)&&0===r.is_active,s=a&&0===r.is_active,(i?`<a href="${l.app_path}/users/edit?user_id=${r.id}" title="Edit" aria-label="edit-user"><i class="fa fa-edit pr-1"></i></a>`:'<i title="Can only edit if inactive" style="color: #d3d3d3" class="fa fa-edit pr-1" aria-disabled="true"></i>')+"&nbsp;"+(s?`<a href="${l.app_path}/users/delete?user_id=${r.id}" title="Delete" aria-label="delete-user"><i class="fa fa-trash pr-1"></i></a>`:'<i title="Can only delete if inactive" style="color: #d3d3d3" class="fa fa-trash pr-1" aria-disabled="true"></i>'));return`
            <tr style="height: 10%">
                <td style="width: 35%; padding-left: 7%">
                    <small>${e.first_name} ${e.last_name}</small>
                </td>
                <td style="width: 15%; text-align: center">
                    <small>${e.role}</small>
                </td>
                <td style="width: 5%; text-align: center">
                    <small>${t}</small>
                </td>
                <td id="${e.id}-user-actions" style="width: 10%">
                    <div class="card-text text-sm-center">${a}</div>
                </td>
            </tr>
        `}try{r.clear();var e=await m();if(!e||!1===e)return void await(s(l.add_user_selector).style.display="none",i("You do not have permission to view users.","danger"),!1);if(!Array.isArray(e)||0===e.length)return void await(s(l.card_selector).innerHTML="",i("No User Profiles found.","info"),!1);let t=(()=>{try{var e=sessionStorage.getItem("exhibits_user");return e?JSON.parse(e):(i("Unable to get your user id","danger"),null)}catch(e){return console.error("Failed to parse user data:",e),i("Unable to parse user data","danger"),null}})();if(!t)return void await!1;f=t,v=e;let a=f&&v.some(e=>parseInt(f.uid)===e.id&&"Administrator"===e.role);var d=e.map(e=>o(e,t,a)).join(""),c=s(l.user_data_selector);return void await(c&&(c.innerHTML=d),(u=s(l.user_table_selector))?"undefined"==typeof DataTable?console.warn("DataTable library not loaded"):((u=new DataTable(u,{paging:!0,order:[[0,"asc"]]})).on("click","tbody tr .inactive-user",async e=>{e.preventDefault();e=e.currentTarget.getAttribute("id");e&&await b(e)}),u.on("click","tbody tr .active-user",async e=>{e.preventDefault();e=e.currentTarget.getAttribute("id");e&&await g(e)})):console.warn("User table element not found"),"undefined"!=typeof helperModule&&helperModule.show_form&&helperModule.show_form(),!0)}catch(e){return void await(console.error("Error displaying user records:",e),i(e.message||"An error occurred while loading users","danger"),!1)}var u,f,v},e.display_user_records__=async function(){try{var l=await m();if(!1===l)return document.querySelector("#add-user").style.display="none",!(document.querySelector(p).innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> You do not have permission to view users.</div>');let i="";if(!1===l)document.querySelector("#user-card").innerHTML="";else{if(0===l.length)return document.querySelector(".card").innerHTML="",!(document.querySelector(p).innerHTML='<div class="alert alert-info" role="alert"><span id="exhibit-title"></span> No User Profiles found.</div>');let s=!1;for(let r=0;r<l.length;r++){var n=l[r].is_active;let e,t="",a="";var o=JSON.parse(window.sessionStorage.getItem("exhibits_user"));if(null===o)return!(document.querySelector(p).innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> Unable to get your user id</div>');parseInt(o.uid)===l[r].id&&"Administrator"===l[r].role&&(s=!0),1===n?a=(t=parseInt(o.uid)===l[r].id?(e='<span id="inactive" title="active"><i class="fa fa-user" style="color: green"></i><br>Active</span>',`<a href="${_}/users/edit?user_id=${l[r].id}" title="Edit"><i class="fa fa-edit pr-1"></i> </a>`):(e=!0===s?`<a href="#" id="${l[r].id}" class="inactive-user"><span id="inactive" title="active"><i class="fa fa-user" style="color: green"></i><br>Active</span></a>`:'<span id="inactive" title="active"><i class="fa fa-user" style="color: green"></i><br>Active</span>','<i title="Can only edit if inactive" style="color: #d3d3d3" class="fa fa-edit pr-1"></i>'),'<i title="Can only delete if inactive" style="color: #d3d3d3" class="fa fa-trash pr-1"></i>'):0===n&&(a=!0===s?(e=`<a href="#" id="${l[r].id}" class="active-user"><span id="active" title="inactive"><i class="fa fa-user" style="color: darkred"></i><br>Inactive</span></a>`,t=`<a href="${_}/users/edit?user_id=${l[r].id}" title="Edit"><i class="fa fa-edit pr-1"></i> </a>`,`<a href="${_}/users/delete?user_id=${l[r].id}" title="Delete"><i class="fa fa-trash pr-1"></i></a>`):(e='<span id="active" title="inactive"><i class="fa fa-user" style="color: darkred"></i><br>Inactive</span>',t='<i title="Can only edit if inactive" style="color: #d3d3d3" class="fa fa-edit pr-1"></i>','<i title="Can only delete if inactive" style="color: #d3d3d3" class="fa fa-trash pr-1"></i>')),i=(i=(i=(i=(i+='<tr style="height: 10%">')+`<td style="width: 35%;padding-left: 7%">
                    <small>${l[r].first_name} ${l[r].last_name}</small>
                    </td>`)+`<td style="width: 15%;text-align: center"><small>${l[r].role}</small></td>`)+`<td style="width: 5%;text-align: center"><small>${e}</small></td>`)+`<td id="${l[r].id}-user-actions" style="width: 10%">
                                <div class="card-text text-sm-center">
                                    ${t}
                                    &nbsp;
                                    ${a}
                                </div>
                               </td>`+"</tr>"}document.querySelector("#user-data").innerHTML=i;var e=new DataTable("#users",{paging:!0,order:[[0,"asc"]]});e.on("click","tbody tr .inactive-user",async e=>{e.preventDefault(),await b(e.currentTarget.getAttribute("id"))}),e.on("click","tbody tr .active-user",async e=>{e.preventDefault(),await g(e.currentTarget.getAttribute("id"))}),helperModule.show_form()}return!1}catch(e){document.querySelector(p).innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e.display_user_record=async function(){let s={message_selector:"#message",selectors:{edit_form:"#user-form",view_only_form:"#user-form-view-only",save_btn:"#save-user-btn",first_name:"#first-name-input",last_name:"#last-name-input",email:"#email-input",du_id:"#du-id-input",user_roles:"#user-roles",first_name_disabled:"#first-name-disabled",last_name_disabled:"#last-name-disabled",email_disabled:"#email-disabled",du_id_disabled:"#du-id-disabled",role_disabled:"#role-disabled"}},a=new Map;function r(e){var t;return a.has(e)||((t=document.querySelector(e))||console.warn("Element not found: "+e),a.set(e,t)),a.get(e)}function i(e,t){e=r(e);e&&(e.value=t||"")}function l(e,t=!0){e=r(e);e&&(t?e.setAttribute("disabled",""):e.removeAttribute("disabled"))}function n(e,t=!0){e=r(e);e&&(e.style.display=t?"block":"none")}function t(e){var t=r(s.message_selector);t&&(t.innerHTML=`
                <div class="alert alert-danger" role="alert">
                    <i class="fa fa-exclamation"></i> ${e}
                </div>
            `)}function e(e,t,a){var r;"view_only"===e.form_type?(r=t,a=a,i(s.selectors.first_name_disabled,r.first_name),i(s.selectors.last_name_disabled,r.last_name),i(s.selectors.email_disabled,r.email),i(s.selectors.du_id_disabled,r.du_id),i(s.selectors.role_disabled,a.role),n(s.selectors.edit_form,!1),n(s.selectors.view_only_form,!0),n(s.selectors.save_btn,!1)):(r=t,i(s.selectors.first_name,r.first_name),i(s.selectors.last_name,r.last_name),i(s.selectors.email,r.email),i(s.selectors.du_id,r.du_id),n(s.selectors.edit_form,!0),n(s.selectors.view_only_form,!1),n(s.selectors.save_btn,!0),e.can_disable_fields?(l(s.selectors.du_id,!0),l(s.selectors.user_roles,!0)):(l(s.selectors.du_id,!1),l(s.selectors.user_roles,!1)))}try{a.clear();var o,d,c,u=authModule.get_user_profile_data();return void await(u&&u.uid?(o=await h())&&Array.isArray(o)&&0!==o.length?(d=o[o.length-1])?(c=await(async e=>{try{var t=authModule.get_user_token(),a=await httpModule.req({method:"GET",url:"/exhibits-dashboard/auth/role?user_id="+e,headers:{"Content-Type":"application/json","x-access-token":t}});if(200===a.status)return a.data[0]}catch(e){document.querySelector(p).innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}})(d.id))?(void 0!==userModule&&userModule.list_roles&&await userModule.list_roles(c),f=u,v=d,m="Administrator"===(m=c).role,f=parseInt(f.uid)===parseInt(v.id),e(m&&f||m&&!f?{can_edit:!0,can_disable_fields:!1,form_type:"editable"}:!m&&f?{can_edit:!0,can_disable_fields:!0,form_type:"editable"}:{can_edit:!1,can_disable_fields:!1,form_type:"view_only"},d,c),!0):(t("Unable to retrieve user role"),!1):(t("User record is empty"),!1):(t("Unable to retrieve user record"),setTimeout(()=>{window.location.replace(_+"/users")},1e3),!1):(t("Unable to retrieve profile data"),!1))}catch(e){return void await(console.error("Error displaying user record:",e),t(e.message||"An error occurred while loading the user record"),!1)}var f,v,m},e.display_user=async function(e){return h()},e.update_user_record=async function(e){try{window.scrollTo(0,0),e.preventDefault();var t,a,r=helperModule.get_parameter_by_name("user_id"),s=l(),i=authModule.get_user_token();if(void 0===r)return!(document.querySelector(p).innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> Unable to get user ID</div>');if(!1===i)setTimeout(()=>{document.querySelector(p).innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> Unable to get session token</div>',authModule.logout()},1e3);else{if(void 0===s)return!(document.querySelector(p).innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> Unable to get form field values</div>');null!==s&&(document.querySelector(p).innerHTML='<div class="alert alert-info" role="alert"><i class="fa fa-info"></i> Updating user record...</div>',t=y.users.update_user.put.endpoint.replace(":user_id",r),void 0!==(a=await httpModule.req({method:"PUT",url:t,data:s,headers:{"Content-Type":"application/json","x-access-token":i}})))&&201===a.status&&(document.querySelector(p).innerHTML='<div class="alert alert-success" role="alert"><i class="fa fa-info"></i> User record updated</div>',setTimeout(()=>{window.location.reload()},900))}return!1}catch(e){document.querySelector(p).innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e.save_user_record=async function(e){try{window.scrollTo(0,0),e.preventDefault();var t=l(),a=authModule.get_user_token();if(!1===a)setTimeout(()=>{document.querySelector(p).innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> Unable to get session token</div>',authModule.logout()},1e3);else{if(void 0===t)return!(document.querySelector(p).innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> Unable to get form field values</div>');if(null!==t){document.querySelector(p).innerHTML='<div class="alert alert-info" role="alert"><i class="fa fa-info"></i> Saving user record...</div>';var r=y.users.endpoint,s=await httpModule.req({method:"POST",url:r,data:t,headers:{"Content-Type":"application/json","x-access-token":a}});if(void 0!==s&&201===s.status){let e=s.data[0];document.querySelector(p).innerHTML='<div class="alert alert-success" role="alert"><i class="fa fa-info"></i> User record saved</div>',setTimeout(()=>{window.location.replace(_+"/users/edit?user_id="+e)},900)}else 200===s.status&&(document.querySelector(p).innerHTML='<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> User already exists</div>')}}return!1}catch(e){document.querySelector(p).innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e.delete_user=async function(){try{document.querySelector("#delete-message").innerHTML="Deleting user...";var e=helperModule.get_parameter_by_name("user_id"),t=authModule.get_user_token(),a=await httpModule.req({method:"DELETE",url:y.users.delete_user.delete.endpoint.replace(":user_id",e),headers:{"Content-Type":"application/json","x-access-token":t}});void 0!==a&&204===a.status?setTimeout(()=>{window.location.replace(_+"/users")},900):document.querySelector("#exhibit-no-delete").innerHTML='<i class="fa fa-exclamation"></i> '+a.data.message}catch(e){document.querySelector(p).innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e.user_status_manager=async function(e,t){let c={active:{is_active:1,remove_class:"active-user",add_class:"inactive-user",icon:"fa-user",color:"green",label:"Active",title:"active",span_id:"suppress",next_action:"deactivate",show_edit_delete:!1},inactive:{is_active:0,remove_class:"inactive-user",add_class:"active-user",icon:"fa-user",color:"darkred",label:"Inactive",title:"inactive",span_id:"publish",next_action:"activate",show_edit_delete:!0}},u=new Map;function f(e){var t;return u.has(e)||((t=document.getElementById(e))||console.warn(`Element with id "${e}" not found in DOM`),u.set(e,t)),u.get(e)}function v(e,t){var a=f(e+"-user-actions");a&&(e=e,t=t?`<a href="${_}/users/edit?user_id=${e}" title="View user details" aria-label="user-details"><i class="fa fa-edit pr-1"></i></a>`+"&nbsp;"+`<a href="${_}/users/delete?user_id=${e}" title="Delete User" aria-label="delete-user"><i class="fa fa-trash pr-1"></i></a>`:'<i title="Only administrators can view user details" style="color: #d3d3d3" class="fa fa-edit pr-1"></i>&nbsp;<i title="Only administrators can delete users" style="color: #d3d3d3" class="fa fa-trash pr-1" aria-label="delete-user"></i>',a.innerHTML=`<div class="card-text text-sm-center">${t}</div>`)}async function a(t,a){try{var e,r=c[a];if(r)return await(async(t,e)=>{try{var a,r=authModule.get_user_token();if(r)return a=y.users.user_status.endpoint.replace(":id",t).replace(":is_active",e),200===(await httpModule.req({method:"PUT",url:a,headers:{"Content-Type":"application/json","x-access-token":r}}))?.status;throw new Error("Authentication token not available")}catch(e){return console.error(`Failed to update user ${t} status:`,e),!1}})(t,r.is_active)?((e=f(t))&&(e.classList.remove(r.remove_class),e.classList.add(r.add_class),d=r,(o=e)&&(o.innerHTML=`
            <span id="${d.span_id}" title="${d.title}">
                <i class="fa ${d.icon}" style="color: ${d.color}"></i>
                <br>${d.label}
            </span>
        `),s=e,i=t,l=r.next_action,s)&&(n=s.cloneNode(!1),s.parentNode&&s.parentNode.replaceChild(n,s),n.addEventListener("click",async e=>{e.preventDefault(),"deactivate"===l?await p(i):"activate"===l&&await m(i)}),u.set(i,n)),v(t,r.show_edit_delete),!0):(console.error(`Failed to ${a} user `+t),!1);throw new Error("Invalid status: "+a)}catch(e){return console.error(`Error updating user ${t} to ${a}:`,e),!1}var s,i,l,n,o,d}async function m(e){return a(e,"active")}async function p(e){return a(e,"inactive")}"activate"===e?await m(t):"deactivate"===e&&await p(t)},e.check_user_data=function(){return null!==window.sessionStorage.getItem("exhibits_user")},e.list_roles=async function(a){try{var r=await(async()=>{try{var e=authModule.get_user_token(),t=await httpModule.req({method:"GET",url:"/exhibits-dashboard/auth/roles",headers:{"Content-Type":"application/json","x-access-token":e}});if(200===t.status)return t.data}catch(e){document.querySelector(p).innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}})();let t="";t=t+'<option value="">Select From Menu</option>'+'<option value="">----------</option>';for(let e=0;e<r.length;e++)void 0!==a&&a.role_id===r[e].id?t+=`<option value="${r[e].id}" selected>${r[e].role}</option>`:t+=`<option value="${r[e].id}">${r[e].role}</option>`;document.querySelector("#user-roles").innerHTML=t}catch(e){document.querySelector(p).innerHTML=`<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation"></i> ${e.message}</div>`}},e.init=async function(){await userModule.list_roles()},e})();